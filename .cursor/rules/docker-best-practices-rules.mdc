---
alwaysApply: true
---

# Docker Best Practices Rules

## Dockerfile User Management

### Rule 1: File Operations Before USER Switch
**CRITICAL**: All file operations (COPY, chmod, chown, mkdir) that require root privileges MUST be performed BEFORE switching to a non-root user with `USER` directive.

**❌ WRONG**:
```dockerfile
USER grafana
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh  # FAILS: no permission
```

**✅ CORRECT**:
```dockerfile
USER root
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
USER grafana
```

### Rule 2: chown with UID/GID, Not Username
**CRITICAL**: When using `chown` in Dockerfile, use numeric UID/GID instead of username if the user doesn't exist yet in the base image. Username may not exist during build time.

**❌ WRONG**:
```dockerfile
RUN chown grafana:grafana /entrypoint.sh  # FAILS: user doesn't exist yet
```

**✅ CORRECT**:
```dockerfile
RUN chown 472:472 /entrypoint.sh  # Use UID/GID (grafana user UID is 472)
```

**Alternative**: If you must use username, ensure user exists first:
```dockerfile
RUN useradd -r -u 472 grafana || true
RUN chown grafana:grafana /entrypoint.sh
```

### Rule 3: Directory Permissions for Volume-Mounted Files
**CRITICAL**: When entrypoint scripts need to modify files in directories that are volume-mounted or provisioned, ensure the directory has write permissions OR process files as root in entrypoint.

**❌ WRONG**:
```dockerfile
USER grafana
# Entrypoint tries to write to /etc/grafana/provisioning/datasources/datasources.yml
# FAILS: read-only volume mount or insufficient permissions
```

**✅ CORRECT - Option 1**: Set permissions during build:
```dockerfile
USER root
RUN chmod -R 777 /etc/grafana/provisioning || true
# OR
RUN chown -R 472:472 /etc/grafana/provisioning
USER grafana
```

**✅ CORRECT - Option 2**: Process files as root in entrypoint:
```dockerfile
# Keep as root in Dockerfile
# USER grafana  # Commented out

# In entrypoint.sh, process files as root, then switch:
#!/bin/sh
# Process files as root
envsubst < /etc/grafana/provisioning/datasources/datasources.yml > /tmp/datasources.yml
mv /tmp/datasources.yml /etc/grafana/provisioning/datasources/datasources.yml
chown 472:472 /etc/grafana/provisioning/datasources/datasources.yml

# Then execute original entrypoint which switches to grafana user
exec /run.sh "$@"
```

## Entrypoint Scripts

### Rule 4: File Processing Order in Entrypoints
**CRITICAL**: If entrypoint needs to modify files, do it BEFORE switching to non-root user. If running as root, process files first, then switch user.

**❌ WRONG**:
```sh
#!/bin/sh
exec /run.sh "$@"  # Switches to grafana user
# Then try to modify files - FAILS
```

**✅ CORRECT**:
```sh
#!/bin/sh
# Process files while still root
if [ -f /etc/grafana/provisioning/datasources/datasources.yml ]; then
    envsubst < /etc/grafana/provisioning/datasources/datasources.yml > /tmp/datasources.yml
    mv /tmp/datasources.yml /etc/grafana/provisioning/datasources/datasources.yml
    chown 472:472 /etc/grafana/provisioning/datasources/datasources.yml
fi
# Then execute original entrypoint (which may switch user)
exec /run.sh "$@"
```

### Rule 5: Error Handling in Entrypoints
**CRITICAL**: Use `|| true` or `2>/dev/null || true` for non-critical operations that may fail due to permissions or missing files.

**✅ CORRECT**:
```sh
chown 472:472 /file 2>/dev/null || true
# OR
chmod +x /file || true
```

## Plugin and Package Names

### Rule 6: Verify Plugin/Package Names
**CRITICAL**: Always verify correct plugin/package names from official documentation before using in Dockerfile or docker-compose.yml. Plugin names in Grafana often use format `author-plugin-name`, not `grafana-plugin-name`.

**❌ WRONG**:
```yaml
environment:
  - GF_INSTALL_PLUGINS=grafana-infinity-datasource  # WRONG name
```

**✅ CORRECT**:
```yaml
environment:
  - GF_INSTALL_PLUGINS=yesoreyeram-infinity-datasource  # Correct name
```

**Action Required**: Before using any plugin/package name:
1. Check official documentation
2. Search for plugin in official registry/marketplace
3. Verify exact name format (author-plugin-name vs plugin-name)

## Volume Mounts and File Permissions

### Rule 7: Volume-Mounted Files Are Read-Only by Default
**CRITICAL**: Files mounted via volumes in docker-compose.yml are typically read-only from container perspective. If entrypoint needs to modify them, either:
- Process them before mounting (on host)
- Mount directory (not file) and ensure container has write permissions
- Process files as root in entrypoint before switching user

**❌ WRONG**:
```yaml
volumes:
  - ./grafana/provisioning/datasources/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
# Entrypoint tries to modify - FAILS if file is read-only
```

**✅ CORRECT - Option 1**: Mount directory, not file:
```yaml
volumes:
  - ./grafana/provisioning:/etc/grafana/provisioning
# Container can write to files in directory
```

**✅ CORRECT - Option 2**: Process on host before mount:
```bash
# On host, before docker compose up
envsubst < grafana/provisioning/datasources/datasources.yml.template > grafana/provisioning/datasources/datasources.yml
```

## Build Order and Dependencies

### Rule 8: Install Dependencies Before Copying Files
**CRITICAL**: Install system dependencies (apt-get, apk, yum) BEFORE copying application files to maximize Docker layer caching.

**✅ CORRECT**:
```dockerfile
# Install dependencies first (changes less frequently)
RUN apk add --no-cache gettext curl

# Copy files last (changes more frequently)
COPY entrypoint.sh /entrypoint.sh
COPY src/ ./src/
```

## Testing Docker Images

### Rule 9: Test Container Startup After Changes
**CRITICAL**: After modifying Dockerfile or entrypoint scripts, ALWAYS test container startup:
1. Build image: `docker compose build <service>`
2. Start container: `docker compose up -d <service>`
3. Check logs: `docker compose logs <service>`
4. Verify health: `docker compose ps <service>`
5. Test functionality: `curl http://localhost:<port>/health`

**Never assume** that a Dockerfile change will work without testing container startup.

## Common Patterns

### Pattern 1: Custom Entrypoint with Environment Variable Substitution
```dockerfile
FROM base-image:version

USER root
RUN apk add --no-cache gettext  # Install envsubst

# Set permissions for directory that entrypoint will modify
RUN chmod -R 777 /path/to/config || true
# OR
RUN chown -R 472:472 /path/to/config

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Keep as root if entrypoint needs root privileges
# USER nonroot  # Comment out if entrypoint needs root

ENTRYPOINT ["/entrypoint.sh"]
```

```sh
#!/bin/sh
# entrypoint.sh
set -e

# Export variables for envsubst
export VAR1="${VAR1:-default}"
export VAR2="${VAR2}"

# Process config files as root
if [ -f /path/to/config.yml ]; then
    envsubst < /path/to/config.yml > /tmp/config.yml
    mv /tmp/config.yml /path/to/config.yml
    chown 472:472 /path/to/config.yml 2>/dev/null || true
fi

# Execute original entrypoint (may switch user)
exec /original-entrypoint.sh "$@"
```

### Pattern 2: Multi-Stage with User Management
```dockerfile
FROM base-image:version AS builder

USER root
# Build steps here
RUN make build

FROM base-image:version AS runtime

USER root
# Copy from builder
COPY --from=builder /app/bin /app/bin

# Set permissions BEFORE switching user
RUN chown -R 1000:1000 /app
RUN chmod +x /app/bin/app

USER 1000
CMD ["/app/bin/app"]
```

## Summary Checklist

Before committing Dockerfile or entrypoint changes:

- [ ] All file operations (COPY, chmod, chown) are BEFORE USER switch
- [ ] chown uses UID/GID if user doesn't exist in base image
- [ ] Directories that entrypoint modifies have correct permissions
- [ ] Entrypoint processes files BEFORE switching to non-root user
- [ ] Plugin/package names are verified from official documentation
- [ ] Volume mounts allow write access if entrypoint needs to modify files
- [ ] Dependencies installed before copying application files
- [ ] Container startup tested after changes
- [ ] Error handling added for non-critical operations (`|| true`)

