---
alwaysApply: true
---

# Grafana Dashboard Configuration Rules

## Infinity Datasource Configuration

When configuring Infinity datasource queries in Grafana dashboards, always include required fields: `"source": "url"` must be present for all URL-based queries, and `"url_options": {"method": "GET"}` is mandatory when using backend parser to avoid "Cannot read properties of undefined (reading 'method')" errors. Use empty string `""` for `root_selector` with both JSON arrays and single objects - Infinity automatically handles array wrapping, and column selectors should use direct field names (e.g., `"name"`, `"status"`) without JSONPath prefixes like `$` or `$.field` for simple fields. For backend parser to support advanced Grafana features (alerting, shared dashboards, query caching), explicitly set `"parser": "backend"` instead of default `"json"` parser.

## Data Source Selection and Panel Configuration

Explicitly set datasource at panel level using `"datasource": {"type": "...", "uid": "..."}` to prevent Grafana UI from displaying incorrect default datasource (e.g., PostgreSQL) when panel has multiple queries with different datasources. For Infinity datasource queries, always specify datasource both at panel level and within each query target, and verify datasource UIDs match provisioning configuration in `grafana/provisioning/datasources/datasources.yml`.

## Data Source Migration from Direct Database Queries

When migrating panels from direct PostgreSQL queries to microservice APIs (e.g., position-manager), replace all direct queries to managed tables (like `positions`) with HTTP API calls via Infinity datasource to maintain architectural separation where services own their data. For combined metrics (e.g., Total PnL = Realized + Unrealized), use multiple queries (PostgreSQL for historical data like `execution_events`, Infinity for current state from API) and configure panel to sum values using `"reduceOptions": {"calcs": ["sum"]}`. Verify API response field names match selectors (e.g., `total_unrealized_pnl_usdt` not `unrealized_pnl`) and use correct format (`"table"` or `"time_series"`) based on panel type.
