# Анализ проблемы: очередь ws-gateway.balance

## Проблема
Очередь `ws-gateway.balance` содержит 145 сообщений и имеет **0 потребителей (consumers)**. Сообщения накапливаются, но никто их не обрабатывает.

## Текущее состояние

### Статус очередей RabbitMQ:
```
ws-gateway.balance     145 сообщений    0 consumers
ws-gateway.kline       0 сообщений     1 consumer
ws-gateway.order       0 сообщений     1 consumer
ws-gateway.orderbook   0 сообщений     1 consumer
ws-gateway.position    0 сообщений     1 consumer
ws-gateway.ticker      0 сообщений     1 consumer
ws-gateway.trade       0 сообщений     0 consumers
ws-gateway.liquidation 0 сообщений     0 consumers
```

## Архитектура обработки балансов

### Текущая реализация:

1. **ws-gateway**:
   - Получает события баланса от Bybit через WebSocket
   - Сохраняет балансы **напрямую в БД** (таблица `account_balances`) - User Story 5
   - Публикует события в очередь `ws-gateway.balance` - User Story 4

2. **Другие сервисы**:
   - `model-service`: Читает балансы из БД через `AccountBalanceRepository`
   - `order-manager`: Использует балансы из БД напрямую через SQL-запросы
   - Нет consumer'ов для очереди `ws-gateway.balance`

### Проблема:
События баланса публикуются в очередь, но **никто их не потребляет**. Все сервисы читают балансы напрямую из БД.

## Почему очередь не используется?

### Вариант 1: Очередь не нужна (вероятно)
Балансы сохраняются напрямую в БД, и все сервисы читают их оттуда. Очередь может быть избыточной для синхронного обновления балансов.

### Вариант 2: Нужен consumer (возможно)
Очередь может быть предназначена для:
- Асинхронного уведомления сервисов об изменениях баланса
- Инвалидации кэша балансов
- Триггеров для других процессов

## Решения

### Решение 1: Удалить публикацию в очередь (Рекомендуется)
Если очередь не используется, можно убрать публикацию событий баланса в очередь:

**Преимущества:**
- Устраняет накопление сообщений
- Упрощает архитектуру
- Балансы уже сохраняются в БД

**Недостатки:**
- Потеря возможности асинхронных уведомлений (если они нужны)

### Решение 2: Создать consumer для очереди
Создать consumer в одном из сервисов (например, `model-service` или `order-manager`):

**Варианты использования:**
- Инвалидация кэша балансов
- Асинхронные уведомления об изменениях
- Логирование/мониторинг изменений баланса

**Недостатки:**
- Требует разработки и поддержки consumer'а
- Дублирует данные (БД + очередь)

### Решение 3: Очистить очередь и настроить retention
Настроить автоматическую очистку старых сообщений в очереди (retention):

**Преимущества:**
- Не требует изменений в коде
- Предотвращает бесконечный рост очереди

**Недостатки:**
- Не решает основную проблему (неиспользуемые сообщения)

## Рекомендация

### Краткосрочное решение:
Очистить текущую очередь от накопившихся сообщений:
```bash
docker compose exec rabbitmq rabbitmqctl purge_queue ws-gateway.balance
```

### Долгосрочное решение:
1. Проанализировать, нужна ли очередь для балансов
2. Если не нужна - убрать публикацию в очередь
3. Если нужна - создать consumer и документировать его назначение

## Вопросы для уточнения

1. Нужна ли очередь для асинхронной обработки балансов?
2. Используют ли другие сервисы события баланса из очереди?
3. Есть ли требования к реальному времени для обновлений баланса?

