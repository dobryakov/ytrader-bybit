# Рекомендации по настройке Threshold и Horizon

## Текущая ситуация

**Настройки:**
- `MODEL_CLASSIFICATION_THRESHOLD`: 0.01 (1.0%)
- `MODEL_PREDICTION_HORIZON_SECONDS`: 900 (15 минут)

**Распределение классов:**
- Класс 0 (flat): **91-94%** ← ДОМИНИРУЮЩИЙ
- Класс -1 (down): 3-4%
- Класс 1 (up): 3-4%
- Соотношение дисбаланса: **22x**

**Проблема:** Движения >1% за 15 минут очень редки для BTCUSDT, что приводит к критическому дисбалансу классов.

---

## Рекомендации

### 1. Уменьшить Threshold (рекомендуется)

**Цель:** Увеличить количество примеров классов -1 и 1

#### Варианты:

**a) Threshold = 0.005 (0.5%)**
- Ожидаемое распределение: ~85-88% flat, ~6-7% down, ~6-7% up
- Более сбалансированное, но все еще дисбаланс
- Подходит для консервативного подхода

**b) Threshold = 0.003 (0.3%)** ⭐ **РЕКОМЕНДУЕТСЯ**
- Ожидаемое распределение: ~75-80% flat, ~10-12% down, ~10-12% up
- Хороший баланс для обучения
- Достаточно примеров для всех классов

**c) Threshold = 0.002 (0.2%)**
- Ожидаемое распределение: ~65-70% flat, ~15-17% down, ~15-17% up
- Очень сбалансированное, но может быть слишком чувствительно к шуму
- Риск переобучения на микро-движения

### 2. Увеличить Horizon (альтернатива)

**Цель:** Дать цене больше времени для движения

#### Варианты:

**a) Horizon = 1800 секунд (30 минут)**
- С текущим threshold=0.01: ожидаемое ~85-88% flat
- Комбинация с threshold=0.005: ~75-80% flat

**b) Horizon = 3600 секунд (1 час)**
- С текущим threshold=0.01: ожидаемое ~80-85% flat
- Комбинация с threshold=0.005: ~70-75% flat

**⚠️ Минусы увеличения horizon:**
- Модель будет предсказывать более долгосрочные движения
- Может быть менее полезно для краткосрочной торговли
- Требует больше данных для обучения

### 3. Комбинация (рекомендуется)

#### Вариант A (консервативный):
```
Threshold = 0.005 (0.5%)
Horizon = 900 секунд (15 минут)
```
- Ожидаемое: ~85-88% flat, ~6-7% down, ~6-7% up
- Подходит для начала экспериментов

#### Вариант B (сбалансированный) ⭐ **РЕКОМЕНДУЕТСЯ**
```
Threshold = 0.003 (0.3%)
Horizon = 900 секунд (15 минут)
```
- Ожидаемое: ~75-80% flat, ~10-12% down, ~10-12% up
- Хороший баланс между чувствительностью и шумом
- Подходит для краткосрочной торговли

#### Вариант C (агрессивный):
```
Threshold = 0.003 (0.3%)
Horizon = 1800 секунд (30 минут)
```
- Ожидаемое: ~70-75% flat, ~12-15% down, ~12-15% up
- Максимально сбалансированное распределение
- Подходит для среднесрочной торговли

---

## Конкретная рекомендация

### Рекомендуемые настройки:

```bash
MODEL_CLASSIFICATION_THRESHOLD=0.003
MODEL_PREDICTION_HORIZON_SECONDS=900
```

### Обоснование:

1. **Threshold 0.3%** - хороший баланс между чувствительностью и шумом
   - Достаточно чувствителен для выявления реальных движений
   - Не слишком чувствителен к микро-шумам рынка

2. **Horizon 15 минут** - подходит для краткосрочной торговли
   - Соответствует типичным торговым стратегиям
   - Не требует слишком долгого ожидания сигналов

3. **Ожидаемое распределение: ~75-80% flat, ~10-12% down, ~10-12% up**
   - Достаточно примеров для обучения всех классов
   - Дисбаланс уменьшится с 22x до ~7-8x
   - ROC AUC должен улучшиться с текущих 0.53-0.60 до ~0.65-0.75

---

## Как применить

### Шаг 1: Обновить .env файл

```bash
# Отредактируйте .env файл
MODEL_CLASSIFICATION_THRESHOLD=0.003
MODEL_PREDICTION_HORIZON_SECONDS=900
```

### Шаг 2: Перезапустить контейнеры

**Важно:** Используйте `docker compose down` и `docker compose up -d`, а не `restart`, чтобы новые переменные окружения были применены.

```bash
docker compose down
docker compose up -d
```

### Шаг 3: Проверить применение настроек

```bash
docker compose exec model-service python3 << 'EOF'
import os
threshold = float(os.getenv("MODEL_CLASSIFICATION_THRESHOLD", "0.01"))
horizon = int(os.getenv("MODEL_PREDICTION_HORIZON_SECONDS", "120"))
print(f"Threshold: {threshold} ({threshold*100:.1f}%)")
print(f"Horizon: {horizon} секунд ({horizon//60} минут)")
EOF
```

### Шаг 4: Переобучить модель

Запустите обучение модели с новыми параметрами. Модель автоматически использует новые значения threshold и horizon при построении датасета.

### Шаг 5: Проверить новое распределение классов

После обучения проверьте распределение классов в логах или через API. Ожидаемое распределение:
- Класс 0 (flat): ~75-80%
- Класс -1 (down): ~10-12%
- Класс 1 (up): ~10-12%

---

## Ожидаемые улучшения

После применения рекомендуемых настроек:

1. **Распределение классов:**
   - Дисбаланс уменьшится с 22x до ~7-8x
   - Количество примеров классов движений увеличится в 2-3 раза

2. **Метрики модели:**
   - **ROC AUC:** улучшится с 0.53-0.60 до ~0.65-0.75
   - **Recall:** улучшится с ~30% до ~50-60%
   - **F1-score:** улучшится с ~0.44-0.47 до ~0.55-0.65

3. **Качество предсказаний:**
   - Модель будет лучше различать классы
   - Уменьшится количество пропущенных сигналов
   - Улучшится баланс между precision и recall

---

## Альтернативные варианты

Если рекомендуемые настройки не дают желаемого результата:

### Если все еще слишком много класса 0 (>85%):
- Уменьшите threshold до 0.002 (0.2%)
- Или увеличьте horizon до 1800 секунд (30 минут)

### Если слишком много шума (много ложных сигналов):
- Увеличьте threshold до 0.005 (0.5%)
- Или уменьшите horizon до 600 секунд (10 минут)

### Если нужно больше примеров для обучения:
- Увеличьте `MODEL_RETRAINING_TRAIN_PERIOD_DAYS` до 45-60 дней
- Это даст больше исторических данных для обучения

---

## Связанные документы

- [План реализации проверки распределения классов](class_distribution_validation_plan.md)
- [Документация Feature Service](../specs/005-feature-service/spec.md)
- [Документация Model Service](../specs/006-model-service/spec.md)

