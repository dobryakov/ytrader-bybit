# Микросервис обучения и принятия торговых решений (Model Service)

## Общая концепция

- Микросервис model работает в коммуникации с другими микросервисами проекта (например, ws-gateway или order manager) и концентрируется на принятии стратегических решений с учётом текущего состояния, а микросервис order manager отвечает за безопасное и корректное выполнение этих решений на бирже.
- Микросервис order manager (ордеров) не входит в эту задачу и будет спроектирован и разработан отдельно. В текущей задаче следует спроектировать и реализовать текущий микросервис, подразумевая будущие рабочие интеграции с другими микросервисами.

## Что делает микросервис

- Подписывается на очередь с обогащёнными событиями исполнения ордеров от микросервиса ордеров.
- Получает текущую информацию о состоянии открытых ордеров и позиций из общей базы данных PostgreSQL.
- Анализирует реальное исполнение сделок и сопутствующие рыночные данные, образуя выборки для обучения.
- Обучает или дообучает ML-модель (например, онлайн-обучение или обучение с подкреплением) в реальном времени на обратной связи от исполнения ордеров.
- Генерирует высокоуровневые торговые сигналы на основе модели и публикует их в очередь для микросервиса ордеров.
- Отслеживает качество модели, ведёт логирование и обеспечивает версионирование.

## Пример генерируемого сигнала

{
  "signal": "sell",
  "asset": "ETHUSDT",
  "amount": 500,
  "confidence": 0.90,
  "timestamp": "2025-11-25T21:35:00Z",
  "strategy_id": "strat-002"
}

## Режим прогрева (Warm-up)

### Цель

- Обеспечить старт торговых сигналов в условиях отсутствия обученной модели и исторических данных, позволяя системе сразу генерировать сигналы для запуска торговли и накопления первого опыта для обучения.

### Что делает режим прогрева

- Включает режим прогрева, при котором модель использует простые эвристики или случайную генерацию сигналов для торговли.  
- Генерирует высокоуровневые торговые сигналы (buy/sell, инструмент, сумма в валюте и пр.) с контролируемой частотой и параметрами, минимизируя риски.
- Публикует эти сигналы в очередь RabbitMQ для микросервиса ордеров, который занимается исполнением.  
- Параллельно принимает и агрегирует события исполнения ордеров из той же очереди для последующего обучения.  
- По мере накопления и обработки данных постепенно (например при приближении к определённому уровня качества прогнозов) переключается на использование обучаемой модели, заменяя эвристический режим.  
- Обеспечивает конфигурируемость режима прогрева (например, длительность, уровень случайности, минимальные параметры ордеров).  
- Ведёт логирование и мониторинг параметров и переходов между режимами.

### Зачем это нужно

- Начать торговлю и сбор данных при отсутствии исторического опыта.  
- Обеспечить безболезненный старт и плавный переход к сложным стратегиям.  
- Минимизировать риски на ранних этапах работы.

## Технологический стек

- Рассмотри мировые best practices и выбери наиболее правильные и подходящие решения для этого микросервиса, включая специализированные базы данных.
- Если данному микросервису нужен cron, исполни его внутри контейнера или в отдельном контейнере, но не относи на хост-машину.

## Хранение временных рядов и дообучение модели в Model Service

- Добавить в спецификацию Model Service задачи, расширяющие feature engineering обучающей выборки, структуру снапшота рынка и хранение данных, в том числе в режиме warm-up.

## User Story

- Как архитектор торговой системы, я хочу, чтобы модель учитывала и мгновенное состояние рынка в момент ордера, и (при возможности) историческую динамику и тренды за период до ордера, опираясь на долгохранящиеся, качественные и нормализованные данные временных рядов, чтобы повысить точность и качество торговых сигналов.

### Описание

- Модель должна обучаться не только на текущих снапшотах рынка в момент создания ордера, но также учитывать временные последовательности рыночных данных (тикеры, свечи, стакан заказов) за некоторый период до ордера.

### Для этого необходимо

- Реализовать обработку и агрегацию временных окон рыночных данных в сервисе с вычислением трендовых показателей, таких как скользящие средние, изменение объёмов, индикаторы тренда и другие агрегаты.
- Включить в структуру snapshot рынка для ордер-сервиса новую группу признаков — «выжимку из трендов» за рассчитанный период, отражающую рыночную динамику.
- Обновить построитель тренировочного датасета, чтобы он агрегировал эти новые признаки вместе с остальными и включал их в обучающую выборку.
- Сделать период истории для анализа и вычисления трендовых признаков конфигурируемым.
- Организовать долгосрочное сохранение потоковых WebSocket-данных с рынка, полученных через очередь от ws-gateway (тикеров, свечей, стаканов заказов) в специализированное хранилище временных рядов (TSDB) или форматах, оптимизированных под временные данные, например Apache Parquet, с разделением горячих и архивных данных для эффективности и масштабируемости.
- Реализовать пайплайны очистки, фильтрации и нормализации входящих рыночных данных сразу при их приёме, чтобы исключить пропуски, аномалии и «грязные» данные, повышая качество обучающей выборки.
- Обеспечить мониторинг качества входящих данных с автоматическими оповещениями при обнаружении проблем.
- Внедрить механизмы архивации и очистки для управления объёмом и сроками хранения данных.
- Обновить документацию и тесты для новых функций и признаков.
