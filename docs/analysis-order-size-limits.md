# Анализ: Почему ордера отклоняются из-за превышения лимита размера

**Дата**: 2025-12-02  
**Проблема**: Ордера отклоняются с ошибкой "Order size exceeds limit", хотя баланс достаточен.

## Текущая ситуация

### Параметры из конфигурации

**Model Service:**
- `WARMUP_MIN_AMOUNT`: 100.0 USDT (по умолчанию)
- `WARMUP_MAX_AMOUNT`: 1000.0 USDT (по умолчанию)
- Рассчитывает сумму сигнала: 100-1000 USDT

**Order Manager:**
- `ORDERMANAGER_MAX_EXPOSURE`: 10000.0 USDT (текущее значение в .env)
- `ORDERMANAGER_MAX_ORDER_SIZE_RATIO`: 0.1 (10% от max_exposure)
- Максимальный размер ордера: 10000 * 0.1 = **1000 USDT**

**Реальная ситуация:**
- Сигнал требует: ~3900-4000 USDT (amount=494.67 * цена)
- Но из-за неправильной цены от Bybit testnet, order_value получается еще выше

## Архитектурная проблема

### Почему model-service не учитывает лимиты order-manager?

**Текущая архитектура:**
1. **Model-service** - независимый микросервис
   - Рассчитывает сумму сигнала на основе модели и confidence
   - Использует свои конфигурации (min_amount, max_amount)
   - НЕ знает о лимитах order-manager
   - НЕ должен знать о деталях реализации других сервисов (принцип микросервисов)

2. **Order-manager** - независимый микросервис
   - Получает сигналы через RabbitMQ
   - Проверяет лимиты (баланс, размер ордера, размер позиции)
   - **Только отклоняет**, если превышает лимиты
   - НЕ адаптирует сумму под лимиты

**Почему так спроектировано:**
- Микросервисы должны быть независимыми
- Model-service не должен зависеть от настроек order-manager
- Каждый сервис имеет свою ответственность

### Может ли order-manager адаптировать сумму?

**Текущая реализация:**
- `risk_manager.check_order_size()` - только проверяет и отклоняет
- Нет логики адаптации суммы под лимиты
- При превышении лимита выбрасывается `RiskLimitError`

**Архитектурные варианты:**

#### Вариант 1: Order-manager адаптирует сумму (текущая логика для баланса)
**Плюсы:**
- Model-service остается независимым
- Лимиты контролируются в одном месте (order-manager)
- Гибкость: можно менять лимиты без изменения model-service

**Минусы:**
- Может создать ордер, который модель не хотела
- Может изменить намерение сигнала (меньшая сумма = меньшее влияние)

**Текущая реализация для баланса:**
- Model-service уже адаптирует сумму под баланс через `balance_calculator`
- Это делается ДО отправки сигнала в order-manager

#### Вариант 2: Model-service учитывает лимиты order-manager
**Плюсы:**
- Сигналы сразу соответствуют лимитам
- Нет лишних отклонений

**Минусы:**
- Нарушает принцип независимости микросервисов
- Model-service должен знать настройки order-manager
- Сложность синхронизации конфигураций

**Текущая реализация:**
- Model-service НЕ знает о лимитах order-manager
- Нет механизма получения лимитов из order-manager

#### Вариант 3: Order-manager адаптирует сумму под лимиты (как для баланса)
**Плюсы:**
- Централизованное управление рисками
- Model-service остается независимым
- Меньше отклонений сигналов

**Минусы:**
- Может изменить намерение модели
- Нужно решить, как адаптировать (уменьшить amount? уменьшить quantity?)

**Аналогия с балансом:**
- Model-service адаптирует под баланс ДО отправки сигнала
- Order-manager может адаптировать под лимиты ПРИ обработке

## Рекомендации

### Рекомендация 1: Order-manager адаптирует сумму под лимиты (рекомендуется)

**Логика:**
1. Проверить, превышает ли order_value max_order_size
2. Если превышает - уменьшить quantity пропорционально
3. Пересчитать quantity = (max_order_size / order_price) с округлением до lot_size
4. Создать ордер с уменьшенным quantity
5. Логировать адаптацию

**Плюсы:**
- Централизованное управление рисками
- Model-service остается независимым
- Меньше отклонений
- Аналогично адаптации под баланс

**Минусы:**
- Может создать ордер меньше, чем хотела модель

### Рекомендация 2: Model-service получает лимиты через API (альтернатива)

**Логика:**
1. Model-service запрашивает лимиты у order-manager через REST API
2. Учитывает лимиты при расчете суммы сигнала
3. Генерирует сигнал, который точно соответствует лимитам

**Плюсы:**
- Сигналы сразу соответствуют лимитам

**Минусы:**
- Нарушает независимость микросервисов
- Дополнительная зависимость и API-вызов
- Сложность синхронизации

## Текущее поведение

### Model-service:
- Рассчитывает сумму: 100-1000 USDT (по умолчанию)
- Адаптирует под баланс ДО отправки сигнала
- НЕ учитывает лимиты order-manager

### Order-manager:
- Проверяет баланс: ✅ проходит
- Проверяет max_order_size: ❌ отклоняет (только проверка, без адаптации)
- Создает ордер: не доходит до этого шага

## Вывод

**Текущая проблема:**
- Order-manager только проверяет и отклоняет
- Нет адаптации суммы под лимиты (кроме баланса, который обрабатывается в model-service)

**Рекомендуемое решение:**
- Order-manager должен адаптировать quantity под max_order_size (аналогично тому, как model-service адаптирует под баланс)
- Это соответствует принципу централизованного управления рисками
- Model-service остается независимым

