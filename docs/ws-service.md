# Спецификация микросервиса агрегации и маршрутизации WebSocket данных Bybit (WebSocket Gateway)

## Что делает микросервис

- Устанавливает и поддерживает двойное WebSocket-соединение с Bybit (основной или тестнет):
  - Публичное соединение (`/v5/public`) для публичных данных (не требует аутентификации)
  - Приватное соединение (`/v5/private`) для приватных данных (требует API-ключи)
- Поддерживает автоматическое переподключение и heartbeat для надёжной работы с WebSocket.
- Подписывается на множество каналов WebSocket: сделки, тикеры, стаканы, статусы ордеров, балансы и другие (храня данные о подписках чтобы переподписаться заново в случае сбоя).
- Получает данные в формате JSON с уникальными идентификаторами, типами событий, временными метками и полезной нагрузкой.
- Управляет динамическими подписками по запросам от соседних микросервисов через внешний REST API.
- Обеспечивает подписчикам (сервис модели, сервис ордер-менеджер, и другие) доставку свежих и структурированных событий из очередей.
- Помещает полученные события в соответствующие очереди, разделяя их по классам событий (для обеспечения масштабируемости и удобства обработки).
- Часть входящих данных из websocket-каналов (например, данные балансе или об остатках на счетах) может сразу помещать в БД.
- Логирует события, WebSocket-сообщения и REST-запросы для мониторинга и отладки.
- Масштабируется для поддержки множества подписчиков без дублирования соединений к бирже.

## Поддержка публичных и приватных эндпоинтов

Микросервис поддерживает **двойное WebSocket-соединение** к Bybit для оптимальной масштабируемости и разделения ответственности:

### Публичное соединение (`/v5/public`)
- **Не требует аутентификации** (API ключи не нужны)
- Используется для публичных каналов: `trades`, `ticker`, `orderbook`, `kline`, `liquidation`
- Автоматически выбирается при подписке на публичные каналы

### Приватное соединение (`/v5/private`)
- **Требует аутентификации** через API ключи Bybit
- Используется для приватных каналов: `balance` (wallet), `order`, `position`
- Автоматически выбирается при подписке на приватные каналы

### Преимущества двойного соединения
- ✅ **Масштабируемость**: Публичные данные не требуют API ключей
- ✅ **Разделение ответственности**: Публичные и приватные данные обрабатываются независимо
- ✅ **Независимое переподключение**: Каждый тип соединения переподключается независимо
- ✅ **Автоматический выбор**: Система автоматически выбирает правильный эндпоинт на основе типа канала

### Классификация каналов

**Публичные каналы** (используют `/v5/public`):
- `trades` — сделки
- `ticker` — тикеры
- `orderbook` — стаканы заявок
- `kline` — свечи
- `liquidation` — ликвидации

**Приватные каналы** (используют `/v5/private`):
- `balance` — балансы кошелька (wallet)
- `order` — статусы ордеров
- `position` — позиции (если будет добавлено)

Подробное описание архитектуры см. в [ws-gateway-public-endpoints.md](./ws-gateway-public-endpoints.md).
