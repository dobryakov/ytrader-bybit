# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤ –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ

## –¶–µ–ª—å
–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤ –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ –ø–µ—Ä–µ–¥ –æ–±—É—á–µ–Ω–∏–µ–º –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã –≤—ã—è–≤–ª—è—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∏—Å–±–∞–ª–∞–Ω—Å—ã –∫–ª–∞—Å—Å–æ–≤ –Ω–∞ —Ä–∞–Ω–Ω–µ–º —ç—Ç–∞–ø–µ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –Ω–∞ –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

## –ü—Ä–æ–±–ª–µ–º–∞
–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:
- –ú–æ–¥–µ–ª–∏ –º–æ–≥—É—Ç –æ–±—É—á–∞—Ç—å—Å—è –Ω–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞—Ö —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –¥–∏—Å–±–∞–ª–∞–Ω—Å–æ–º –∫–ª–∞—Å—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100% –∫–ª–∞—Å—Å 0)
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–±–º–∞–Ω—á–∏–≤–æ –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (accuracy ~1.0), –Ω–æ –º–æ–¥–µ–ª—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ–¥–∏–Ω –∫–ª–∞—Å—Å
- –ü—Ä–æ–±–ª–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è, —á—Ç–æ —Ç—Ä–∞—Ç–∏—Ç –≤—Ä–µ–º—è –∏ —Ä–µ—Å—É—Ä—Å—ã

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—É—á–µ–Ω–∏—è)
**–î–∞—Ç–∞—Å–µ—Ç:** `8b39b294-b70c-4a70-8868-e0ae51885bf4` (2025-12-09)

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤:**
- **Train split:** –ö–ª–∞—Å—Å 0 (flat): 91.49%, –ö–ª–∞—Å—Å -1 (down): 4.42%, –ö–ª–∞—Å—Å 1 (up): 4.09%
- **Validation split:** –ö–ª–∞—Å—Å 0 (flat): 91.79%, –ö–ª–∞—Å—Å -1 (down): 4.27%, –ö–ª–∞—Å—Å 1 (up): 3.95%
- **Test split:** –ö–ª–∞—Å—Å 0 (flat): 94.30%, –ö–ª–∞—Å—Å -1 (down): 3.06%, –ö–ª–∞—Å—Å 1 (up): 2.64%
- **–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞:** 22.35x (–∫–ª–∞—Å—Å 0 –≤ 22 —Ä–∞–∑–∞ —á–∞—â–µ –º–∏–Ω–æ—Ä–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤)

**–ú–µ—Ç—Ä–∏–∫–∏ –º–æ–¥–µ–ª–∏:**
- Accuracy: ~32% (–Ω–∏–∑–∫–∞—è, –Ω–æ –ª—É—á—à–µ —á–µ–º –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –∫–ª–∞—Å—Å 0)
- Precision: ~83-89% (—Ö–æ—Ä–æ—à–æ: –∫–æ–≥–¥–∞ –º–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ, –æ–Ω–∞ —á–∞—Å—Ç–æ –ø—Ä–∞–≤–∞)
- Recall: ~30-32% (–ø–ª–æ—Ö–æ: –º–æ–¥–µ–ª—å –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç ~70% –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–≤–∏–∂–µ–Ω–∏–π)
- ROC AUC: ~0.53-0.60 (–±–ª–∏–∑–∫–æ –∫ —Å–ª—É—á–∞–π–Ω–æ–º—É, –ø–ª–æ—Ö–æ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –∫–ª–∞—Å—Å—ã)

**–í—ã–≤–æ–¥:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å (91-94% –∫–ª–∞—Å—Å–∞ 0) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∑–æ–Ω–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è. –ú–æ–¥–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∏–∑–∫–æ–µ –∏–∑-–∑–∞ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ –∏, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.

## –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞, –¥–æ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏.

---

## –ó–∞–¥–∞—á–∞ 1: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ validate_class_distribution() –≤ TrainingDataset

**–§–∞–π–ª:** `model-service/src/models/training_dataset.py`

### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. **–°–∏–≥–Ω–∞—Ç—É—Ä–∞ –º–µ—Ç–æ–¥–∞:**
```python
def validate_class_distribution(
    self,
    warning_threshold: float = 0.9,
    error_threshold: float = 0.95,
    min_class_ratio: float = 0.01,
    min_class_count: int = 10,
) -> Dict[str, Any]:
```

2. **–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
   - –í—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ —á–µ—Ä–µ–∑ `self.labels.value_counts()`
   - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
   - –í—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–≥–æ –∫–ª–∞—Å—Å–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ (–æ—à–∏–±–∫–∞, –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ 1 –∫–ª–∞—Å—Å)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞
   - –í—ã—á–∏—Å–ª–∏—Ç—å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ (max/min)

3. **–ü—Ä–æ–≤–µ—Ä–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:**
   - **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å (>error_threshold)**: –í—ã–∑–≤–∞—Ç—å `ValueError` —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
   - **–£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å (>warning_threshold)**: –í–µ—Ä–Ω—É—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
   - **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –∏–º–µ–µ—Ç –º–∏–Ω–∏–º—É–º `min_class_count` –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–ª–∏ `min_class_ratio * total` –ø—Ä–∏–º–µ—Ä–æ–≤

4. **–í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:**
```python
{
    "class_distribution": {class: count, ...},  # –°–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º
    "class_percentages": {class: percentage, ...},  # –ü—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞
    "max_class": int,  # –ö–ª–∞—Å—Å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
    "max_class_percentage": float,  # –ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–≥–æ –∫–ª–∞—Å—Å–∞
    "min_class": int,  # –ö–ª–∞—Å—Å —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
    "min_class_percentage": float,  # –ü—Ä–æ—Ü–µ–Ω—Ç –º–∏–Ω–æ—Ä–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
    "imbalance_ratio": float,  # –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ max/min
    "unique_classes_count": int,  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤
    "status": str,  # "balanced" | "moderate_imbalance" | "critical_imbalance"
    "warnings": List[str],  # –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
    "is_valid": bool,  # True –µ—Å–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ
}
```

5. **–ò–º–ø–æ—Ä—Ç—ã:**
   - –î–æ–±–∞–≤–∏—Ç—å `from ..config.logging import get_logger` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `logger` –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (–Ω–µ –¥–ª—è –æ—à–∏–±–æ–∫ - –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è)

---

## –ó–∞–¥–∞—á–∞ 2: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø–æ—Ä–æ–≥–∏ –≤ Settings

**–§–∞–π–ª:** `model-service/src/config/settings.py`

### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ –∫–ª–∞—Å—Å Settings (–ø–æ—Å–ª–µ model_classification_threshold):**
```python
# Class Distribution Validation Configuration
model_training_class_imbalance_warning_threshold: float = Field(
    default=0.9,
    alias="MODEL_TRAINING_CLASS_IMBALANCE_WARNING_THRESHOLD",
    description="Warning threshold for class imbalance (0.9 = 90%). Training continues but warning is logged."
)
model_training_class_imbalance_error_threshold: float = Field(
    default=0.95,
    alias="MODEL_TRAINING_CLASS_IMBALANCE_ERROR_THRESHOLD",
    description="Error threshold for critical class imbalance (0.95 = 95%). Training is aborted if exceeded."
)
model_training_min_class_ratio: float = Field(
    default=0.01,
    alias="MODEL_TRAINING_MIN_CLASS_RATIO",
    description="Minimum ratio of examples per class (0.01 = 1% of total). Classes below this ratio trigger warnings."
)
model_training_min_class_count: int = Field(
    default=10,
    alias="MODEL_TRAINING_MIN_CLASS_COUNT",
    description="Minimum absolute count of examples per class. Classes below this count trigger warnings."
)
```

2. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã:**
```python
@field_validator("model_training_class_imbalance_warning_threshold")
@classmethod
def validate_warning_threshold(cls, v: float) -> float:
    """Validate warning threshold is between 0 and 1."""
    if not 0.0 <= v <= 1.0:
        raise ValueError("Warning threshold must be between 0.0 and 1.0")
    return v

@field_validator("model_training_class_imbalance_error_threshold")
@classmethod
def validate_error_threshold(cls, v: float) -> float:
    """Validate error threshold is between 0 and 1."""
    if not 0.0 <= v <= 1.0:
        raise ValueError("Error threshold must be between 0.0 and 1.0")
    if v <= settings.model_training_class_imbalance_warning_threshold:
        raise ValueError("Error threshold must be greater than warning threshold")
    return v
```

3. **–û–±–Ω–æ–≤–∏—Ç—å env.example –∏ .env**
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –≤ –æ–±–∞ —Ñ–∞–π–ª–∞

---

## –ó–∞–¥–∞—á–∞ 3: –í—ã–∑–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ training_orchestrator.py

**–§–∞–π–ª:** `model-service/src/services/training_orchestrator.py`

### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. **–ú–µ—Å—Ç–æ –≤—ã–∑–æ–≤–∞:** –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 534 (–ø–æ—Å–ª–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è "Dataset loaded successfully"), –ø–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–æ–π 536 (–ø—Ä–æ–≤–µ—Ä–∫–∞ _training_cancelled)

2. **–ö–æ–¥:**
```python
# Validate class distribution before training
try:
    from ..config.settings import settings
    distribution_result = dataset.validate_class_distribution(
        warning_threshold=settings.model_training_class_imbalance_warning_threshold,
        error_threshold=settings.model_training_class_imbalance_error_threshold,
        min_class_ratio=settings.model_training_min_class_ratio,
        min_class_count=settings.model_training_min_class_count,
    )
    
    # Log distribution statistics
    logger.info(
        "Class distribution validated",
        training_id=training_id,
        dataset_id=str(dataset_id),
        class_distribution=distribution_result["class_distribution"],
        max_class_percentage=distribution_result["max_class_percentage"],
        imbalance_ratio=distribution_result["imbalance_ratio"],
        status=distribution_result["status"],
        trace_id=trace_id,
    )
    
    # Log warnings if any
    if distribution_result.get("warnings"):
        for warning in distribution_result["warnings"]:
            logger.warning(
                "Class distribution warning",
                training_id=training_id,
                dataset_id=str(dataset_id),
                warning=warning,
                trace_id=trace_id,
            )
    
    # Check if training should continue
    if not distribution_result["is_valid"]:
        logger.error(
            "Training aborted due to critical class imbalance",
            training_id=training_id,
            dataset_id=str(dataset_id),
            max_class_percentage=distribution_result["max_class_percentage"],
            recommendations="Consider adjusting MODEL_CLASSIFICATION_THRESHOLD or MODEL_PREDICTION_HORIZON_SECONDS",
            trace_id=trace_id,
        )
        return  # Abort training
        
except ValueError as e:
    # Critical imbalance detected - abort training
    logger.error(
        "Training aborted due to critical class imbalance",
        training_id=training_id,
        dataset_id=str(dataset_id),
        error=str(e),
        recommendations="Consider adjusting MODEL_CLASSIFICATION_THRESHOLD or MODEL_PREDICTION_HORIZON_SECONDS",
        trace_id=trace_id,
    )
    return  # Abort training
```

3. **–ò–º–ø–æ—Ä—Ç—ã:**
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `settings` –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω (–≤–µ—Ä–æ—è—Ç–Ω–æ, —É–∂–µ –µ—Å—Ç—å)

---

## –ó–∞–¥–∞—á–∞ 4: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è validation –∏ test splits

**–§–∞–π–ª:** `model-service/src/services/training_orchestrator.py`

### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. **–î–ª—è validation split (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 573):**
```python
# Validate validation split class distribution
if validation_labels is not None:
    try:
        val_distribution = validation_labels.value_counts()
        val_total = len(validation_labels)
        val_max_pct = val_distribution.max() / val_total if val_total > 0 else 0
        
        logger.info(
            "Validation split class distribution",
            training_id=training_id,
            class_distribution=val_distribution.to_dict(),
            max_class_percentage=val_max_pct,
            trace_id=trace_id,
        )
        
        # Compare with train split distribution
        train_distribution = dataset.labels.value_counts()
        train_max_class = train_distribution.idxmax()
        val_max_class = val_distribution.idxmax()
        
        if train_max_class != val_max_class:
            logger.warning(
                "Different dominant class in validation split",
                training_id=training_id,
                train_max_class=int(train_max_class),
                validation_max_class=int(val_max_class),
                trace_id=trace_id,
            )
    except Exception as e:
        logger.warning(
            "Failed to validate validation split distribution",
            training_id=training_id,
            error=str(e),
            trace_id=trace_id,
        )
```

2. **–î–ª—è test split (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 660, –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ test_df):**
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è test split
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å train –∏ validation splits

---

## –ó–∞–¥–∞—á–∞ 5: –û–±–Ω–æ–≤–∏—Ç—å validate_consistency() –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

**–§–∞–π–ª:** `model-service/src/models/training_dataset.py`

### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. **–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥ validate_consistency():**
```python
def validate_consistency(
    self,
    validate_class_distribution: bool = True,
    **class_distribution_kwargs
) -> None:
    """
    Validate that features and labels have consistent dimensions.
    Optionally validate class distribution.

    Args:
        validate_class_distribution: If True, also validate class distribution
        **class_distribution_kwargs: Arguments to pass to validate_class_distribution()
    
    Raises:
        ValueError: If features and labels dimensions don't match or class distribution is invalid
    """
    if len(self.features) != len(self.labels):
        raise ValueError(
            f"Features and labels must have the same length: "
            f"features={len(self.features)}, labels={len(self.labels)}"
        )
    
    if validate_class_distribution:
        # This will raise ValueError if critical imbalance detected
        self.validate_class_distribution(**class_distribution_kwargs)
```

2. **–û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤ –≤ model_trainer.py:**
   - –ú–µ—Ç–æ–¥ `validate_consistency()` —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `model_trainer.py` (—Å—Ç—Ä–æ–∫–∞ 71)
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `validate_class_distribution=False` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

---

## –ó–∞–¥–∞—á–∞ 6: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª—ã:** `model-service/src/models/training_dataset.py`, `model-service/src/services/training_orchestrator.py`

### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. **–í validate_class_distribution():**
   - –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é (–º–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å—Ç—ã–º)
   - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ò—Å–∫–ª—é—á–µ–Ω–∏—è (ValueError) –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

2. **–í training_orchestrator.py:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–ª—é—á–∞–º–∏:
     - `class_distribution`: —Å–ª–æ–≤–∞—Ä—å {class: count}
     - `class_percentages`: —Å–ª–æ–≤–∞—Ä—å {class: percentage}
     - `max_class_percentage`: float
     - `imbalance_ratio`: float
     - `status`: str
     - `warnings`: List[str]
     - `recommendations`: str (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã)

3. **–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π:**
   - Info: –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–ª–∏ —É–º–µ—Ä–µ–Ω–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å
   - Warning: —É–º–µ—Ä–µ–Ω–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
   - Error: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å, –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ

---

## –ó–∞–¥–∞—á–∞ 7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–§–∞–π–ª—ã:** `model-service/README.md`, docstrings –≤ –∫–æ–¥–µ

### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. **–û–±–Ω–æ–≤–∏—Ç—å README.md:**
   - –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "Class Distribution Validation"
   - –û–ø–∏—Å–∞—Ç—å, –∫–æ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
   - –û–ø–∏—Å–∞—Ç—å –ø–æ—Ä–æ–≥–∏ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - –ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è—Ö
   - –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Ä–æ–≥–∏ —á–µ—Ä–µ–∑ environment variables

2. **–û–±–Ω–æ–≤–∏—Ç—å docstrings:**
   - –í `validate_class_distribution()`: –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
   - –í `validate_consistency()`: –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
   - –í Settings: –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π

3. **–ü—Ä–∏–º–µ—Ä—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**
```markdown
## Class Distribution Validation

The model service automatically validates class distribution before training to detect critical imbalances.

### Configuration

Set these environment variables to customize validation thresholds:

- `MODEL_TRAINING_CLASS_IMBALANCE_WARNING_THRESHOLD=0.9` (default: 0.9 = 90%)
- `MODEL_TRAINING_CLASS_IMBALANCE_ERROR_THRESHOLD=0.95` (default: 0.95 = 95%)
- `MODEL_TRAINING_MIN_CLASS_RATIO=0.01` (default: 0.01 = 1%)
- `MODEL_Training_MIN_CLASS_COUNT=10` (default: 10)

### Behavior

- **Warning (>90% one class)**: Training continues, but warning is logged
- **Error (>95% one class)**: Training is aborted with error message

### Example Error Message

```
Training aborted due to critical class imbalance
max_class_percentage: 100.0
recommendations: Consider adjusting MODEL_CLASSIFICATION_THRESHOLD or MODEL_PREDICTION_HORIZON_SECONDS
```
```

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. –ó–∞–¥–∞—á–∞ 2 (Settings) - –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
2. –ó–∞–¥–∞—á–∞ 1 (TrainingDataset) - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ validate_class_distribution()
3. –ó–∞–¥–∞—á–∞ 5 (TrainingDataset) - –æ–±–Ω–æ–≤–∏—Ç—å validate_consistency()
4. –ó–∞–¥–∞—á–∞ 3 (training_orchestrator) - –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è train split
5. –ó–∞–¥–∞—á–∞ 4 (training_orchestrator) - –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è validation/test splits
6. –ó–∞–¥–∞—á–∞ 6 (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) - —É–ª—É—á—à–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
7. –ó–∞–¥–∞—á–∞ 7 (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è) - –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

1. **–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –î–∞—Ç–∞—Å–µ—Ç —Å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–ª–∞—Å—Å–∞–º–∏ - –æ–±—É—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å—Å—è
2. **–£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å (90-95%):** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ, –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
   - **–¢–µ–∫—É—â–∏–π —Å–ª—É—á–∞–π:** 91-94% –∫–ª–∞—Å—Å–∞ 0 ‚Üí –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
3. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å (>95%):** –û–±—É—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–æ —Å –æ—à–∏–±–∫–æ–π
4. **–û–¥–∏–Ω –∫–ª–∞—Å—Å (100%):** –û–±—É—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–æ —Å –æ—à–∏–±–∫–æ–π
5. **–ú–∏–Ω–æ—Ä–Ω—ã–π –∫–ª–∞—Å—Å (<1%):** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è (91-94% –∫–ª–∞—Å—Å–∞ 0)
- **–°—Ç–∞—Ç—É—Å:** –£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–∏—Å–±–∞–ª–∞–Ω—Å (–≤ –∑–æ–Ω–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)
- **–î–µ–π—Å—Ç–≤–∏–µ:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ, –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
  1. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–º–µ–Ω—å—à–µ–Ω–∏–µ `MODEL_CLASSIFICATION_THRESHOLD` (—Å–µ–π—á–∞—Å 0.02)
  2. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ `MODEL_PREDICTION_HORIZON_SECONDS` (—Å–µ–π—á–∞—Å 120)
  3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `class_weight='balanced'` –≤ XGBoost –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –∫–ª–∞—Å—Å–æ–≤
  4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (features) - –≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
–ü—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ (91-94% –∫–ª–∞—Å—Å–∞ 0):
- ‚úÖ –û–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è (–¥–∏—Å–±–∞–ª–∞–Ω—Å < 95%)
- ‚ö†Ô∏è –ë—É–¥–µ—Ç –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- üìä –í –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:
  - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ –ø–æ –≤—Å–µ–º splits
  - –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞
  - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `model-service/src/models/training_dataset.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `model-service/src/services/training_orchestrator.py` - –≤—ã–∑–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `model-service/src/config/settings.py` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ—Ä–æ–≥–æ–≤
- `model-service/src/services/model_trainer.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ validate_consistency()
- `model-service/README.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `.env` –∏ `env.example` - –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

