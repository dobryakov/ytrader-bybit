# –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

## –û–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–∏—Å—Ç–µ–º—ã —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ **Fluent Bit + Loki + Grafana**.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è    ‚îÇ
        ‚îÇ (ws-gateway,    ‚îÇ
        ‚îÇ  model-service, ‚îÇ
        ‚îÇ  –∏ —Ç.–¥.)        ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ   ‚îÇ
        stdout ‚îÇ   ‚îÇ stderr
        (—Ü–≤–µ—Ç–Ω–æ–π) ‚îÇ (JSON)
               ‚îÇ   ‚îÇ
               ‚ñº   ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ     Docker      ‚îÇ
        ‚îÇ  (json-file     ‚îÇ
        ‚îÇ   driver)       ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ   ‚îÇ
               ‚îÇ   ‚îÇ stream=stderr
               ‚îÇ   ‚îÇ
               ‚ñº   ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ docker       ‚îÇ  ‚îÇ  Fluent Bit  ‚îÇ
    ‚îÇ compose logs ‚îÇ  ‚îÇ  (—á–∏—Ç–∞–µ—Ç     ‚îÇ
    ‚îÇ (—Ü–≤–µ—Ç–Ω–æ–π     ‚îÇ  ‚îÇ   —Ñ–∞–π–ª—ã,     ‚îÇ
    ‚îÇ  –≤—ã–≤–æ–¥)      ‚îÇ  ‚îÇ   —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ   stderr)    ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                      ‚îÇ     Loki     ‚îÇ
                      ‚îÇ  (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ  ‚îÇ
                      ‚îÇ    –ª–æ–≥–æ–≤)    ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                      ‚îÇ   Grafana    ‚îÇ
                      ‚îÇ (–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è‚îÇ
                      ‚îÇ  –∏ –∑–∞–ø—Ä–æ—Å—ã)  ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. **–î–≤–æ–π–Ω–æ–π –¥–æ—Å—Ç—É–ø –∫ –ª–æ–≥–∞–º:**
   - `docker compose logs` –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (—á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª—ã Docker)
   - Grafana –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Loki

2. **–ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:**
   - –í—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —É–∂–µ –ø–∏—à—É—Ç –ª–æ–≥–∏ –≤ stdout
   - Fluent Bit –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –ª–æ–≥–∏ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

3. **–õ–µ–≥–∫–æ–≤–µ—Å–Ω–æ—Å—Ç—å:**
   - Fluent Bit - –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π —Å–±–æ—Ä—â–∏–∫ (C, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã)
   - Loki - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ª–æ–≥–æ–≤ (–º–µ–Ω—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤, —á–µ–º Elasticsearch)

4. **Dual-sink –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–∏—à—É—Ç —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –≤ **stdout** (–¥–ª—è `docker compose logs`)
   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–∏—à—É—Ç JSON –≤ **stderr** (–¥–ª—è Fluent Bit ‚Üí Loki)
   - Fluent Bit —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ `stream=stderr` –∏ –ø–∞—Ä—Å–∏—Ç —á–∏—Å—Ç—ã–π JSON
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ trace_id –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ù–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ "–ø–æ —É–¥–∞—á–µ", –Ω–µ—Ç regex-–º–∞–≥–∏–∏

5. **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å:**
   - Fluent Bit –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ª–æ–≥–∏ –≤ —Ä–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (Loki, Elasticsearch, Graylog)
   - –õ–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥—É—é —Å–∏—Å—Ç–µ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—è

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç—É –ª–æ–≥–æ–≤

### Dual-Sink Logging: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–¶–µ–ª—å:**
- üëÄ `docker compose logs` ‚Üí —Ü–≤–µ—Ç–Ω–æ–π, —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π
- ü§ñ Loki ‚Üí —Å—Ç—Ä–æ–≥–æ JSON, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Ñ–∏–ª—å—Ç—Ä—É–µ–º—ã–π
- ‚ùå –ë–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞ "–ø–æ —É–¥–∞—á–µ"
- ‚ùå –ë–µ–∑ regex-–º–∞–≥–∏–∏

**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±:** Dual-sink logging ‚Äî –æ–¥–∏–Ω –ª–æ–≥-–∏–≤–µ–Ω—Ç ‚Üí –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –≤—ã–≤–æ–¥–∞.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ structlog    ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ                        ‚îÇ
           ‚ñº                        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ConsoleRenderer     ‚îÇ  ‚îÇ JSONRenderer        ‚îÇ
‚îÇ (—Ü–≤–µ—Ç–Ω–æ–π stdout)    ‚îÇ  ‚îÇ (stderr)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                        ‚îÇ
           ‚ñº                        ‚ñº
 docker compose logs        Fluent Bit ‚Üí Loki
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ Python (structlog)

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è dual-sink logging

```python
import logging
import structlog
import sys

# –û–±—â–∏–µ processors –¥–ª—è –æ–±–æ–∏—Ö handler'–æ–≤
shared_processors = [
    structlog.contextvars.merge_contextvars,
    structlog.processors.TimeStamper(fmt="iso"),
    structlog.stdlib.add_log_level,
    structlog.stdlib.add_logger_name,
    structlog.processors.StackInfoRenderer(),
    structlog.processors.format_exc_info,
]

# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: basicConfig –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
# Handlers –±—É–¥—É—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –Ω–∏–∂–µ —á–µ—Ä–µ–∑ root.handlers
logging.basicConfig(level=logging.INFO)

# stdout ‚Äî —Ü–≤–µ—Ç–Ω–æ–π –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞
console_handler = logging.StreamHandler(sys.stdout)
console_handler.setFormatter(
    structlog.stdlib.ProcessorFormatter(
        processor=structlog.dev.ConsoleRenderer(colors=True),
        foreign_pre_chain=shared_processors,
    )
)

# stderr ‚Äî JSON –¥–ª—è Loki
json_handler = logging.StreamHandler(sys.stderr)
json_handler.setFormatter(
    structlog.stdlib.ProcessorFormatter(
        processor=structlog.processors.JSONRenderer(),
        foreign_pre_chain=shared_processors,
    )
)

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º root logger —Å –æ–±–æ–∏–º–∏ handler'–∞–º–∏
root = logging.getLogger()
root.handlers = [console_handler, json_handler]

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º structlog
structlog.configure(
    processors=shared_processors + [structlog.stdlib.ProcessorFormatter.wrap_for_formatter],
    logger_factory=structlog.stdlib.LoggerFactory(),
    wrapper_class=structlog.stdlib.BoundLogger,
    cache_logger_on_first_use=True,
)
```

**–í–∞–∂–Ω–æ:**
- `stdout` ‚Üí —Ü–≤–µ—Ç–Ω–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è `docker compose logs`
- `stderr` ‚Üí JSON –¥–ª—è Fluent Bit ‚Üí Loki
- Docker `json-file` –ª–æ–≥–∏—Ä—É–µ—Ç –æ–±–∞ —Å—Ç—Ä–∏–º–∞
- Fluent Bit —á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ JSON (–ø–æ `stream=stderr`)

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ dual-sink –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

- ‚úÖ **–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:** —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, JSON –¥–ª—è –º–∞—à–∏–Ω
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –Ω–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ "–ø–æ —É–¥–∞—á–µ", –Ω–µ—Ç regex-–º–∞–≥–∏–∏
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** Fluent Bit –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ JSON
- ‚úÖ **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å:** `docker compose logs` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–π —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥
- ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:** Loki –ø–æ–ª—É—á–∞–µ—Ç —á–∏—Å—Ç—ã–π JSON –±–µ–∑ —Ü–≤–µ—Ç–Ω—ã—Ö escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π

### –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

–î–ª—è –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è –∫ dual-sink –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö:

1. **model-service** (`model-service/src/config/logging.py`)
2. **feature-service** (`feature-service/src/logging.py`)
3. **position-manager** (`position-manager/src/config/logging.py`)
4. **order-manager** (`order-manager/src/config/logging.py`)
5. **ws-gateway** (`ws-gateway/src/config/logging.py`)

**–®–∞–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:**
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–≤–∞ handler'–∞: `stdout` (—Ü–≤–µ—Ç–Ω–æ–π) –∏ `stderr` (JSON)
2. –î–æ–±–∞–≤–∏—Ç—å –¥–≤–∞ handler'–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ formatter'–∞–º–∏: `ProcessorFormatter` —Å `ConsoleRenderer()` –¥–ª—è stdout –∏ `ProcessorFormatter` —Å `JSONRenderer()` –¥–ª—è stderr
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±–∞ handler'–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ root logger —á–µ—Ä–µ–∑ `root.handlers = [console_handler, json_handler]`

**–í–∞–∂–Ω–æ:** –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ renderer'—ã –Ω–∞–ø—Ä—è–º—É—é –≤ processors structlog - —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ProcessorFormatter` –≤ handler'–∞—Ö.

### –ï–¥–∏–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–í–∞–∂–Ω–æ:** –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –≤ `docker-compose.yml` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∏—Å–∫–∞ –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

–í –ø—Ä–æ–µ–∫—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ —É —á–∞—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤:

- ‚úÖ **ws-gateway**: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
- ‚úÖ **feature-service**: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
- ‚úÖ **position-manager**: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
- ‚ùå **model-service**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏
- ‚ùå **order-manager**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏
- ‚ùå **postgres**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏
- ‚ùå **rabbitmq**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏
- ‚ùå **redis**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏
- ‚ùå **grafana**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏
- ‚ùå **loki**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω)
- ‚ùå **fluent-bit**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω)

#### –¢—Ä–µ–±—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –µ–¥–∏–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤:

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "1m"    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞
    max-file: "3"     # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–æ—Ç–∏—Ä—É–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `max-size: "1m"` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞ (1 –º–µ–≥–∞–±–∞–π—Ç)
- `max-file: "3"` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ (3 —Ñ–∞–π–ª–∞ = ~3 –ú–ë –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∏—Å–∫–∞
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ (~3 –ú–ë –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

#### –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

–î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ü–∏—é `logging` –≤ `docker-compose.yml` –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:

1. **model-service** (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 200):
   ```yaml
   logging:
     driver: "json-file"
     options:
       max-size: "1m"
       max-file: "3"
   ```

2. **order-manager** (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 394):
   ```yaml
   logging:
     driver: "json-file"
     options:
       max-size: "1m"
       max-file: "3"
   ```

3. **postgres** (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 63):
   ```yaml
   logging:
     driver: "json-file"
     options:
       max-size: "1m"
       max-file: "3"
   ```

4. **rabbitmq** (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 85):
   ```yaml
   logging:
     driver: "json-file"
     options:
       max-size: "1m"
       max-file: "3"
   ```

5. **redis** (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 100):
   ```yaml
   logging:
     driver: "json-file"
     options:
       max-size: "1m"
       max-file: "3"
   ```

6. **grafana** (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 494):
   ```yaml
   logging:
     driver: "json-file"
     options:
       max-size: "1m"
       max-file: "3"
   ```

7. **loki** (–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω, –ø–æ—Å–ª–µ healthcheck):
   ```yaml
   logging:
     driver: "json-file"
     options:
       max-size: "1m"
       max-file: "3"
   ```

8. **fluent-bit** (–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω, —É–∂–µ –∏–º–µ–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å):
   ```yaml
   logging:
     driver: "json-file"
     options:
       max-size: "1m"
       max-file: "3"
   ```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

–î–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –±–æ–ª—å—à–∏–º –æ–±—ä–µ–º–æ–º –ª–æ–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ws-gateway`, `model-service`) –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç—ã:

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"   # 10 –ú–ë –Ω–∞ —Ñ–∞–π–ª
    max-file: "5"     # 5 —Ñ–∞–π–ª–æ–≤ = ~50 –ú–ë –º–∞–∫—Å–∏–º—É–º
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ `max-size: "1m"` –∏ `max-file: "3"`
- –î–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `max-size: "10m"` –∏ `max-file: "5"`
- –î–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (postgres, rabbitmq) –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Fluent Bit

**–†–æ–ª—å:** –°–±–æ—Ä—â–∏–∫ –ª–æ–≥–æ–≤ –∏–∑ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Docker socket —Ö–æ—Å—Ç–∞
- –ß–∏—Ç–∞–µ—Ç –ª–æ–≥–∏ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏–∑ —Ñ–∞–π–ª–æ–≤ Docker (`json-file` driver)
- **–§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ `stream=stderr`** (JSON –ª–æ–≥–∏ –æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)
- –ü–∞—Ä—Å–∏—Ç JSON –∏–∑ –ø–æ–ª—è `log` –≤ Docker JSON-–æ–±–µ—Ä—Ç–∫–µ
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ Docker API
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –≤ Loki —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ labels

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –†–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ docker-compose
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∏–¥–∏—Ç –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö

### 2. Loki

**–†–æ–ª—å:** –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ª–æ–≥–æ–≤

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ª–æ–≥–æ–≤ (–Ω–µ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∫–∞–∫ Elasticsearch)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ç–∫–∏ (labels) –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç LogQL (—è–∑—ã–∫ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ PromQL)
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫

### 3. Grafana

**–†–æ–ª—å:** –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ó–∞–ø—Ä–æ—Å—ã LogQL –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–æ–∏—Å–∫–∞
- –î–∞—à–±–æ—Ä–¥—ã —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏
- –ê–ª–µ—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–æ–≥–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞—à–±–æ—Ä–¥–∞–º–∏ Grafana

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –®–∞–≥ 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ docker-compose.yml

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –≤ `docker-compose.yml`:

```yaml
  # Loki - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ª–æ–≥–æ–≤
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "${LOKI_PORT:-4440}:3100"
    volumes:
      - ./loki/config:/etc/loki
      - loki_data:/loki
    command: -config.file=/etc/loki/loki-config.yaml
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –æ–±—Ä–∞–∑ grafana/loki –º–æ–∂–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç—å wget
      # –ï—Å–ª–∏ healthcheck –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ wget –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ curl
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Fluent Bit - —Å–±–æ—Ä—â–∏–∫ –ª–æ–≥–æ–≤
  fluent-bit:
    image: fluent/fluent-bit:latest
    container_name: fluent-bit
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./fluent-bit/config:/fluent-bit/etc
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - ytrader-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "3"
```

**–í–∞–∂–Ω–æ:** 
- –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `/var/lib/docker/containers` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –ª–æ–≥-—Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `/var/run/docker.sock` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã Docker filter (–ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)

–î–æ–±–∞–≤—å—Ç–µ volume –¥–ª—è Loki –≤ —Å–µ–∫—Ü–∏—é `volumes`:

```yaml
volumes:
  # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ volumes ...
  loki_data:
```

**–í–∞–∂–Ω–æ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–º–µ—é—Ç –µ–¥–∏–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ (—Å–º. —Å–µ–∫—Ü–∏—é "–ï–¥–∏–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤" –≤—ã—à–µ). –ï—Å–ª–∏ —É –∫–∞–∫–∏—Ö-—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–µ–∫—Ü–∏—è `logging`, –¥–æ–±–∞–≤—å—Ç–µ –µ—ë —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ `max-size: "1m"` –∏ `max-file: "3"`.

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Loki

–°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```bash
mkdir -p loki/config
```

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `loki/config/loki-config.yaml`:

```yaml
auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096

common:
  instance_addr: 127.0.0.1
  path_prefix: /loki
  storage:
    filesystem:
      chunks_directory: /loki/chunks
      rules_directory: /loki/rules
  replication_factor: 1
  ring:
    kvstore:
      store: inmemory

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

ruler:
  alertmanager_url: http://localhost:9093

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è
limits_config:
  reject_old_samples: true
  reject_old_samples_max_age: 168h  # 7 –¥–Ω–µ–π
  retention_period: 168h  # 7 –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç compactor)
  ingestion_rate_mb: 16
  ingestion_burst_size_mb: 32
  max_query_length: 721h
  max_query_parallelism: 32
  max_streams_per_user: 10000
  max_line_size: 256KB

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∂–∞—Ç–∏—è –∏ retention
# –í–ê–ñ–ù–û: Retention –≤ Loki —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º compactor
# –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ filesystem –∏–ª–∏ object storage (S3, GCS –∏ —Ç.–¥.)
# –ë–µ–∑ compactor retention_period –≤ limits_config –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
compactor:
  working_directory: /loki/compactor
  shared_store: filesystem
  compaction_interval: 10m
  retention_enabled: true
  retention_delete_delay: 2h
  retention_delete_worker_count: 150
```

### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Fluent Bit

–°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```bash
mkdir -p fluent-bit/config
```

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `fluent-bit/config/fluent-bit.conf`:

```ini
[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     4441  # –ü–æ—Ä—Ç –¥–ª—è –º–µ—Ç—Ä–∏–∫ Fluent Bit (–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ observability)

# –ß—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∏–∑ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*-json.log
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Skip_Empty_Lines  On
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å —Ñ–∞–π–ª–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è container_id
    Path_Key          file_path

# –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑ Docker API
# –í–ê–ñ–ù–û: Docker filter –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–û grep, —Ç–∞–∫ –∫–∞–∫:
# - –æ–Ω –æ–∂–∏–¥–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π Docker JSON —Ñ–æ—Ä–º–∞—Ç
# - –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–ø–∏—Å–∏
# - –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø–æ–ª–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –¥–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
# Docker filter –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
# - –∏–∑–≤–ª–µ–∫–∞–µ—Ç container_id –∏–∑ –ø—É—Ç–∏ —Ñ–∞–π–ª–∞
# - –¥–æ–±–∞–≤–ª—è–µ—Ç container_name –ø–æ container_id —á–µ—Ä–µ–∑ Docker API
# - –¥–æ–±–∞–≤–ª—è–µ—Ç –¥—Ä—É–≥–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
[FILTER]
    Name                docker
    Match               docker.*
    # Docker filter –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç container_id –∏ container_name
    # –¢—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ /var/run/docker.sock (—É–∂–µ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤ docker-compose.yml)

# –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ stderr (JSON –ª–æ–≥–∏)
# stdout —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–≤–µ—Ç–Ω–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è docker compose logs
# stderr —Å–æ–¥–µ—Ä–∂–∏—Ç JSON –¥–ª—è Fluent Bit ‚Üí Loki
# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ü–û–°–õ–ï docker filter –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
[FILTER]
    Name                grep
    Match               docker.*
    Regex               stream stderr

# –ü–∞—Ä—Å–∏–Ω–≥ JSON-–ª–æ–≥–æ–≤ –∏–∑ structlog
[FILTER]
    Name                parser
    Match               docker.*
    Key_Name            log
    Parser              json
    Reserve_Data        On
    Preserve_Key        On

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –∏–∑ JSON
[FILTER]
    Name                nest
    Match               docker.*
    Operation           lift
    Nested_under        log
    Add_prefix          log_

# –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
[FILTER]
    Name                modify
    Match               docker.*
    Rename              log_service_name service
    Rename              log_level level
    Rename              log_trace_id trace_id
    Rename              log_event event
    Rename              log_message message
    # –í–ê–ñ–ù–û: log_timestamp –ù–ï –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –≤ timestamp,
    # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å –ø–æ–ª–µ–º time –∏–∑ Docker JSON
    # Loki –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å timestamp –∏–∑ JSON –ª–æ–≥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

# –†–µ–∑–µ—Ä–≤–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è container_name (–µ—Å–ª–∏ Docker filter –Ω–µ –¥–æ–±–∞–≤–∏–ª)
# –û–±—ã—á–Ω–æ Docker filter –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç container_name,
# –Ω–æ –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
[FILTER]
    Name                modify
    Match               docker.*
    # –ï—Å–ª–∏ container_name –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Docker filter, –∏—Å–ø–æ–ª—å–∑—É–µ–º container_id
    Condition_Key      container_name
    Condition          Key_Does_Not_Exist
    Set                container_name ${container_id}

# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Loki —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ labels
[OUTPUT]
    Name        loki
    Match       docker.*
    Host        loki
    Port        3100
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: labels –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –≤ Loki
    # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ –Ω–∏–∑–∫–æ–∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    Labels      job=docker,container_name=$container_name
    # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è (level, trace_id) –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Line_Format, –Ω–µ –≤ labels
    # –§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞ (JSON –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤)
    Line_Format json
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ timestamp –∏–∑ JSON –ª–æ–≥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ–ª–µ timestamp –≤ structlog)
    # –í–ê–ñ–ù–û: Time_Format –¥–æ–ª–∂–µ–Ω —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—É timestamp –≤ JSON
    # structlog –ø–∏—à–µ—Ç ISO 8601 —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º Z (UTC) –∏–ª–∏ offset: 2025-12-20T12:34:56.789Z
    # Fluent Bit –Ω–µ —É–º–µ–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç—å Z, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç
    # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Z (UTC): %Y-%m-%dT%H:%M:%S.%LZ
    # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è offset: %Y-%m-%dT%H:%M:%S.%L%z
    # –î–ª—è structlog –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Z, –ø–æ—ç—Ç–æ–º—É —Ñ–æ—Ä–º–∞—Ç: %Y-%m-%dT%H:%M:%S.%LZ
    Time_Key timestamp
    Time_Format %Y-%m-%dT%H:%M:%S.%LZ
    Auto_Kubernetes_Labels off
```

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `fluent-bit/config/parsers.conf`:

```ini
[PARSER]
    Name        docker
    Format      json
    Time_Key    time
    Time_Format %Y-%m-%dT%H:%M:%S.%L
    Time_Keep   On
    Decode_Field_As   escaped_utf8    log    do_next
    Decode_Field_As   escaped         log

# –ü–∞—Ä—Å–µ—Ä—ã docker_no_time –∏ docker_no_time_parse –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ fallback
# –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º —Å –æ—Å–Ω–æ–≤–Ω—ã–º docker –ø–∞—Ä—Å–µ—Ä–æ–º (–≤ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
[PARSER]
    Name        docker_no_time
    Format      json
    Time_Keep   Off
    Decode_Field_As   escaped_utf8    log    do_next
    Decode_Field_As   escaped         log

[PARSER]
    Name        docker_no_time_parse
    Format      json
    Time_Keep   Off
    Decode_Field_As   escaped_utf8    log    do_next
    Decode_Field_As   escaped         log

[PARSER]
    Name        json
    Format      json
    Time_Key    timestamp
    # structlog –ø–∏—à–µ—Ç ISO 8601 —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º Z (UTC) –∏–ª–∏ offset: 2025-12-20T12:34:56.789Z
    # Fluent Bit –Ω–µ —É–º–µ–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç—å Z, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç
    # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Z (UTC): %Y-%m-%dT%H:%M:%S.%LZ
    # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è offset: %Y-%m-%dT%H:%M:%S.%L%z
    # –î–ª—è structlog –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Z, –ø–æ—ç—Ç–æ–º—É —Ñ–æ—Ä–º–∞—Ç: %Y-%m-%dT%H:%M:%S.%LZ
    Time_Format %Y-%m-%dT%H:%M:%S.%LZ
    Time_Keep   On
```

**–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:**

1. **–î–æ—Å—Ç—É–ø –∫ –ª–æ–≥-—Ñ–∞–π–ª–∞–º:** Fluent Bit –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ `/var/lib/docker/containers` –Ω–∞ —Ö–æ—Å—Ç–µ. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º Docker socket –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ª–æ–≥–∞–º–∏ –≤ `docker-compose.yml`.

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ stream:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä `grep` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ `stream=stderr`. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤ Loki –ø–æ–ø–∞–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ JSON, –∞ —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –∏–∑ stdout –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.

3. **Dual-sink –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–∏—à—É—Ç **—Ü–≤–µ—Ç–Ω–æ–π** –≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ `structlog.dev.ConsoleRenderer()` –≤ **stdout** (–¥–ª—è `docker compose logs`)
   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–∏—à—É—Ç **JSON** —á–µ—Ä–µ–∑ `structlog.processors.JSONRenderer()` –≤ **stderr** (–¥–ª—è Fluent Bit ‚Üí Loki)
   - Docker driver `json-file` –ª–æ–≥–∏—Ä—É–µ—Ç –æ–±–∞ —Å—Ç—Ä–∏–º–∞ —Å –ø–æ–ª–µ–º `stream` (stdout/stderr)
   - Fluent Bit —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ `stream=stderr` –∏ –ø–∞—Ä—Å–∏—Ç JSON –∏–∑ –ø–æ–ª—è `log`
   - –í–Ω—É—Ç—Ä–∏ `log` –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç structlog (–ø–æ–ª—è: `level`, `trace_id`, `event`, `message`, –∏ —Ç.–¥.)

4. **Docker socket –∏ —Ñ–∞–π–ª—ã:** Fluent Bit –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞:
   - **Docker socket** (`/var/run/docker.sock`) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ Docker filter (container_name, container_id)
   - **–§–∞–π–ª—ã** (`/var/lib/docker/containers`) - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –¥–ª—è —á—Ç–µ–Ω–∏—è –ª–æ–≥–æ–≤
   - –≠—Ç–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: socket –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è metadata, –ª–æ–≥–∏ —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ —Ñ–∞–π–ª–æ–≤

5. **Docker filter:** –§–∏–ª—å—Ç—Ä `docker` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Docker API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è `container_name`). –ï—Å–ª–∏ –æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, `container_name` –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `container_id` –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.

6. **Labels –≤ Loki:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ –Ω–∏–∑–∫–æ–∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω—ã–µ labels (`job`, `container_name`). –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è (`level`, `trace_id`) –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–µ–ª–µ –ª–æ–≥–∞, –Ω–µ –≤ labels, –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Loki

–î–æ–±–∞–≤—å—Ç–µ Loki –∫–∞–∫ data source –≤ Grafana. –û–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª `grafana/provisioning/datasources/datasources.yml`:

```yaml
datasources:
  # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ data sources ...
  
  # Loki Data Source –¥–ª—è –ª–æ–≥–æ–≤
  - name: Loki
    uid: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    jsonData:
      maxLines: 1000
      # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: derivedFields –¥–ª—è trace_id –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è,
      # —Ç–∞–∫ –∫–∞–∫ trace_id –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ JSON, –∞ –Ω–µ –≤ plain text
      # –î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Tempo –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
    isDefault: false
```

### –®–∞–≥ 5: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `env.example`:

```bash
# =============================================================================
# Loki Logging Configuration
# =============================================================================
# Loki HTTP API port (non-standard port starting from 4440)
LOKI_PORT=4440

# Fluent Bit HTTP API port for metrics (non-standard port, reserved for observability)
FLUENT_BIT_HTTP_PORT=4441

# Fluent Bit HTTP API port for metrics (non-standard port, reserved for observability)
FLUENT_BIT_HTTP_PORT=4441
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ docker compose

–ö–æ–º–∞–Ω–¥–∞ `docker compose logs` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **—Ü–≤–µ—Ç–Ω–æ–π** –≤—ã–≤–æ–¥ –∏–∑ stdout:

```bash
# –í—Å–µ –ª–æ–≥–∏
docker compose logs

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
docker compose logs ws-gateway

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ —Å follow
docker compose logs --tail 100 -f model-service
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
INFO  [ws-gateway] request completed trace_id=abc123
ERROR [model-service] model timeout trace_id=def456
```

**–í–∞–∂–Ω–æ:** `docker compose logs` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±–∞ –ø–æ—Ç–æ–∫–∞ (stdout –∏ stderr), –Ω–æ JSON –∏–∑ stderr –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–æ–º –∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è Loki. –î–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é:

```bash
# –¢–æ–ª—å–∫–æ stdout (—Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥)
docker compose logs ws-gateway 2>/dev/null

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å grep –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ JSON
docker compose logs ws-gateway | grep -v '"level"'
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ Grafana

1. –û—Ç–∫—Ä–æ–π—Ç–µ Grafana: `http://localhost:4700` (–ø–æ—Ä—Ç –∏–∑ docker-compose.yml: `GRAFANA_PORT`)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Explore** (–∏–∫–æ–Ω–∫–∞ –∫–æ–º–ø–∞—Å–∞ —Å–ª–µ–≤–∞)
3. –í—ã–±–µ—Ä–∏—Ç–µ data source **Loki**
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ LogQL –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ Grafana/Loki:**
```json
{
  "level": "error",
  "service": "model-service",
  "trace_id": "def456",
  "event": "model_timeout",
  "message": "model timeout",
  "timestamp": "2025-01-27T10:30:45.123Z"
}
```

**–í–∞–∂–Ω–æ:** Grafana/Loki –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ JSON –ª–æ–≥–∏ –∏–∑ stderr. –¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –∏–∑ stdout –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Loki –±–ª–∞–≥–æ–¥–∞—Ä—è —Ñ–∏–ª—å—Ç—Ä—É `grep stream stderr` –≤ Fluent Bit.

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ LogQL

**–í–∞–∂–Ω–æ:** –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç labels `job=docker` –∏ `container_name`, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ Fluent Bit OUTPUT.

#### –í—Å–µ –ª–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å

```logql
{job="docker"}
```

#### –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

```logql
{job="docker", container_name="ws-gateway"}
```

#### –õ–æ–≥–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```logql
{job="docker", container_name=~"ws-gateway|model-service|order-manager"}
```

#### –õ–æ–≥–∏ —Å —É—Ä–æ–≤–Ω–µ–º ERROR (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ JSON-–ø–æ–ª—é)

```logql
{job="docker"} | json | level="ERROR"
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ JSON-–ø–æ–ª—è–º (`| json | level="ERROR"`) –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ (`|= "ERROR"`). –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ - —Ç–æ–ª—å–∫–æ fallback –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ JSON –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è.

#### –õ–æ–≥–∏ —Å —É—Ä–æ–≤–Ω–µ–º ERROR (fallback - —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫)

```logql
{job="docker"} |= "ERROR"
```

#### –õ–æ–≥–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º trace_id

```logql
{job="docker"} | json | trace_id="abc123"
```

#### –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ JSON-–ø–æ–ª—è–º

```logql
{job="docker", container_name="model-service"} | json | level="ERROR" | message=~".*signal.*"
```

#### –ü–æ–¥—Å—á–µ—Ç –ª–æ–≥–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º (–∞–≥—Ä–µ–≥–∞—Ü–∏—è)

```logql
sum by (level) (count_over_time({job="docker"} | json [5m]))
```

#### –ü–æ–¥—Å—á–µ—Ç –ª–æ–≥–æ–≤ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º

```logql
sum by (container_name) (count_over_time({job="docker"} [1h]))
```

#### –õ–æ–≥–∏ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ —Å–µ—Ä–≤–∏—Å—É –∏ —É—Ä–æ–≤–Ω—é

```logql
sum by (container_name, level) (count_over_time({job="docker"} | json [1h]))
```

#### –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏

```logql
{job="docker", container_name="order-manager"} |= "insufficient balance"
```

#### –õ–æ–≥–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —É—Å–ª–æ–≤–∏—è–º

```logql
{job="docker"} | json | level="ERROR" | message=~".*error.*" | trace_id=~".+"
```

### –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–æ–≤ –≤ Grafana

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥: **Dashboards ‚Üí New Dashboard**
2. –î–æ–±–∞–≤—å—Ç–µ –ø–∞–Ω–µ–ª—å: **Add ‚Üí Visualization**
3. –í—ã–±–µ—Ä–∏—Ç–µ data source **Loki**
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–ø—Ä–æ—Å LogQL
5. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (Logs, Time series, Table –∏ —Ç.–¥.)

#### –ü—Ä–∏–º–µ—Ä –ø–∞–Ω–µ–ª–∏: –õ–æ–≥–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º

**Query:**
```logql
sum by (level) (count_over_time({job="docker"} | json [5m]))
```

**Visualization:** Time series
**Legend:** `{{level}}`

#### –ü—Ä–∏–º–µ—Ä –ø–∞–Ω–µ–ª–∏: –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏

**Query:**
```logql
{job="docker"} | json | level="ERROR"
```

**Visualization:** Logs
**Limit:** 100

#### –ü—Ä–∏–º–µ—Ä –ø–∞–Ω–µ–ª–∏: –õ–æ–≥–∏ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º

**Query:**
```logql
sum by (container_name) (count_over_time({job="docker"} [1h]))
```

**Visualization:** Bar chart
**Legend:** `{{container_name}}`

#### –ü—Ä–∏–º–µ—Ä –ø–∞–Ω–µ–ª–∏: –û—à–∏–±–∫–∏ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º

**Query:**
```logql
sum by (container_name) (count_over_time({job="docker"} | json | level="ERROR" [5m]))
```

**Visualization:** Time series
**Legend:** `{{container_name}}`

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose ps

# –õ–æ–≥–∏ Fluent Bit
docker compose logs fluent-bit

# –õ–æ–≥–∏ Loki
docker compose logs loki

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Loki
curl http://localhost:4440/ready
```

### –ú–µ—Ç—Ä–∏–∫–∏ Fluent Bit

Fluent Bit –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ –ø–æ—Ä—Ç—É 4441:

```bash
curl http://localhost:4441/api/v1/metrics
```

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

Loki –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `retention_period` –≤ `loki-config.yaml`) –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º compactor (–Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤—ã—à–µ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏).

–î–ª—è —Ä—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏:

```bash
# –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Loki
docker compose exec loki sh

# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (–≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
# Loki –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç retention, –Ω–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä
du -sh /loki/chunks
```

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ volume `loki_data`. –î–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Loki
docker compose stop loki

# –°–æ–∑–¥–∞—Ç—å backup
docker run --rm -v ytrader_loki_data:/data -v $(pwd):/backup alpine tar czf /backup/loki-backup-$(date +%Y%m%d).tar.gz /data

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Loki
docker compose start loki
```

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ:** –ü–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Å–∏—Å—Ç–µ–º—ã.

### 1. Time_Format –º–æ–∂–µ—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å ISO 8601 Z ‚Üí –æ—à–∏–±–∫–∏ timestamp

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç timestamp –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `Time_Format` –≤ Fluent Bit OUTPUT, Loki –º–æ–∂–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- ISO 8601 —Å Z (UTC) –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞ –±–µ–∑ Z –∏–ª–∏ —Å offset

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `Time_Format` –≤ OUTPUT –∏ –ø–∞—Ä—Å–µ—Ä–µ JSON —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É –ø–æ–ª—è `timestamp` –≤ JSON –ª–æ–≥–∞—Ö
- structlog –ø–∏—à–µ—Ç ISO 8601 —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º Z (UTC): `2025-12-20T12:34:56.789Z`
- Fluent Bit –Ω–µ —É–º–µ–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç—å Z, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å: `%Y-%m-%dT%H:%M:%S.%LZ`
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è offset –≤–º–µ—Å—Ç–æ Z: `%Y-%m-%dT%H:%M:%S.%L%z`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç timestamp –≤ –ª–æ–≥–∞—Ö
docker compose logs ws-gateway | head -1 | jq -r '.timestamp'
# –°—Ä–∞–≤–Ω–∏—Ç–µ —Å Time_Format –≤ fluent-bit.conf
```

### 2. Docker filter –º–æ–∂–µ—Ç –Ω–µ –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ ‚Üí labels –ø—É—Å—Ç—ã–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ Docker filter –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Docker socket –∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ —É–¥–∞–ª–µ–Ω, `container_name` –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º
- –≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø—É—Å—Ç—ã–º labels –≤ Loki –∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –ø–æ —Å–µ—Ä–≤–∏—Å—É

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `/var/run/docker.sock` —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ Fluent Bit –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Ö –ª–æ–≥–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å `container_id` (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ Docker socket
docker compose exec fluent-bit ls -la /var/run/docker.sock

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ docker filter
curl http://localhost:4441/api/v1/metrics | grep docker_filter
```

### 3. –ñ—ë—Å—Ç–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è stream=stderr ‚Üí –ø–æ—Ç–µ—Ä—è JSON –∏–∑ stdout

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ –æ—à–∏–±–∫–µ –ø–∏—à–µ—Ç JSON –≤ stdout –≤–º–µ—Å—Ç–æ stderr, –ª–æ–≥–∏ –Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ Loki
- –§–∏–ª—å—Ç—Ä `grep stream stderr` –∂–µ—Å—Ç–∫–æ –æ—Ç—Å–µ–∫–∞–µ—Ç –≤—Å–µ –ª–æ–≥–∏ –∏–∑ stdout

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ dual-sink –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- JSON –¥–æ–ª–∂–µ–Ω –ø–∏—Å–∞—Ç—å—Å—è **—Ç–æ–ª—å–∫–æ** –≤ stderr
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ Fluent Bit –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ª–æ–≥–æ–≤

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∏—à–µ—Ç JSON –≤ stderr
docker compose exec ws-gateway sh -c 'python -c "import sys; print(\"test\", file=sys.stderr)"'
docker compose logs ws-gateway | grep '"level"'
```

### 4. –ü–∞—Ä—Å–µ—Ä JSON –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å –Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON (–Ω–∞–ø—Ä–∏–º–µ—Ä, stack trace –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è), –ø–∞—Ä—Å–µ—Ä –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
- –≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–æ—Ç–µ—Ä–µ –ª–æ–≥–æ–≤ –∏–ª–∏ –æ—à–∏–±–∫–∞–º –≤ Fluent Bit

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `Reserve_Data On` –∏ `Preserve_Key On` –≤ –ø–∞—Ä—Å–µ—Ä–µ (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è JSON
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏
curl http://localhost:4441/api/v1/metrics | grep parser_errors
```

### 5. Retention Loki —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º compactor

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ compactor –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, `retention_period` –≤ `limits_config` –Ω–µ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è
- –õ–æ–≥–∏ –±—É–¥—É—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è –∏ –∑–∞–ø–æ–ª–Ω—è—Ç—å –¥–∏—Å–∫

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ compactor –≤–∫–ª—é—á–µ–Ω (`retention_enabled: true`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è filesystem –∏–ª–∏ object storage (S3, GCS)
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö Loki

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å compactor
docker compose logs loki | grep compactor

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
docker compose exec loki du -sh /loki/chunks
```

### 6. –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `max-size` –∏ `max-file` —Å–ª–∏—à–∫–æ–º –º–∞–ª—ã, –ª–æ–≥–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ Fluent Bit –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç
- –û—Å–æ–±–µ–Ω–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–Ω–∏–º—É–º `max-size: "1m"` –∏ `max-file: "3"` –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
- –î–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —É–≤–µ–ª–∏—á—å—Ç–µ –¥–æ `max-size: "10m"` –∏ `max-file: "5"`
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ Fluent Bit –Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
curl http://localhost:4441/api/v1/metrics | grep input_tail
# –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –±—É—Ñ–µ—Ä—ã –∏ –∑–∞–¥–µ—Ä–∂–∫–∏
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É

–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ:

1. **–ú–µ—Ç—Ä–∏–∫–∏ Fluent Bit:**
   ```bash
   curl http://localhost:4441/api/v1/metrics
   ```
   - –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞
   - –ó–∞–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–æ–≤

2. **–ú–µ—Ç—Ä–∏–∫–∏ Loki:**
   ```bash
   curl http://localhost:4440/metrics
   ```
   - –†–∞–∑–º–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
   - –°—Ç–∞—Ç—É—Å compactor
   - –û—à–∏–±–∫–∏ ingestion

3. **–õ–æ–≥–∏ Fluent Bit:**
   ```bash
   docker compose logs fluent-bit | grep -i error
   ```

4. **–õ–æ–≥–∏ Loki:**
   ```bash
   docker compose logs loki | grep -i error
   ```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### Fluent Bit –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –ª–æ–≥–∏

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ Docker socket:
   ```bash
   docker compose exec fluent-bit ls -la /var/run/docker.sock
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ª–æ–≥-—Ñ–∞–π–ª–∞–º:
   ```bash
   docker compose exec fluent-bit ls -la /var/lib/docker/containers | head -5
   ```
   –ï—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ volume —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤ `docker-compose.yml`.

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Fluent Bit:
   ```bash
   docker compose logs fluent-bit
   ```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
   ```bash
   docker compose exec fluent-bit cat /fluent-bit/etc/fluent-bit.conf
   ```

5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ Fluent Bit:
   ```bash
   curl http://localhost:4441/api/v1/metrics
   ```
   –ò—â–∏—Ç–µ —Å–µ–∫—Ü–∏—é `input_tail` - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è `records` –∏ `bytes`.

### Loki –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª–æ–≥–∏

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Loki:
   ```bash
   curl http://localhost:4440/ready
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Loki:
   ```bash
   docker compose logs loki
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ Fluent Bit:
   ```bash
   docker compose exec fluent-bit wget -O- http://loki:3100/ready
   ```

### –õ–æ–≥–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ Grafana

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ data source –≤ Grafana:
   - Settings ‚Üí Data sources ‚Üí Loki
   - Test connection

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—Ä–æ—Å LogQL:
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å: `{job="docker"}` (–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –ª–æ–≥–∏)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ labels –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ Fluent Bit OUTPUT

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω:
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –≤—Ä–µ–º–µ–Ω–∏

### JSON-–ª–æ–≥–∏ –Ω–µ –ø–∞—Ä—Å—è—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ –≤ stdout (–¥–ª—è docker compose logs):
   ```bash
   docker compose logs ws-gateway | head -5
   ```
   –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω —Ü–≤–µ—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥ (–Ω–µ —á–∏—Å—Ç—ã–π JSON).

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ –≤ stderr (–¥–ª—è Loki):
   ```bash
   # –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—ã—Ä–æ–≥–æ JSON –æ—Ç Docker –¥–ª—è stderr
   docker compose exec fluent-bit cat /var/lib/docker/containers/*/$(docker ps -q -f name=ws-gateway)*-json.log | grep '"stream":"stderr"' | head -1 | jq
   ```
   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–Ω–æ JSON-–æ–±–µ—Ä—Ç–∫—É Docker —Å –ø–æ–ª—è–º–∏:
   - `stream: "stderr"` - –ø–æ—Ç–æ–∫ –¥–ª—è JSON –ª–æ–≥–æ–≤
   - `log: "{...}"` - JSON —Å—Ç—Ä–æ–∫–∞ –æ—Ç structlog —Å –ø–æ–ª—è–º–∏ `level`, `trace_id`, `event`, `message`

3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è dual-sink –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–æ–±–∞** renderer'–∞:
     - `structlog.dev.ConsoleRenderer()` –¥–ª—è **stdout** (—Ü–≤–µ—Ç–Ω–æ–π)
     - `structlog.processors.JSONRenderer()` –¥–ª—è **stderr** (JSON)
   - –û–±–∞ handler'–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ `logging.basicConfig()`

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä stream –≤ Fluent Bit:
   ```bash
   docker compose exec fluent-bit grep -A 2 "grep" /fluent-bit/etc/fluent-bit.conf
   ```
   –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä `grep` —Å `Regex stream stderr` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ JSON –ª–æ–≥–æ–≤.

5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä—Å–µ—Ä –≤ Fluent Bit:
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä JSON
   - –ü–∞—Ä—Å–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–∑–≤–ª–µ–∫–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª—è `log` –≤ Docker JSON-–æ–±–µ—Ä—Ç–∫–µ
   - –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ `stream=stderr` –≤ –ø–æ–ª–µ `log` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π JSON

6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞:
   ```bash
   curl http://localhost:4441/api/v1/metrics | grep parser
   ```

### Labels –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ Loki

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é OUTPUT –≤ Fluent Bit:
   ```bash
   docker compose exec fluent-bit grep -A 10 "\[OUTPUT\]" /fluent-bit/etc/fluent-bit.conf
   ```
   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–ª–∞–≥–∏–Ω `loki` (–Ω–µ `http`) –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã `Labels`.

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ container_name —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:
   ```bash
   docker compose exec fluent-bit cat /fluent-bit/etc/fluent-bit.conf | grep container_name
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ Loki:
   ```bash
   curl http://localhost:4440/metrics | grep loki_ingester
   ```

## –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤ (–µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º)

–ï—Å–ª–∏ Fluent Bit –Ω–µ –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é (–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ `/var/lib/docker/containers`), –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω `forward` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤ –æ—Ç –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–±–æ—Ä —á–µ—Ä–µ–∑ Docker API.

**–í–∞–∂–Ω–æ:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± - –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `/var/lib/docker/containers` (–∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏), —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –∏ –Ω–∞–¥–µ–∂–µ–Ω.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retention –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

Loki –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ retention –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–µ—Ç–æ–∫. –û–±–Ω–æ–≤–∏—Ç–µ `loki-config.yaml`:

```yaml
limits_config:
  retention_period: 168h  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 –¥–Ω–µ–π
  per_stream_rate_limit: 3MB
  per_stream_rate_limit_burst: 15MB
  split_queries_by_interval: 15m
  max_query_series: 500
  max_query_parallelism: 32
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–æ–≥–æ–≤

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `loki/config/rules/alerts.yaml`:

```yaml
groups:
  - name: log_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: |
          # –û–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–µ–º count_over_time (–±–æ–ª–µ–µ —Ç–∏–ø–∏—á–Ω–æ –¥–ª—è Loki)
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: sum(rate({job="docker"} | json | level="ERROR" [5m])) > 10
          sum(count_over_time({job="docker"} | json | level="ERROR" [5m])) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors/sec"
```

### –î–∞—à–±–æ—Ä–¥—ã Grafana

–î–ª—è –ø–∞–Ω–µ–ª–µ–π —Å –ª–æ–≥–∞–º–∏ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ª–æ–≥–æ–≤ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º "raise,error,fail".

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- **Fluent Bit:** 100-200 MB RAM, 0.1 CPU
- **Loki:** 1-2 GB RAM –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã (–º–∏–Ω–∏–º—É–º 1 GB –¥–ª—è filesystem + compactor, –∏–Ω–∞—á–µ compactor –±—É–¥–µ—Ç OOM'–∏—Ç—å—Å—è), 0.5-1 CPU
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ:** ~100 MB –Ω–∞ 1 GB –ª–æ–≥–æ–≤ (—Å–∂–∞—Ç–∏–µ)

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

1. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ –ª–æ–≥–æ–≤:**
   - **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –µ–¥–∏–Ω—É—é —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ `docker-compose.yml`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `max-size: "1m"` –∏ `max-file: "3"` –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
   - –î–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —É–≤–µ–ª–∏—á—å—Ç–µ –¥–æ `max-size: "10m"` –∏ `max-file: "5"`
   - –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ (~3-50 –ú–ë –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ Fluent Bit:**
   - –î–æ–±–∞–≤—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–Ω—É–∂–Ω—ã—Ö –ª–æ–≥–æ–≤
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `exclude` –≤ –ø–∞—Ä—Å–µ—Ä–∞—Ö

3. **Retention –≤ Loki:**
   - –£–º–µ–Ω—å—à–∏—Ç–µ `retention_period` –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ retention –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Loki](https://grafana.com/docs/loki/latest/)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Fluent Bit](https://docs.fluentbit.io/)
- [LogQL Query Language](https://grafana.com/docs/loki/latest/logql/)
- [Grafana Logs Panel](https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/logs/)

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:
   ```bash
   docker compose logs fluent-bit loki grafana
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ Fluent Bit:
   ```bash
   curl http://localhost:4441/api/v1/metrics
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å Loki:
   ```bash
   curl http://localhost:4440/ready
   curl http://localhost:4440/metrics
   ```

