# Рекомендации по повышению качества модели

## Текущее состояние

**Метрики качества:**
- Validation accuracy: 0.184 (18.4%)
- Test accuracy: 0.190 (19%)
- ROC AUC: 0.0 (модель не может различить классы)

**Проблемы:**
1. **Признаки все нулевые** - все средние значения признаков = 0.0
2. **Дисбаланс классов** - 48.78% "flat" (0), 30.98% "up" (1), 20.24% "down" (-1)
3. **Маленький threshold** - 0.001 (0.1%) для горизонта 1h может быть слишком строгим

## Внесенные улучшения

### 1. Улучшены гиперпараметры XGBoost ✅

**Было:**
```python
n_estimators: 100
max_depth: 6
learning_rate: 0.1
```

**Стало:**
```python
n_estimators: 300  # Увеличено для лучшего обучения
max_depth: 8       # Глубже для более сложных паттернов
learning_rate: 0.05 # Меньше для более стабильного обучения
min_child_weight: 3
gamma: 0.1
reg_alpha: 0.1     # L1 регуляризация
reg_lambda: 1.0    # L2 регуляризация
eval_metric: "mlogloss"
```

### 2. Добавлена балансировка классов ✅

- Для бинарной классификации: используется `scale_pos_weight`
- Для мультиклассовой классификации: используется `sample_weight` с обратной частотой классов

## Рекомендации для дальнейшего улучшения

### 1. Увеличить threshold для classification target

**Проблема:** Threshold 0.001 (0.1%) слишком маленький для горизонта 1h. Большинство движений меньше этого порога, что приводит к большому количеству "flat" классов.

**Решение:**
- Для горизонта 1h: использовать threshold 0.005 (0.5%) или 0.01 (1%)
- Для горизонта 15m: использовать threshold 0.002 (0.2%)
- Для горизонта 5m: использовать threshold 0.001 (0.1%)
- Для горизонта 1m: использовать threshold 0.0005 (0.05%)

**Как применить:**
При создании датасета через Feature Service API указать:
```json
{
  "target_config": {
    "type": "classification",
    "horizon": 3600,
    "threshold": 0.005
  }
}
```

### 2. Увеличить период обучения

**Проблема:** Текущий период обучения (1 день) слишком мал для качественного обучения.

**Решение:**
Увеличить `MODEL_RETRAINING_TRAIN_PERIOD_DAYS` в `.env`:
```bash
MODEL_RETRAINING_TRAIN_PERIOD_DAYS=30  # Вместо 1
MODEL_RETRAINING_VALIDATION_PERIOD_DAYS=7
MODEL_RETRAINING_TEST_PERIOD_DAYS=1
```

### 3. Исследовать нулевые признаки ✅

**Проблема:** Все признаки имеют среднее значение 0.0, что означает, что модель не может учиться.

**Причина найдена:** ❌ **Данные trades и orderbook отсутствуют для периода датасета!**

**Результаты проверки:**
- Период датасета: 2025-11-28 до 2025-12-06
- Данные за этот период: **отсутствуют**
- Данные есть только за 2025-12-07: trades=491, snapshots=1,001

**Решение:**
1. ✅ **Пересобрать датасет для периода с данными** (начиная с 2025-12-07)
2. ✅ **Выполнить backfilling** для исторических периодов (если доступно через API)
3. ✅ **Использовать только признаки на основе klines** (если trades/orderbook недоступны исторически)

### 4. Использовать более длинный горизонт для обучения

**Проблема:** Горизонт 1h может быть слишком длинным для предсказания.

**Решение:**
Попробовать более короткие горизонты:
- 15m - более предсказуемо
- 5m - хороший баланс между предсказуемостью и частотой сигналов
- 1m - слишком шумно, но может работать с правильными признаками

### 5. Добавить feature engineering

**Проблема:** Текущие признаки могут быть недостаточными для предсказания.

**Решение:**
1. Добавить технические индикаторы (RSI, MACD, Bollinger Bands)
2. Добавить lag features (значения признаков на предыдущих шагах)
3. Добавить rolling statistics (mean, std, min, max за окно)
4. Добавить взаимодействия признаков (например, volume * price_change)

### 6. Использовать early stopping

**Проблема:** Модель может переобучаться.

**Решение:**
Добавить early stopping при обучении:
```python
model.fit(
    X_train, y_train,
    eval_set=[(X_val, y_val)],
    early_stopping_rounds=10,
    verbose=False
)
```

### 7. Использовать cross-validation

**Проблема:** Одна валидация может быть недостаточной.

**Решение:**
Использовать time-series cross-validation для оценки качества модели.

## Приоритеты

1. **Критично:** Исследовать нулевые признаки (#3)
2. **Высокий:** Увеличить threshold (#1)
3. **Высокий:** Увеличить период обучения (#2)
4. **Средний:** Попробовать другие горизонты (#4)
5. **Низкий:** Добавить feature engineering (#5)

## Следующие шаги

1. Проверить наличие raw данных (trades/orderbook)
2. Пересобрать датасет с увеличенным threshold (0.005 для 1h)
3. Увеличить период обучения до 30 дней
4. Переобучить модель и проверить качество
5. Если качество все еще низкое, исследовать признаки более детально

