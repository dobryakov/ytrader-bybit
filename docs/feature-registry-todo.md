# Feature Registry: Расширенный набор признаков

## Общая информация

**Дата создания:** 2025-01-XX  
**Статус:** Планирование (не реализовано)  
**Горизонт прогноза:** 5-15 минут (300-900 секунд)  
**Threshold:** 0.001-0.002 (0.1-0.2%)

## Контекст

Текущий feature registry содержит 29 признаков, многие из которых требуют данных, недоступных через бэкфиллинг (trades, orderbook, ticker). Предложенный расширенный набор (~45 признаков) использует только данные, доступные из исторических klines и funding rates через REST API Bybit.

## Доступные источники данных

### Полностью доступны (исторические данные):
- **Klines (свечи)**: `timestamp`, `open`, `high`, `low`, `close`, `volume`, `symbol`
  - Интервалы: 1m, 3m, 5m, 15m, 30m, 60m
  - Полная история доступна через `/v5/market/kline`

- **Funding rates**: `timestamp`, `funding_rate`, `symbol`
  - Обновляется каждые 8 часов
  - Полная история доступна через `/v5/market/funding/history`

### Недоступны (только текущие данные):
- **Trades**: только последние 60 сделок (не исторические)
- **Orderbook**: только текущий snapshot (не исторические)
- **Ticker**: только текущий ticker (не исторические)

## Текущий набор признаков (29) → Удалить (21)

### Удаляемые признаки (недоступны из бэкфиллинга):

#### На основе trades (-11 признаков):
- `vwap_3s`, `vwap_15s`, `vwap_1m`
- `volume_3s`, `volume_15s`, `volume_1m`
- `signed_volume_3s`, `signed_volume_15s`, `signed_volume_1m`
- `buy_sell_volume_ratio`
- `trade_count_3s`
- `net_aggressor_pressure`

#### На основе orderbook (-9 признаков):
- `mid_price`
- `spread_abs`, `spread_rel`
- `depth_bid_top5`, `depth_bid_top10`
- `depth_ask_top5`, `depth_ask_top10`
- `depth_imbalance_top5`

#### На основе ticker (-1 признак):
- `returns_1s`, `returns_3s` (используют ticker, недоступный исторически)

## Расширенный набор признаков (~45 признаков)

### 1. Returns (3 признака)

**Источник:** klines (close prices)

- **`returns_5m`**
  - Описание: Доходность за 5 минут
  - Формула: `(close[t] - close[t-5m]) / close[t-5m]`
  - Lookback: 5m
  - Источник: kline

- **`returns_15m`**
  - Описание: Доходность за 15 минут
  - Формула: `(close[t] - close[t-15m]) / close[t-15m]`
  - Lookback: 15m
  - Источник: kline

- **`returns_1h`**
  - Описание: Доходность за 1 час
  - Формула: `(close[t] - close[t-1h]) / close[t-1h]`
  - Lookback: 1h
  - Источник: kline

**Примечание:** `returns_1m` оставляем из текущего набора.

### 2. Volatility (2 признака)

**Источник:** klines (close prices, std of returns)

- **`volatility_1m`** (оставить из текущего)
  - Описание: Волатильность за 1 минуту (std returns)
  - Lookback: 1m
  - Источник: kline

- **`volatility_5m`** (оставить из текущего)
  - Описание: Волатильность за 5 минут (std returns)
  - Lookback: 5m
  - Источник: kline

### 3. Технические индикаторы: Трендовые (9 признаков)

**Источник:** klines (close prices)

- **`ema_9`**
  - Описание: Экспоненциальная скользящая средняя за 9 периодов
  - Lookback: 9 периодов
  - Источник: kline

- **`ema_21`**
  - Описание: Экспоненциальная скользящая средняя за 21 период
  - Lookback: 21 период
  - Источник: kline

- **`ema_50`**
  - Описание: Экспоненциальная скользящая средняя за 50 периодов
  - Lookback: 50 периодов
  - Источник: kline

- **`sma_20`**
  - Описание: Простая скользящая средняя за 20 периодов
  - Lookback: 20 периодов
  - Источник: kline

- **`sma_50`**
  - Описание: Простая скользящая средняя за 50 периодов
  - Lookback: 50 периодов
  - Источник: kline

- **`price_ema9_ratio`**
  - Описание: Отношение цены к EMA9 (нормализованный тренд)
  - Формула: `close / ema_9`
  - Источник: kline

- **`price_ema21_ratio`**
  - Описание: Отношение цены к EMA21
  - Формула: `close / ema_21`
  - Источник: kline

- **`price_sma20_ratio`**
  - Описание: Отношение цены к SMA20
  - Формула: `close / sma_20`
  - Источник: kline

- **`ema9_ema21_diff`**
  - Описание: Разница между EMA9 и EMA21 (нормализованная)
  - Формула: `(ema_9 - ema_21) / close`
  - Источник: kline

### 4. Технические индикаторы: Momentum (5 признаков)

**Источник:** klines (close prices)

- **`rsi_14`**
  - Описание: Relative Strength Index за 14 периодов
  - Диапазон: 0-100
  - Lookback: 14 периодов
  - Источник: kline

- **`rsi_7`**
  - Описание: RSI за 7 периодов (более чувствительный)
  - Диапазон: 0-100
  - Lookback: 7 периодов
  - Источник: kline

- **`momentum_5`**
  - Описание: Momentum за 5 периодов
  - Формула: `(close[t] - close[t-5]) / close[t-5]`
  - Lookback: 5 периодов
  - Источник: kline

- **`momentum_10`**
  - Описание: Momentum за 10 периодов
  - Формула: `(close[t] - close[t-10]) / close[t-10]`
  - Lookback: 10 периодов
  - Источник: kline

- **`roc_10`**
  - Описание: Rate of Change за 10 периодов
  - Формула: `(close[t] - close[t-10]) / close[t-10] * 100`
  - Lookback: 10 периодов
  - Источник: kline

### 5. Технические индикаторы: Волатильность (7 признаков)

**Источник:** klines (high, low, close)

- **`atr_14`**
  - Описание: Average True Range за 14 периодов
  - Lookback: 14 периодов
  - Источник: kline

- **`atr_7`**
  - Описание: ATR за 7 периодов
  - Lookback: 7 периодов
  - Источник: kline

- **`bb_upper_20`**
  - Описание: Верхняя полоса Боллинджера (20 периодов, 2 сигмы)
  - Формула: `sma_20 + 2 * std(close, 20)`
  - Источник: kline

- **`bb_lower_20`**
  - Описание: Нижняя полоса Боллинджера (20 периодов, 2 сигмы)
  - Формула: `sma_20 - 2 * std(close, 20)`
  - Источник: kline

- **`bb_width_20`**
  - Описание: Ширина полос Боллинджера (20 периодов)
  - Формула: `(bb_upper_20 - bb_lower_20) / sma_20`
  - Источник: kline

- **`bb_upper_10`**
  - Описание: Верхняя полоса Боллинджера (10 периодов, 2 сигмы)
  - Источник: kline

- **`bb_lower_10`**
  - Описание: Нижняя полоса Боллинджера (10 периодов, 2 сигмы)
  - Источник: kline

- **`bb_width_10`**
  - Описание: Ширина полос Боллинджера (10 периодов)
  - Источник: kline

### 6. Технические индикаторы: MACD (3 признака)

**Источник:** klines (close prices)

- **`macd`**
  - Описание: MACD линия (12, 26, 9)
  - Формула: `ema(close, 12) - ema(close, 26)`
  - Источник: kline

- **`macd_signal`**
  - Описание: Сигнальная линия MACD
  - Формула: `ema(macd, 9)`
  - Источник: kline

- **`macd_histogram`**
  - Описание: Гистограмма MACD
  - Формула: `macd - macd_signal`
  - Источник: kline

### 7. Признаки свечей: Мгновенные (6 признаков)

**Источник:** klines (одна свеча: open, high, low, close)

- **`candle_range`**
  - Описание: Нормализованный диапазон свечи
  - Формула: `(high - low) / close`
  - Lookback: 0s (текущая свеча)
  - Источник: kline

- **`candle_body`**
  - Описание: Размер тела свечи (нормализованный)
  - Формула: `abs(close - open) / close`
  - Lookback: 0s
  - Источник: kline

- **`upper_wick`**
  - Описание: Верхняя тень свечи (нормализованная)
  - Формула: `(high - max(open, close)) / close`
  - Lookback: 0s
  - Источник: kline

- **`lower_wick`**
  - Описание: Нижняя тень свечи (нормализованная)
  - Формула: `(min(open, close) - low) / close`
  - Lookback: 0s
  - Источник: kline

- **`candle_direction`**
  - Описание: Направление свечи
  - Формула: `1 если close > open, иначе -1`
  - Lookback: 0s
  - Источник: kline

- **`high_low_ratio`**
  - Описание: Отношение high к low (волатильность свечи)
  - Формула: `high / low`
  - Lookback: 0s
  - Источник: kline

### 8. Признаки свечей: Из нескольких свечей (3 признака)

**Источник:** klines (несколько свечей)

- **`candle_body_ma_5`**
  - Описание: Средний размер тела за 5 свечей
  - Формула: `mean(abs(close - open) / close) за 5 периодов`
  - Lookback: 5 периодов
  - Источник: kline

- **`candle_range_ma_5`**
  - Описание: Средний диапазон за 5 свечей
  - Формула: `mean((high - low) / close) за 5 периодов`
  - Lookback: 5 периодов
  - Источник: kline

- **`doji_pattern`**
  - Описание: Индикатор паттерна Doji
  - Формула: `1 если abs(open - close) / close < threshold (например, 0.001), иначе 0`
  - Lookback: 0s
  - Источник: kline

### 9. Объёмные признаки (7 признаков)

**Источник:** klines (volume)

- **`volume_ma_20`**
  - Описание: Скользящее среднее объёма за 20 периодов
  - Lookback: 20 периодов
  - Источник: kline

- **`volume_ma_50`**
  - Описание: Скользящее среднее объёма за 50 периодов
  - Lookback: 50 периодов
  - Источник: kline

- **`volume_ratio_20`**
  - Описание: Отношение объёма к среднему за 20 периодов
  - Формула: `volume / volume_ma_20`
  - Источник: kline

- **`volume_ratio_50`**
  - Описание: Отношение объёма к среднему за 50 периодов
  - Формула: `volume / volume_ma_50`
  - Источник: kline

- **`volume_price_trend`**
  - Описание: Корреляция объёма и цены за последние 10 свечей
  - Формула: `correlation(volume, close) за 10 периодов`
  - Lookback: 10 периодов
  - Источник: kline

- **`volume_change`**
  - Описание: Изменение объёма относительно предыдущей свечи
  - Формула: `(volume[t] - volume[t-1]) / volume[t-1]`
  - Lookback: 1 период
  - Источник: kline

- **`volume_std_20`**
  - Описание: Стандартное отклонение объёма за 20 периодов
  - Lookback: 20 периодов
  - Источник: kline

### 10. Funding rate признаки (3 признака)

**Источник:** funding rates

- **`funding_rate`** (оставить из текущего)
  - Описание: Текущий funding rate
  - Lookback: 0s
  - Источник: funding

- **`funding_rate_ma_3`**
  - Описание: Среднее funding rate за последние 3 периода (24 часа)
  - Lookback: 3 периода (24 часа)
  - Источник: funding

- **`funding_rate_change`**
  - Описание: Изменение funding rate относительно предыдущего
  - Формула: `funding_rate[t] - funding_rate[t-1]`
  - Lookback: 1 период (8 часов)
  - Источник: funding

- **`funding_rate_abs`**
  - Описание: Абсолютное значение funding rate
  - Формула: `abs(funding_rate)`
  - Источник: funding

**Примечание:** `time_to_funding` оставляем из текущего набора.

### 11. Временные признаки (6 признаков)

**Источник:** timestamp (не требует данных)

- **`time_of_day_sin`** (оставить из текущего)
  - Описание: Синус часа дня (циклическое кодирование)
  - Формула: `sin(2π * hour / 24)`
  - Источник: timestamp

- **`time_of_day_cos`** (оставить из текущего)
  - Описание: Косинус часа дня
  - Формула: `cos(2π * hour / 24)`
  - Источник: timestamp

- **`day_of_week_sin`**
  - Описание: Синус дня недели (0=понедельник, 6=воскресенье)
  - Формула: `sin(2π * day_of_week / 7)`
  - Источник: timestamp

- **`day_of_week_cos`**
  - Описание: Косинус дня недели
  - Формула: `cos(2π * day_of_week / 7)`
  - Источник: timestamp

- **`hour_of_day_sin`**
  - Описание: Синус часа дня (более точное кодирование)
  - Формула: `sin(2π * hour / 24)`
  - Источник: timestamp

- **`hour_of_day_cos`**
  - Описание: Косинус часа дня
  - Формула: `cos(2π * hour / 24)`
  - Источник: timestamp

**Примечание:** `minute_of_hour_sin/cos` можно добавить позже, если понадобится более детальная временная информация.

### 12. Дополнительные признаки (7 признаков)

**Источник:** klines

- **`higher_high`**
  - Описание: Индикатор: текущий high выше предыдущего
  - Формула: `1 если high[t] > high[t-1], иначе 0`
  - Lookback: 1 период
  - Источник: kline

- **`lower_low`**
  - Описание: Индикатор: текущий low ниже предыдущего
  - Формула: `1 если low[t] < low[t-1], иначе 0`
  - Lookback: 1 период
  - Источник: kline

- **`price_position`**
  - Описание: Позиция цены в диапазоне свечи
  - Формула: `(close - low) / (high - low)`
  - Диапазон: 0-1
  - Источник: kline

- **`gap_up`**
  - Описание: Разрыв вверх между свечами
  - Формула: `1 если open[t] > close[t-1], иначе 0`
  - Lookback: 1 период
  - Источник: kline

- **`gap_down`**
  - Описание: Разрыв вниз между свечами
  - Формула: `1 если open[t] < close[t-1], иначе 0`
  - Lookback: 1 период
  - Источник: kline

- **`price_zscore_20`**
  - Описание: Z-score цены относительно последних 20 свечей
  - Формула: `(close - mean(close, 20)) / std(close, 20)`
  - Lookback: 20 периодов
  - Источник: kline

- **`volume_zscore_20`**
  - Описание: Z-score объёма относительно последних 20 свечей
  - Формула: `(volume - mean(volume, 20)) / std(volume, 20)`
  - Lookback: 20 периодов
  - Источник: kline

## Итоговая статистика

### Было (текущий набор):
- **29 признаков**
- Из них недоступны из бэкфиллинга: **21 признак**

### Станет (расширенный набор):
- **~45 признаков** (все из доступных источников)
- Returns: 4 признака (1m, 5m, 15m, 1h)
- Volatility: 2 признака (1m, 5m)
- Технические индикаторы: 24 признака
  - Трендовые: 9
  - Momentum: 5
  - Волатильность: 7
  - MACD: 3
- Признаки свечей: 9 признаков
- Объёмные: 7 признаков
- Funding: 4 признака (включая time_to_funding)
- Временные: 6 признаков
- Дополнительные: 7 признаков

## Преимущества расширенного набора

1. **Все признаки вычисляются из доступных исторических данных** (klines + funding)
2. **Не требуется перевыкачивание данных** - все данные уже есть
3. **Фокус на технических индикаторах** - проверенные инструменты технического анализа
4. **Признаки из свечей** - дают паттерны, не видимые в returns
5. **Улучшенные временные признаки** - учитывают внутридневные и недельные паттерны
6. **Убраны избыточные окна** - оставлены только ключевые временные интервалы

## Риски и ограничения

1. **Увеличение размерности** - может потребоваться регуляризация
2. **Корреляция признаков** - некоторые признаки могут быть сильно коррелированы (нужна проверка)
3. **Технические индикаторы требуют достаточного lookback** - нужны данные минимум за 50 периодов (50 минут для 1m интервала)
4. **Риск переобучения** - при малом объёме данных расширенный набор может переобучаться

## Рекомендации по внедрению

### Этап 1: Минимальный набор (7 признаков)
Начать с минимального набора для быстрой проверки работоспособности:
- `returns_5m`
- `volatility_5m`
- `rsi_14`
- `ema_21`
- `price_ema21_ratio`
- `volume_ratio_20`
- `funding_rate`

### Этап 2: Расширенный набор (если минимальный работает)
Если минимальный набор показывает accuracy > 40-50%, постепенно добавлять остальные признаки из расширенного набора.

### Этап 3: Оптимизация
После внедрения расширенного набора:
- Проверить корреляции между признаками
- Выполнить feature selection (удалить избыточные)
- Настроить регуляризацию модели

## Примечания по реализации

1. **Интервал klines**: Рекомендуется использовать интервал 1m для всех вычислений
2. **Lookback окна**: Все lookback окна указаны в периодах (свечах), а не в секундах
3. **Нормализация**: Многие признаки нормализованы относительно цены для стабильности
4. **Обработка пропусков**: Нужна стратегия обработки пропущенных значений (forward fill, interpolation)
5. **Валидация**: Проверка на data leakage - все признаки используют только данные до момента t

## Ссылки

- [Feature Service документация](./feature-service.md)
- [Model Quality Improvements](./model_quality_improvements.md)
- [Threshold Horizon Recommendations](./threshold_horizon_recommendations.md)

