# Рекомендации по обработке ошибок баланса (Bybit Error 110007)

**Дата**: 2025-01-27  
**Проблема**: При создании ордеров на Bybit возникают ошибки 110007:
- "ab not enough for new order" (~30,478 случаев)
- "CheckMarginRatio fail! InsufficientAB" (~5,994 случаев)

## Краткое резюме

### Ответственность за контроль баланса

**Сервис ордеров (order-manager) должен контролировать баланс**, а не сервис модели. Это мировая практика в торговых системах.

### Двухуровневая защита

1. **Ранняя проверка (early rejection)**: Проверка баланса в order-manager ДО отправки запроса на Bybit
2. **Поздняя проверка (late rejection)**: Bybit API отклонит ордер, если баланса недостаточно

Оба уровня должны работать вместе для максимальной надежности.

---

## 1. Распределение ответственности

### 1.1 Сервис ордеров (order-manager)

**Зона ответственности**:
- ✅ Проверка доступного баланса перед постановкой ордера
- ✅ Проверка маржинальных требований
- ✅ Обработка ошибок баланса от Bybit API (110007)
- ✅ Логирование и мониторинг ошибок баланса
- ✅ Принятие решений при нехватке баланса (отклонение, частичное выполнение, адаптация размера ордера)

**Почему это здесь:**
- Сервис ордеров имеет прямой доступ к балансу через Bybit API
- Это точка принятия решения о возможности выполнения ордера
- Мировая практика: сервис исполнения ордеров отвечает за валидацию ресурсов

### 1.2 Сервис модели (model-service)

**Зона ответственности**:
- ❌ НЕ проверяет баланс напрямую
- ✅ Может учитывать исторические данные о балансе для обучения модели
- ✅ Может получать feedback о отклонениях ордеров для корректировки стратегий
- ✅ Может генерировать сигналы с учетом лимитов через конфигурацию

**Почему НЕ здесь:**
- Модель работает с историческими данными, баланс меняется в реальном времени
- Модель может генерировать сигналы для разных активов параллельно, не зная текущего состояния баланса
- Модель не имеет актуальной информации о замороженных средствах, открытых позициях, марже

---

## 2. Мировые практики обработки ошибок баланса

### 2.1 Двухуровневая проверка (Defense in Depth)

**Уровень 1: Ранняя проверка (Early Rejection)**
- Проверка баланса в order-manager ДО API вызова
- Преимущества:
  - Быстрый отказ без задержки API запроса
  - Меньше нагрузки на Bybit API
  - Детальное логирование причины отклонения
  - Возможность адаптации размера ордера

**Уровень 2: Поздняя проверка (Late Rejection)**
- Bybit API проверяет баланс и отклоняет ордер
- Преимущества:
  - Гарантированная актуальность баланса (нет race conditions)
  - Обработка изменений баланса между проверкой и отправкой

**Рекомендация**: Использовать оба уровня. Ранняя проверка — для оптимизации и логирования, поздняя — как гарантия.

### 2.2 Паттерны обработки ошибок баланса

#### Паттерн 1: Retry with Backoff (НЕ рекомендуется для 110007)
- ❌ НЕ использовать для ошибок баланса
- Ошибка 110007 означает реальную нехватку средств, повторы не помогут

#### Паттерн 2: Graceful Degradation
- ✅ Уменьшить размер ордера до доступного баланса (если допустимо стратегией)
- ✅ Пересчитать quantity на основе доступного баланса
- ⚠️ Требует явного разрешения пользователя/конфигурации

#### Паттерн 3: Rejection with Feedback
- ✅ Отклонить ордер с детальным логом
- ✅ Отправить событие отклонения обратно в model-service
- ✅ Модель может использовать feedback для обучения

#### Паттерн 4: Pre-emptive Balance Check
- ✅ Проверять баланс периодически и кэшировать
- ✅ Обновлять кэш при получении событий баланса через WebSocket
- ✅ Использовать кэш для быстрой проверки без API вызова

### 2.3 Обработка двух типов ошибок 110007

#### Ошибка 1: "ab not enough for new order"
**Суть**: Недостаточно доступного баланса (Available Balance)

**Действия order-manager:**
1. **Детальное логирование**:
   ```
   - Требуемый баланс: X USDT
   - Доступный баланс: Y USDT
   - Недостаток: (X - Y) USDT
   - Процент недостатка: ((X - Y) / X) * 100%
   ```

2. **Отклонение ордера**:
   - Сохранить отклоненный ордер в БД со статусом `rejected`
   - Указать `rejection_reason` = "Insufficient available balance"

3. **Публикация события отклонения**:
   - Отправить событие в очередь для model-service
   - Включить детали: требуемый баланс, доступный баланс, недостаток

4. **Мониторинг**:
   - Алерт при высокой частоте ошибок
   - Метрика: процент отклонений из-за недостатка баланса

#### Ошибка 2: "CheckMarginRatio fail! InsufficientAB"
**Суть**: Недостаточно маржи для поддержания требуемого коэффициента маржи

**Действия order-manager:**
1. **Расчет маржинальных требований**:
   - Проверить текущий коэффициент маржи
   - Рассчитать требуемую маржу для нового ордера
   - Проверить, не нарушит ли ордер минимальный коэффициент маржи

2. **Детальное логирование**:
   ```
   - Текущий коэффициент маржи: X%
   - Требуемый коэффициент маржи: Y%
   - Доступная маржа: Z USDT
   - Требуемая маржа для ордера: W USDT
   ```

3. **Возможные решения**:
   - **Вариант A (стандартный)**: Отклонить ордер
   - **Вариант B (продвинутый)**: Уменьшить размер ордера до допустимого уровня маржи
   - **Вариант C (экстренный)**: Закрыть часть позиций для освобождения маржи (требует явной конфигурации)

4. **Отклонение ордера**:
   - Сохранить отклоненный ордер в БД со статусом `rejected`
   - Указать `rejection_reason` = "Insufficient margin for required margin ratio"

---

## 3. Рекомендуемая реализация

### 3.1 Улучшение текущей проверки баланса

**Текущее состояние**:
- ✅ Проверка баланса уже реализована в `risk_manager.py`
- ✅ Проверка опциональна (`ORDERMANAGER_ENABLE_BALANCE_CHECK`)
- ⚠️ Нет специальной обработки ошибки 110007 в `order_executor.py`

**Рекомендуемые улучшения**:

#### 3.1.1 Добавить обработку ошибки 110007 в `order_executor.py`

```python
# В методе create_order, после получения ответа от Bybit:
if ret_code != 0:
    # Ошибка 110007: Недостаточно баланса
    if ret_code == 110007:
        # Парсинг сообщения для определения типа ошибки
        error_type = "unknown"
        shortfall = None
        
        if "ab not enough" in ret_msg.lower():
            error_type = "insufficient_available_balance"
        elif "checkmarginratio" in ret_msg.lower() or "insufficientab" in ret_msg.lower():
            error_type = "insufficient_margin_ratio"
        
        # Детальное логирование
        logger.error(
            "order_rejected_insufficient_balance",
            signal_id=str(signal_id),
            asset=asset,
            ret_code=ret_code,
            ret_msg=ret_msg,
            error_type=error_type,
            order_quantity=float(quantity),
            order_price=float(price) if price else None,
            required_balance=float(quantity * (price or signal.market_data_snapshot.price)) if signal.signal_type.lower() == "buy" else None,
            trace_id=trace_id,
        )
        
        # Сохранение отклоненного ордера в БД
        rejected_order = await self._save_rejected_order(
            signal=signal,
            order_type=order_type,
            quantity=quantity,
            price=price,
            rejection_reason=f"Bybit API error 110007: {ret_msg}",
            trace_id=trace_id,
        )
        
        # Публикация события отклонения
        if rejected_order:
            await self.event_publisher.publish_order_event(
                order=rejected_order,
                event_type="rejected",
                trace_id=trace_id,
                rejection_reason=f"Bybit API error 110007: {ret_msg}",
                error_type=error_type,
            )
        
        # НЕ делать retry - ошибка баланса не исправится
        raise OrderExecutionError(
            f"Order rejected due to insufficient balance: {ret_msg} (code: {ret_code})"
        )
```

#### 3.1.2 Улучшить проверку баланса в `risk_manager.py`

**Текущие проблемы**:
- Проверка баланса может быть пропущена (опциональна)
- Нет проверки маржинальных требований

**Рекомендации**:

1. **Всегда включать проверку баланса в production**:
   - `ORDERMANAGER_ENABLE_BALANCE_CHECK=true` по умолчанию
   - Только в testnet/development можно отключать

2. **Добавить проверку маржинальных требований**:
   ```python
   async def check_margin_ratio(
       self, 
       signal: TradingSignal, 
       order_quantity: Decimal, 
       order_price: Decimal,
       trace_id: Optional[str] = None
   ) -> bool:
       """Проверить, достаточно ли маржи для поддержания коэффициента маржи."""
       # 1. Получить текущий коэффициент маржи через Bybit API
       # 2. Рассчитать требуемую маржу для нового ордера
       # 3. Проверить, не нарушит ли ордер минимальный коэффициент маржи
       # 4. Вызвать RiskLimitError если недостаточно маржи
   ```

3. **Кэширование баланса**:
   - Использовать события баланса из WebSocket gateway для обновления кэша
   - Кэш обновляется в реальном времени, уменьшая количество API вызовов

### 3.2 Мониторинг и алертинг

**Метрики для отслеживания**:
1. **Частота ошибок 110007**:
   - Количество ошибок в час/день
   - Процент ошибок от общего количества ордеров

2. **Типы ошибок**:
   - "ab not enough for new order" vs "CheckMarginRatio fail"
   - Распределение по активам (asset)

3. **Корреляция с балансом**:
   - Средний доступный баланс в момент ошибки
   - Тенденция баланса перед ошибками

**Алерты**:
- Критический: >10% ордеров отклоняется из-за 110007 за последний час
- Предупреждение: >5% ордеров отклоняется из-за 110007 за последний час
- Информация: >100 ошибок 110007 за день

### 3.3 Feedback loop для model-service

**Событие отклонения должно содержать**:
```json
{
  "event_type": "order_rejected",
  "order": { ... },
  "rejection_reason": "Bybit API error 110007: ab not enough for new order",
  "error_type": "insufficient_available_balance",
  "balance_info": {
    "required_balance": 1000.0,
    "available_balance": 500.0,
    "shortfall": 500.0,
    "shortfall_percentage": 50.0
  },
  "signal_info": { ... }
}
```

**Model-service может использовать**:
- Для обучения: не генерировать сигналы, которые будут отклонены
- Для адаптации: учитывать доступный баланс при расчете размера позиции
- Для мониторинга: отслеживать эффективность стратегии

---

## 4. Решения при нехватке баланса

### 4.1 Стандартное решение: Отклонение ордера

**Когда использовать**:
- По умолчанию для всех случаев
- Когда стратегия не допускает частичного выполнения

**Действия**:
1. Отклонить ордер
2. Сохранить отклоненный ордер в БД
3. Отправить событие отклонения
4. Записать детальный лог

### 4.2 Продвинутое решение: Адаптация размера ордера

**Когда использовать**:
- Если включена опция `ORDERMANAGER_ALLOW_ORDER_SIZE_ADJUSTMENT=true`
- Только для определенных типов сигналов (например, не для стоп-лоссов)

**Действия**:
1. Рассчитать максимально возможный размер ордера на основе доступного баланса
2. Уменьшить quantity до допустимого размера
3. Создать ордер с уменьшенным размером
4. Записать в лог, что размер был адаптирован
5. Отправить событие с информацией об адаптации

**Важно**:
- Требует явной конфигурации
- Модель должна знать, что ордер был выполнен частично

### 4.3 Экстренное решение: Освобождение маржи

**Когда использовать**:
- Только при явной конфигурации `ORDERMANAGER_ENABLE_MARGIN_RELEASE=true`
- Только для критических сигналов (например, стоп-лосс)

**Действия**:
1. Определить позиции, которые можно закрыть для освобождения маржи
2. Закрыть частичные позиции (начиная с наименее прибыльных)
3. Дождаться освобождения маржи
4. Повторить попытку создания ордера

**Важно**:
- Очень рискованная операция
- Требует детальной настройки правил
- Должна быть отключена по умолчанию

---

## 5. Конфигурация

### 5.1 Рекомендуемые настройки

```bash
# Включить проверку баланса в production
ORDERMANAGER_ENABLE_BALANCE_CHECK=true

# Включить проверку маржинальных требований (опционально)
ORDERMANAGER_ENABLE_MARGIN_CHECK=true

# Разрешить адаптацию размера ордера при нехватке баланса (опционально)
ORDERMANAGER_ALLOW_ORDER_SIZE_ADJUSTMENT=false

# Включить освобождение маржи (ОПАСНО, отключено по умолчанию)
ORDERMANAGER_ENABLE_MARGIN_RELEASE=false
```

### 5.2 Минимальный коэффициент маржи

```bash
# Минимальный коэффициент маржи (в процентах)
ORDERMANAGER_MIN_MARGIN_RATIO=100.0
```

---

## 6. Приоритеты реализации

### Приоритет 1 (Критично)
1. ✅ Добавить обработку ошибки 110007 в `order_executor.py`
2. ✅ Улучшить логирование ошибок баланса
3. ✅ Сохранение отклоненных ордеров в БД с детальным `rejection_reason`

### Приоритет 2 (Важно)
1. ✅ Добавить мониторинг частоты ошибок 110007
2. ✅ Улучшить проверку баланса в `risk_manager.py` (добавить проверку маржи)
3. ✅ Кэширование баланса на основе событий WebSocket

### Приоритет 3 (Опционально)
1. ⚠️ Реализовать адаптацию размера ордера при нехватке баланса
2. ⚠️ Реализовать освобождение маржи (только при явной необходимости)

---

## 7. Тестирование

### 7.1 Unit тесты

- Тест обработки ошибки 110007 "ab not enough"
- Тест обработки ошибки 110007 "CheckMarginRatio fail"
- Тест проверки баланса при достаточном балансе
- Тест проверки баланса при недостаточном балансе
- Тест проверки маржинальных требований

### 7.2 Integration тесты

- Тест полного цикла: сигнал → проверка баланса → отклонение → сохранение в БД → публикация события
- Тест обработки ошибки 110007 от Bybit API
- Тест кэширования баланса через WebSocket события

### 7.3 E2E тесты

- Тест отклонения ордера при нехватке баланса в реальной среде (testnet)
- Тест мониторинга ошибок баланса

---

## 8. Документация

### 8.1 Обновить спецификацию order-manager

Добавить в `specs/004-order-manager/spec.md`:

- Описание обработки ошибки 110007
- Описание проверки маржинальных требований
- Описание адаптации размера ордера (если реализовано)

### 8.2 Обновить README

Добавить в `order-manager/README.md`:

- Описание конфигурации баланса и маржи
- Примеры обработки ошибок баланса
- Рекомендации по мониторингу

---

## Заключение

**Ключевые выводы**:

1. **Контроль баланса — ответственность order-manager**, не model-service
2. **Двухуровневая защита**: ранняя проверка + поздняя проверка Bybit API
3. **Ошибка 110007 не должна вызывать retry** — это реальная нехватка средств
4. **Детальное логирование** критично для диагностики и мониторинга
5. **Feedback loop** с model-service помогает модели адаптироваться

**Следующие шаги**:

1. Реализовать обработку ошибки 110007 в `order_executor.py` (Приоритет 1)
2. Улучшить проверку баланса и добавить проверку маржи (Приоритет 1-2)
3. Настроить мониторинг ошибок баланса (Приоритет 2)
4. Рассмотреть опциональные улучшения (адаптация размера, освобождение маржи) при необходимости

