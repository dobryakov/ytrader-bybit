# Исправление проблемы группировки в агрегации 1m->5m klines

## Проблема

Проблема была в использовании **относительной группировки** по `time_bucket` при агрегации 1m klines в 5m. Группировка основывалась на минимальном timestamp в наборе данных, что приводило к неправильной агрегации, когда данные не начинались точно с границы 5-минутного интервала.

### Старый код (проблемный):

```python
# Группировка относительно минимального timestamp
klines_sorted["time_bucket"] = (
    (klines_sorted["timestamp"] - klines_sorted["timestamp"].min()).dt.total_seconds() // 300
)
```

**Проблема**: Если данные начинаются с `00:03:00`, то первая группа будет содержать `00:03:00 - 00:08:00`, что неправильно. Правильная 5-минутная свеча должна быть `00:00:00 - 00:05:00`.

## Решение

Использование **стандартной группировки** по 5-минутным интервалам, выровненным по стандартным временным границам (00:00, 00:05, 00:10, ...).

### Новый код (исправленный):

```python
# Группировка по стандартным 5-минутным интервалам
epoch_start = pd.Timestamp("1970-01-01", tz=timezone.utc)
seconds_since_epoch = (klines_sorted["timestamp"] - epoch_start).dt.total_seconds()
bucket_number = (seconds_since_epoch // 300).astype(int)  # Floor division by 5 minutes
klines_sorted["time_bucket"] = bucket_number
```

**Преимущества**:
- Согласованная группировка независимо от начала данных
- Правильное выравнивание по стандартным временным границам
- Более предсказуемое поведение

## Изменения в файлах

### 1. `feature-service/src/features/candle_patterns.py`

**Изменение в `compute_all_candle_patterns_15m`**:
- Заменена относительная группировка на стандартную
- Добавлено улучшенное логирование для диагностики
- Добавлена сортировка после агрегации для гарантии правильного порядка

### 2. `feature-service/src/services/optimized_dataset/rolling_window.py`

**Изменение в `OptimizedRollingWindow.get_window`**:
- Заменена относительная группировка на стандартную при создании 5m окна
- Улучшено логирование недостаточности данных с информацией о временных промежутках

## Улучшенное логирование

Добавлено детальное логирование для диагностики:

1. **В `compute_all_candle_patterns_15m`**:
   - Проверка доступности 5m klines перед fallback
   - Детальная информация о недостаточных данных (time_span, gap_minutes)
   - Информация о первом и последнем доступных klines

2. **В `OptimizedRollingWindow.get_window`**:
   - Информация о временных промежутках в окне
   - Расчет gap между ожидаемым и реальным временным промежутком
   - Улучшенное предупреждение о недостаточности данных

## Ожидаемый результат

После исправления:
- Правильная агрегация 1m->5m klines независимо от начала данных
- Корректное вычисление свечных паттернов для всех timestamp'ов
- Устранение проблемы с 88.4% NaN для lookback фич

## Тестирование

Необходимо проверить:
1. ✅ Синтаксис Python (lint проверка пройдена)
2. ⏳ Пересобрать контейнер feature-service
3. ⏳ Запустить тест создания датасета
4. ⏳ Проверить логи на наличие улучшенной диагностики
5. ⏳ Убедиться, что проблема с NaN решена

