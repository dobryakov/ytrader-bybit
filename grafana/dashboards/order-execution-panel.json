{
  "id": null,
  "title": "Order Execution Panel",
  "type": "table",
  "gridPos": {
    "h": 8,
    "w": 12,
    "x": 0,
    "y": 0
  },
  "targets": [
    {
      "datasource": {
        "type": "postgres",
        "uid": "PostgreSQL"
      },
      "editorMode": "code",
      "format": "table",
      "rawQuery": true,
      "rawSql": "SELECT\n    o.order_id,\n    o.signal_id,\n    o.asset,\n    o.side,\n    e.execution_price,\n    e.execution_quantity,\n    e.execution_fees,\n    COALESCE(e.executed_at, o.created_at) as executed_at,\n    o.status as closure_status,\n    o.rejection_reason,\n    CASE \n        WHEN e.execution_price IS NOT NULL AND e.side = 'buy' THEN\n            ROUND((COALESCE(p.current_price, e.execution_price) - e.execution_price) * e.execution_quantity - e.execution_fees, 8)\n        WHEN e.execution_price IS NOT NULL AND e.side = 'sell' THEN\n            ROUND((e.execution_price - COALESCE(p.current_price, e.execution_price)) * e.execution_quantity - e.execution_fees, 8)\n        ELSE NULL\n    END as unrealized_pnl,\n    CASE \n        WHEN e.execution_price IS NOT NULL AND e.side = 'buy' THEN\n            ROUND(((COALESCE(p.current_price, e.execution_price) - e.execution_price) / e.execution_price * 100)::numeric, 4)\n        WHEN e.execution_price IS NOT NULL AND e.side = 'sell' THEN\n            ROUND(((e.execution_price - COALESCE(p.current_price, e.execution_price)) / e.execution_price * 100)::numeric, 4)\n        ELSE NULL\n    END as pnl_percent,\n    COALESCE(p.current_price, e.execution_price) as current_price\nFROM orders o\nLEFT JOIN execution_events e ON e.signal_id = o.signal_id\nLEFT JOIN LATERAL (\n    SELECT current_price\n    FROM positions\n    WHERE asset = o.asset\n    ORDER BY updated_at DESC\n    LIMIT 1\n) p ON true\nORDER BY \n    CASE WHEN e.execution_price IS NOT NULL THEN 0 ELSE 1 END,\n    COALESCE(e.executed_at, o.created_at) DESC\nLIMIT 100;",
      "refId": "A",
      "sql": {
        "columns": [
          {
            "parameters": [],
            "type": "function"
          }
        ],
        "groupBy": [
          {
            "property": {
              "type": "string"
            },
            "type": "groupBy"
          }
        ],
        "limit": 100
      }
    }
  ],
  "options": {
    "showHeader": true,
    "sortBy": [
      {
        "desc": true,
        "displayName": "executed_at"
      }
    ]
  },
  "fieldConfig": {
    "defaults": {
      "custom": {
        "align": "auto",
        "displayMode": "auto"
      },
      "mappings": [],
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {
            "color": "green",
            "value": null
          }
        ]
      }
    },
    "overrides": [
      {
        "matcher": {
          "id": "byName",
          "options": "execution_price"
        },
        "properties": [
          {
            "id": "unit",
            "value": "currencyUSD"
          },
          {
            "id": "decimals",
            "value": 2
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "execution_quantity"
        },
        "properties": [
          {
            "id": "unit",
            "value": "short"
          },
          {
            "id": "decimals",
            "value": 4
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "execution_fees"
        },
        "properties": [
          {
            "id": "unit",
            "value": "currencyUSD"
          },
          {
            "id": "decimals",
            "value": 4
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "executed_at"
        },
        "properties": [
          {
            "id": "unit",
            "value": "dateTimeFromNow"
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "closure_status"
        },
        "properties": [
          {
            "id": "mappings",
            "value": [
              {
                "options": {
                  "filled": {
                    "color": "green",
                    "index": 0,
                    "text": "Filled"
                  },
                  "cancelled": {
                    "color": "yellow",
                    "index": 1,
                    "text": "Cancelled"
                  },
                  "rejected": {
                    "color": "red",
                    "index": 2,
                    "text": "Rejected"
                  },
                  "pending": {
                    "color": "blue",
                    "index": 3,
                    "text": "Pending"
                  }
                },
                "type": "value"
              }
            ]
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "side"
        },
        "properties": [
          {
            "id": "mappings",
            "value": [
              {
                "options": {
                  "buy": {
                    "color": "green",
                    "index": 0,
                    "text": "Buy"
                  },
                  "sell": {
                    "color": "red",
                    "index": 1,
                    "text": "Sell"
                  }
                },
                "type": "value"
              }
            ]
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "rejection_reason"
        },
        "properties": [
          {
            "id": "custom.width",
            "value": 400
          },
          {
            "id": "custom.cellOptions",
            "value": {
              "type": "auto",
              "wrapText": true
            }
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "unrealized_pnl"
        },
        "properties": [
          {
            "id": "unit",
            "value": "currencyUSD"
          },
          {
            "id": "decimals",
            "value": 4
          },
          {
            "id": "custom.cellOptions",
            "value": {
              "type": "color-text"
            }
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {
                  "color": "red",
                  "value": null
                },
                {
                  "color": "green",
                  "value": 0
                }
              ]
            }
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "pnl_percent"
        },
        "properties": [
          {
            "id": "unit",
            "value": "percent"
          },
          {
            "id": "decimals",
            "value": 2
          },
          {
            "id": "custom.cellOptions",
            "value": {
              "type": "color-text"
            }
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {
                  "color": "red",
                  "value": null
                },
                {
                  "color": "green",
                  "value": 0
                }
              ]
            }
          }
        ]
      }
    ]
  },
  "maxDataPoints": 100,
  "interval": "60s"
}

