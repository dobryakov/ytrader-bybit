{
  "id": null,
  "title": "Order Execution Panel",
  "type": "table",
  "gridPos": {
    "h": 8,
    "w": 12,
    "x": 0,
    "y": 0
  },
  "targets": [
    {
      "datasource": {
        "type": "postgres",
        "uid": "PostgreSQL"
      },
      "editorMode": "code",
      "format": "table",
      "rawQuery": true,
      "rawSql": "SELECT\n    o.order_id,\n    o.signal_id,\n    o.asset,\n    o.side,\n    e.execution_price,\n    e.execution_quantity,\n    e.execution_fees,\n    COALESCE(e.executed_at, o.created_at) as executed_at,\n    o.status as closure_status,\n    o.rejection_reason,\n    -- Realized PnL from execution_events.performance (for closed positions)\n    (e.performance->>'realized_pnl')::DECIMAL as realized_pnl,\n    -- PnL calculation: use average_entry_price for sell (closing position), current_price for buy (opening position)\n    CASE \n        -- BUY orders (opening position): unrealized PnL = (current_price - execution_price) * quantity - fees\n        WHEN e.execution_price IS NOT NULL AND LOWER(e.side) = 'buy' THEN\n            COALESCE(\n                p.unrealized_pnl / NULLIF(p.size, 0) * e.execution_quantity,\n                ROUND((COALESCE(p.current_price, e.execution_price) - e.execution_price) * e.execution_quantity - e.execution_fees, 8)\n            )\n        -- SELL orders (closing position): realized PnL = (execution_price - average_entry_price) * quantity - fees\n        WHEN e.execution_price IS NOT NULL AND LOWER(e.side) = 'sell' THEN\n            COALESCE(\n                -- Use position-level unrealized_pnl if available\n                p.unrealized_pnl / NULLIF(p.size, 0) * e.execution_quantity,\n                -- Otherwise calculate from execution_price vs average_entry_price\n                CASE \n                    WHEN p.average_entry_price IS NOT NULL AND p.average_entry_price > 0 THEN\n                        ROUND((e.execution_price - p.average_entry_price) * e.execution_quantity - e.execution_fees, 8)\n                    ELSE\n                        -- Cannot calculate without entry price\n                        NULL\n                END\n            )\n        ELSE NULL\n    END as unrealized_pnl,\n    -- PnL percentage calculation\n    CASE \n        WHEN e.execution_price IS NOT NULL AND p.unrealized_pnl IS NOT NULL AND p.size > 0 AND p.average_entry_price > 0 THEN\n            ROUND((p.unrealized_pnl / NULLIF(p.size * p.average_entry_price, 0) * 100)::numeric, 4)\n        -- BUY orders: percentage based on current_price vs execution_price\n        WHEN e.execution_price IS NOT NULL AND LOWER(e.side) = 'buy' THEN\n            ROUND(((COALESCE(p.current_price, e.execution_price) - e.execution_price) / e.execution_price * 100)::numeric, 4)\n        -- SELL orders: percentage based on execution_price vs average_entry_price (price we bought at)\n        WHEN e.execution_price IS NOT NULL AND LOWER(e.side) = 'sell' AND p.average_entry_price IS NOT NULL AND p.average_entry_price > 0 THEN\n            ROUND(((e.execution_price - p.average_entry_price) / p.average_entry_price * 100)::numeric, 4)\n        ELSE NULL\n    END as pnl_percent,\n    -- Show average_entry_price for sell orders, current_price for buy orders\n    CASE \n        WHEN LOWER(e.side) = 'sell' AND p.average_entry_price IS NOT NULL THEN p.average_entry_price\n        ELSE COALESCE(p.current_price, e.execution_price)\n    END as reference_price\nFROM orders o\nLEFT JOIN execution_events e ON e.signal_id = o.signal_id\nLEFT JOIN LATERAL (\n    SELECT \n        unrealized_pnl, \n        size, \n        average_entry_price,\n        -- Get current_price from positions if available, otherwise calculate from unrealized_pnl\n        CASE \n            WHEN size > 0 AND average_entry_price > 0 AND unrealized_pnl IS NOT NULL THEN\n                average_entry_price + (unrealized_pnl / size)\n            ELSE NULL\n        END as current_price\n    FROM positions\n    WHERE asset = o.asset\n    ORDER BY last_updated DESC\n    LIMIT 1\n) p ON true\nWHERE $__timeFilter(COALESCE(e.executed_at, o.created_at))\nORDER BY \n    CASE WHEN e.execution_price IS NOT NULL THEN 0 ELSE 1 END,\n    COALESCE(e.executed_at, o.created_at) DESC\nLIMIT 100;",
      "refId": "A",
      "sql": {
        "columns": [
          {
            "parameters": [],
            "type": "function"
          }
        ],
        "groupBy": [
          {
            "property": {
              "type": "string"
            },
            "type": "groupBy"
          }
        ],
        "limit": 100
      }
    }
  ],
  "options": {
    "showHeader": true,
    "sortBy": [
      {
        "desc": true,
        "displayName": "executed_at"
      }
    ]
  },
  "fieldConfig": {
    "defaults": {
      "custom": {
        "align": "auto",
        "displayMode": "auto"
      },
      "mappings": [],
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {
            "color": "green",
            "value": null
          }
        ]
      }
    },
    "overrides": [
      {
        "matcher": {
          "id": "byName",
          "options": "execution_price"
        },
        "properties": [
          {
            "id": "unit",
            "value": "currencyUSD"
          },
          {
            "id": "decimals",
            "value": 2
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "execution_quantity"
        },
        "properties": [
          {
            "id": "unit",
            "value": "short"
          },
          {
            "id": "decimals",
            "value": 4
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "execution_fees"
        },
        "properties": [
          {
            "id": "unit",
            "value": "currencyUSD"
          },
          {
            "id": "decimals",
            "value": 4
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "executed_at"
        },
        "properties": [
          {
            "id": "unit",
            "value": "dateTimeFromNow"
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "closure_status"
        },
        "properties": [
          {
            "id": "mappings",
            "value": [
              {
                "options": {
                  "filled": {
                    "color": "green",
                    "index": 0,
                    "text": "Filled"
                  },
                  "cancelled": {
                    "color": "yellow",
                    "index": 1,
                    "text": "Cancelled"
                  },
                  "rejected": {
                    "color": "red",
                    "index": 2,
                    "text": "Rejected"
                  },
                  "pending": {
                    "color": "blue",
                    "index": 3,
                    "text": "Pending"
                  }
                },
                "type": "value"
              }
            ]
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "side"
        },
        "properties": [
          {
            "id": "mappings",
            "value": [
              {
                "options": {
                  "buy": {
                    "color": "green",
                    "index": 0,
                    "text": "Buy"
                  },
                  "sell": {
                    "color": "red",
                    "index": 1,
                    "text": "Sell"
                  }
                },
                "type": "value"
              }
            ]
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "rejection_reason"
        },
        "properties": [
          {
            "id": "custom.width",
            "value": 400
          },
          {
            "id": "custom.cellOptions",
            "value": {
              "type": "auto",
              "wrapText": true
            }
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "unrealized_pnl"
        },
        "properties": [
          {
            "id": "unit",
            "value": "currencyUSD"
          },
          {
            "id": "decimals",
            "value": 4
          },
          {
            "id": "custom.cellOptions",
            "value": {
              "type": "color-text"
            }
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {
                  "color": "red",
                  "value": null
                },
                {
                  "color": "green",
                  "value": 0
                }
              ]
            }
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "pnl_percent"
        },
        "properties": [
          {
            "id": "unit",
            "value": "percent"
          },
          {
            "id": "decimals",
            "value": 2
          },
          {
            "id": "custom.cellOptions",
            "value": {
              "type": "color-text"
            }
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {
                  "color": "red",
                  "value": null
                },
                {
                  "color": "green",
                  "value": 0
                }
              ]
            }
          }
        ]
      },
      {
        "matcher": {
          "id": "byName",
          "options": "realized_pnl"
        },
        "properties": [
          {
            "id": "unit",
            "value": "currencyUSD"
          },
          {
            "id": "decimals",
            "value": 4
          },
          {
            "id": "custom.cellOptions",
            "value": {
              "type": "color-text"
            }
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {
                  "color": "red",
                  "value": null
                },
                {
                  "color": "green",
                  "value": 0
                }
              ]
            }
          }
        ]
      }
    ]
  },
  "maxDataPoints": 100,
  "interval": "60s"
}

