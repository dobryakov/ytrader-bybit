services:
  ws-gateway:
    build:
      context: ./ws-gateway
      dockerfile: Dockerfile
    container_name: ws-gateway
    ports:
      - "${WS_GATEWAY_PORT:-4400}:4400"
    environment:
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - BYBIT_WS_STRATEGY=${BYBIT_WS_STRATEGY:-dual}
      - BYBIT_WS_PUBLIC_CATEGORY=${BYBIT_WS_PUBLIC_CATEGORY:-linear}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - WS_GATEWAY_LOG_LEVEL=${WS_GATEWAY_LOG_LEVEL:-INFO}
      - WS_GATEWAY_SERVICE_NAME=${WS_GATEWAY_SERVICE_NAME:-ws-gateway}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - ytrader-network
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ytrader}"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:-guest}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  model-service:
    build:
      context: ./model-service
      dockerfile: Dockerfile
    container_name: model-service
    ports:
      - "${MODEL_SERVICE_PORT:-4500}:4500"
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - MODEL_SERVICE_PORT=${MODEL_SERVICE_PORT:-4500}
      - MODEL_SERVICE_API_KEY=${MODEL_SERVICE_API_KEY}
      - MODEL_SERVICE_LOG_LEVEL=${MODEL_SERVICE_LOG_LEVEL:-INFO}
      - MODEL_SERVICE_SERVICE_NAME=${MODEL_SERVICE_SERVICE_NAME:-model-service}
      - MODEL_STORAGE_PATH=${MODEL_STORAGE_PATH:-/models}
      - MODEL_TRAINING_MIN_DATASET_SIZE=${MODEL_TRAINING_MIN_DATASET_SIZE:-1000}
      - MODEL_TRAINING_MAX_DURATION_SECONDS=${MODEL_TRAINING_MAX_DURATION_SECONDS:-1800}
      - MODEL_QUALITY_THRESHOLD_ACCURACY=${MODEL_QUALITY_THRESHOLD_ACCURACY:-0.75}
      - MODEL_RETRAINING_SCHEDULE=${MODEL_RETRAINING_SCHEDULE:-}
      - SIGNAL_GENERATION_RATE_LIMIT=${SIGNAL_GENERATION_RATE_LIMIT:-60}
      - SIGNAL_GENERATION_BURST_ALLOWANCE=${SIGNAL_GENERATION_BURST_ALLOWANCE:-10}
      - WARMUP_MODE_ENABLED=${WARMUP_MODE_ENABLED:-true}
      - WARMUP_SIGNAL_FREQUENCY=${WARMUP_SIGNAL_FREQUENCY:-60}
      - WARMUP_MIN_AMOUNT=${WARMUP_MIN_AMOUNT:-100.0}
      - WARMUP_MAX_AMOUNT=${WARMUP_MAX_AMOUNT:-1000.0}
      - WARMUP_RANDOMNESS_LEVEL=${WARMUP_RANDOMNESS_LEVEL:-0.5}
      - WS_GATEWAY_HOST=${WS_GATEWAY_HOST:-ws-gateway}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - TRADING_STRATEGIES=${TRADING_STRATEGIES:-momentum_v1}
    volumes:
      - model_storage:/models
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      ws-gateway:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  order-manager:
    build:
      context: ./order-manager
      dockerfile: Dockerfile
    container_name: order-manager
    ports:
      - "${ORDERMANAGER_PORT:-4600}:4600"
    environment:
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - ORDERMANAGER_PORT=${ORDERMANAGER_PORT:-4600}
      - ORDERMANAGER_API_KEY=${ORDERMANAGER_API_KEY}
      - ORDERMANAGER_LOG_LEVEL=${ORDERMANAGER_LOG_LEVEL:-INFO}
      - ORDERMANAGER_SERVICE_NAME=${ORDERMANAGER_SERVICE_NAME:-order-manager}
      - WS_GATEWAY_HOST=${WS_GATEWAY_HOST:-ws-gateway}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - ORDERMANAGER_ENABLE_DRY_RUN=${ORDERMANAGER_ENABLE_DRY_RUN:-false}
      - ORDERMANAGER_MAX_SINGLE_ORDER_SIZE=${ORDERMANAGER_MAX_SINGLE_ORDER_SIZE:-500.0}
      - ORDERMANAGER_ENABLE_ORDER_SPLITTING=${ORDERMANAGER_ENABLE_ORDER_SPLITTING:-false}
      - ORDERMANAGER_ORDER_EXECUTION_TIMEOUT=${ORDERMANAGER_ORDER_EXECUTION_TIMEOUT:-30}
      - ORDERMANAGER_MAX_POSITION_SIZE=${ORDERMANAGER_MAX_POSITION_SIZE:-2.0}
      - ORDERMANAGER_MAX_EXPOSURE=${ORDERMANAGER_MAX_EXPOSURE:-10000.0}
      - ORDERMANAGER_MAX_ORDER_SIZE_RATIO=${ORDERMANAGER_MAX_ORDER_SIZE_RATIO:-0.1}
      - ORDERMANAGER_BYBIT_API_RETRY_MAX_ATTEMPTS=${ORDERMANAGER_BYBIT_API_RETRY_MAX_ATTEMPTS:-3}
      - ORDERMANAGER_BYBIT_API_RETRY_BASE_DELAY=${ORDERMANAGER_BYBIT_API_RETRY_BASE_DELAY:-1.0}
      - ORDERMANAGER_BYBIT_API_RETRY_MAX_DELAY=${ORDERMANAGER_BYBIT_API_RETRY_MAX_DELAY:-30.0}
      - ORDERMANAGER_BYBIT_API_RETRY_MULTIPLIER=${ORDERMANAGER_BYBIT_API_RETRY_MULTIPLIER:-2.0}
      - ORDERMANAGER_MARKET_ORDER_CONFIDENCE_THRESHOLD=${ORDERMANAGER_MARKET_ORDER_CONFIDENCE_THRESHOLD:-0.9}
      - ORDERMANAGER_MARKET_ORDER_SPREAD_THRESHOLD=${ORDERMANAGER_MARKET_ORDER_SPREAD_THRESHOLD:-0.1}
      - ORDERMANAGER_LIMIT_ORDER_PRICE_OFFSET_RATIO=${ORDERMANAGER_LIMIT_ORDER_PRICE_OFFSET_RATIO:-0.5}
      - ORDERMANAGER_POSITION_SNAPSHOT_INTERVAL=${ORDERMANAGER_POSITION_SNAPSHOT_INTERVAL:-300}
      - ORDERMANAGER_POSITION_VALIDATION_INTERVAL=${ORDERMANAGER_POSITION_VALIDATION_INTERVAL:-3600}
      - ORDERMANAGER_CANCEL_OPPOSITE_ORDERS_ONLY=${ORDERMANAGER_CANCEL_OPPOSITE_ORDERS_ONLY:-false}
      - ORDERMANAGER_CANCEL_STALE_ORDER_TIMEOUT=${ORDERMANAGER_CANCEL_STALE_ORDER_TIMEOUT:-3600}
      - ORDERMANAGER_UNREALIZED_LOSS_WARNING_THRESHOLD=${ORDERMANAGER_UNREALIZED_LOSS_WARNING_THRESHOLD:-10.0}
      - ORDERMANAGER_ENABLE_BALANCE_CHECK=${ORDERMANAGER_ENABLE_BALANCE_CHECK:-true}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      ws-gateway:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped

  grafana:
    build:
      context: ./grafana
      dockerfile: Dockerfile
    container_name: grafana
    ports:
      - "${GRAFANA_PORT:-4700}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_INSTALL_PLUGINS=yesoreyeram-infinity-datasource
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - GRAFANA_POSTGRES_USER=${GRAFANA_POSTGRES_USER:-grafana_monitor}
      - GRAFANA_POSTGRES_PASSWORD=${GRAFANA_POSTGRES_PASSWORD}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - postgres
      - rabbitmq
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  test-grafana:
    build:
      context: ./tests
      dockerfile: Dockerfile
    container_name: test-grafana
    environment:
      - DOCKER_ENV=true
      - GRAFANA_HOST=grafana
      - GRAFANA_PORT=3000
      - GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - ./tests:/app/tests
    depends_on:
      - grafana
    networks:
      - ytrader-network
    profiles:
      - test
    command: ["pytest", "tests/integration", "-v", "-m", "integration"]

networks:
  ytrader-network:
    driver: bridge

volumes:
  postgres_data:
  rabbitmq_data:
  model_storage:
  grafana_data:
  redis_data:

