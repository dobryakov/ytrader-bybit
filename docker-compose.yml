services:
  ws-gateway:
    build:
      context: ./ws-gateway
      dockerfile: Dockerfile
    container_name: ws-gateway
    ports:
      - "127.0.0.1:${WS_GATEWAY_PORT:-4400}:4400"
    volumes:
      - ./ws-gateway/src:/app/src
      - ./ws-gateway/migrations:/app/migrations
      - ./ws-gateway/tests:/app/tests
      - ./ws-gateway/compare_balances.py:/app/compare_balances.py
    environment:
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - BYBIT_WS_STRATEGY=${BYBIT_WS_STRATEGY:-dual}
      - BYBIT_WS_PUBLIC_CATEGORY=${BYBIT_WS_PUBLIC_CATEGORY:-linear}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_TRADING_EVENTS_EXCHANGE=${RABBITMQ_TRADING_EVENTS_EXCHANGE:-trading_events}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - WS_GATEWAY_LOG_LEVEL=${WS_GATEWAY_LOG_LEVEL:-INFO}
      - WS_GATEWAY_SERVICE_NAME=${WS_GATEWAY_SERVICE_NAME:-ws-gateway}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      graylog:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped
    logging:
      driver: "gelf"
      options:
        gelf-address: "udp://127.0.0.1:4711"
        tag: "{{.Name}}"
        labels: "service"

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ytrader-network
    ports:
      - "127.0.0.1:5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ytrader}"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:-guest}
      # Настройки для уменьшения персистентности на диск
      # Минимальный свободный диск
      - RABBITMQ_DISK_FREE_LIMIT=50MB
      # Увеличиваем размер журнала перед синхронизацией на диск
      - RABBITMQ_QUEUE_INDEX_MAX_JOURNAL_ENTRIES=32768
      # Размер сообщений, встраиваемых в индекс (в байтах)
      - RABBITMQ_QUEUE_INDEX_EMBED_MSGS_BELOW=4096
      # Heartbeat для соединений (в секундах)
      - RABBITMQ_HEARTBEAT=60
      # Уровень логирования (warning вместо info для уменьшения записи)
      - RABBITMQ_LOG_LEVEL=warning
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "rabbitmq-diagnostics -q ping || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
#    deploy:
#      resources:
#        limits:
#          cpus: '0.5'

  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  model-service:
    build:
      context: ./model-service
      dockerfile: Dockerfile
    container_name: model-service
    ports:
      - "127.0.0.1:${MODEL_SERVICE_PORT:-4500}:4500"
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_TRADING_EVENTS_EXCHANGE=${RABBITMQ_TRADING_EVENTS_EXCHANGE:-trading_events}
      - MODEL_SERVICE_PORT=${MODEL_SERVICE_PORT:-4500}
      - MODEL_SERVICE_API_KEY=${MODEL_SERVICE_API_KEY}
      - MODEL_SERVICE_LOG_LEVEL=${MODEL_SERVICE_LOG_LEVEL:-INFO}
      - MODEL_SERVICE_SERVICE_NAME=${MODEL_SERVICE_SERVICE_NAME:-model-service}
      - MODEL_STORAGE_PATH=${MODEL_STORAGE_PATH:-/models}
      - MODEL_TRAINING_MIN_DATASET_SIZE=${MODEL_TRAINING_MIN_DATASET_SIZE:-1000}
      - MODEL_TRAINING_MAX_DURATION_SECONDS=${MODEL_TRAINING_MAX_DURATION_SECONDS:-1800}
      - MODEL_ACTIVATION_THRESHOLD=${MODEL_ACTIVATION_THRESHOLD:-0.75}
      - MODEL_TRAINING_THRESHOLD_OPTIMIZATION_METRIC=${MODEL_TRAINING_THRESHOLD_OPTIMIZATION_METRIC:-f1}
      - MODEL_RETRAINING_INTERVAL_DAYS=${MODEL_RETRAINING_INTERVAL_DAYS:-7}
      - MODEL_RETRAINING_CHECK_INTERVAL_HOURS=${MODEL_RETRAINING_CHECK_INTERVAL_HOURS:-6}
      - MODEL_RETRAINING_TRAIN_PERIOD_DAYS=${MODEL_RETRAINING_TRAIN_PERIOD_DAYS:-30}
      - MODEL_RETRAINING_VALIDATION_PERIOD_DAYS=${MODEL_RETRAINING_VALIDATION_PERIOD_DAYS:-7}
      - MODEL_RETRAINING_TEST_PERIOD_DAYS=${MODEL_RETRAINING_TEST_PERIOD_DAYS:-1}
      - MODEL_TRAINING_USE_SMOTE=${MODEL_TRAINING_USE_SMOTE:-false}
      - MODEL_TRAINING_CLASS_WEIGHT_METHOD=${MODEL_TRAINING_CLASS_WEIGHT_METHOD:-inverse_frequency}
      - MODEL_TRAINING_HYPERPARAMETER_TUNING=${MODEL_TRAINING_HYPERPARAMETER_TUNING:-false}
      - MODEL_TRAINING_TUNING_METHOD=${MODEL_TRAINING_TUNING_METHOD:-grid_search}
      - MODEL_TRAINING_TUNING_MAX_ITERATIONS=${MODEL_TRAINING_TUNING_MAX_ITERATIONS:-50}
      - MODEL_HYPERPARAMS_CONFIG_PATH=${MODEL_HYPERPARAMS_CONFIG_PATH:-config/model_hyperparams.yaml}
      - MODEL_PREDICTION_HORIZON_SECONDS=${MODEL_PREDICTION_HORIZON_SECONDS:-60}
      - MODEL_CLASSIFICATION_THRESHOLD=${MODEL_CLASSIFICATION_THRESHOLD:-0.005}
      - TARGET_REGISTRY_VERSION=${TARGET_REGISTRY_VERSION:-latest}
      - FEATURE_SERVICE_HOST=${FEATURE_SERVICE_HOST:-feature-service}
      - FEATURE_SERVICE_PORT=${FEATURE_SERVICE_PORT:-4900}
      - FEATURE_SERVICE_API_KEY=${FEATURE_SERVICE_API_KEY}
      - FEATURE_SERVICE_USE_QUEUE=${FEATURE_SERVICE_USE_QUEUE:-true}
      - FEATURE_SERVICE_FEATURE_CACHE_TTL_SECONDS=${FEATURE_SERVICE_FEATURE_CACHE_TTL_SECONDS:-30}
      - FEATURE_SERVICE_FEATURE_TIMEOUT_SECONDS=${FEATURE_SERVICE_FEATURE_TIMEOUT_SECONDS:-60}
      - FEATURE_SERVICE_DATASET_BUILD_TIMEOUT_SECONDS=${FEATURE_SERVICE_DATASET_BUILD_TIMEOUT_SECONDS:-3600}
      - FEATURE_SERVICE_DATASET_POLL_INTERVAL_SECONDS=${FEATURE_SERVICE_DATASET_POLL_INTERVAL_SECONDS:-60}
      - FEATURE_SERVICE_DATASET_STORAGE_PATH=${FEATURE_SERVICE_DATASET_STORAGE_PATH:-/datasets}
      - SIGNAL_GENERATION_RATE_LIMIT=${SIGNAL_GENERATION_RATE_LIMIT:-60}
      - SIGNAL_GENERATION_BURST_ALLOWANCE=${SIGNAL_GENERATION_BURST_ALLOWANCE:-10}
      - WARMUP_MODE_ENABLED=${WARMUP_MODE_ENABLED:-true}
      - WARMUP_SIGNAL_FREQUENCY=${WARMUP_SIGNAL_FREQUENCY:-60}
      - INTELLIGENT_SIGNAL_FREQUENCY=${INTELLIGENT_SIGNAL_FREQUENCY:-0.05}
      - WARMUP_MIN_AMOUNT=${WARMUP_MIN_AMOUNT:-100.0}
      - WARMUP_MAX_AMOUNT=${WARMUP_MAX_AMOUNT:-1000.0}
      - WARMUP_RANDOMNESS_LEVEL=${WARMUP_RANDOMNESS_LEVEL:-0.5}
      - WS_GATEWAY_HOST=${WS_GATEWAY_HOST:-ws-gateway}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - POSITION_MANAGER_HOST=${POSITION_MANAGER_HOST:-position-manager}
      - POSITION_MANAGER_PORT=${POSITION_MANAGER_PORT:-4800}
      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
      - TRADING_STRATEGIES=${TRADING_STRATEGIES:-momentum_v1}
      - MODEL_SERVICE_TAKE_PROFIT_PCT=${MODEL_SERVICE_TAKE_PROFIT_PCT:-3.0}
      - MODEL_SERVICE_MAX_POSITION_SIZE_RATIO=${MODEL_SERVICE_MAX_POSITION_SIZE_RATIO:-0.8}
      - ORDERMANAGER_MAX_POSITION_SIZE=${ORDERMANAGER_MAX_POSITION_SIZE:-2.0}
      - BALANCE_ADAPTATION_SAFETY_MARGIN=${BALANCE_ADAPTATION_SAFETY_MARGIN:-0.95}
      - BALANCE_DATA_MAX_AGE_SECONDS=${BALANCE_DATA_MAX_AGE_SECONDS:-60}
      - MARKET_DATA_MAX_AGE_SECONDS=${MARKET_DATA_MAX_AGE_SECONDS:-60}
      - MARKET_DATA_STALE_WARNING_THRESHOLD_SECONDS=${MARKET_DATA_STALE_WARNING_THRESHOLD_SECONDS:-30}
      - SIGNAL_PROCESSING_DELAY_ALERT_THRESHOLD_SECONDS=${SIGNAL_PROCESSING_DELAY_ALERT_THRESHOLD_SECONDS:-300}
      - TARGET_EVALUATION_BASE_INTERVAL_SECONDS=${TARGET_EVALUATION_BASE_INTERVAL_SECONDS:-10}
      - TARGET_EVALUATION_MIN_INTERVAL_SECONDS=${TARGET_EVALUATION_MIN_INTERVAL_SECONDS:-5}
      - TARGET_EVALUATION_MAX_INTERVAL_SECONDS=${TARGET_EVALUATION_MAX_INTERVAL_SECONDS:-60}
      - FEATURE_SERVICE_TARGET_COMPUTATION_MAX_LOOKBACK_SECONDS=${FEATURE_SERVICE_TARGET_COMPUTATION_MAX_LOOKBACK_SECONDS:-300}
      - VERSION_MISMATCH_RETRAINING_INTERVAL_HOURS=${VERSION_MISMATCH_RETRAINING_INTERVAL_HOURS:-24}
      - BALANCE_SYNC_ENABLED=${BALANCE_SYNC_ENABLED:-true}
      - BALANCE_SYNC_MIN_INTERVAL_SECONDS=${BALANCE_SYNC_MIN_INTERVAL_SECONDS:-30}
      - BALANCE_SYNC_TIMEOUT_SECONDS=${BALANCE_SYNC_TIMEOUT_SECONDS:-5.0}
      - EXIT_STRATEGY_ENABLED=${EXIT_STRATEGY_ENABLED:-false}
    volumes:
      - model_storage:/models
      - model_datasets:/datasets
      - ./model-service/src:/app/src
      - ./model-service/tests:/app/tests
      # Mount model hyperparameters and other config files into container
      - ./model-service/config:/app/config
      - ./common:/app/common
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      ws-gateway:
        condition: service_started
      feature-service:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "gelf"
      options:
        gelf-address: "udp://127.0.0.1:4711"
        tag: "{{.Name}}"
        labels: "service"

  feature-service:
    build:
      context: ./feature-service
      dockerfile: Dockerfile
    container_name: feature-service
    ports:
      - "127.0.0.1:${FEATURE_SERVICE_PORT:-4900}:4900"
    deploy:
      resources:
        limits:
          cpus: '1.0'
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_TRADING_EVENTS_EXCHANGE=${RABBITMQ_TRADING_EVENTS_EXCHANGE:-trading_events}
      - FEATURE_SERVICE_PORT=${FEATURE_SERVICE_PORT:-4900}
      - FEATURE_SERVICE_API_KEY=${FEATURE_SERVICE_API_KEY}
      - FEATURE_SERVICE_LOG_LEVEL=${FEATURE_SERVICE_LOG_LEVEL:-INFO}
      - FEATURE_SERVICE_SERVICE_NAME=${FEATURE_SERVICE_SERVICE_NAME:-feature-service}
      - WS_GATEWAY_HOST=${WS_GATEWAY_HOST:-ws-gateway}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - RAW_DATA_STORAGE_PATH=${RAW_DATA_STORAGE_PATH:-/data/raw}
      - RAW_DATA_RETENTION_DAYS=${RAW_DATA_RETENTION_DAYS:-90}
      - DATASET_STORAGE_PATH=${DATASET_STORAGE_PATH:-/data/datasets}
      - FEATURE_REGISTRY_CONFIG_PATH=${FEATURE_REGISTRY_CONFIG_PATH:-/app/config/feature_registry.yaml}
      - FEATURE_COMPUTATION_LATENCY_WARNING_MS=${FEATURE_COMPUTATION_LATENCY_WARNING_MS:-70}
      - DATA_QUALITY_MONITORING_ENABLED=${DATA_QUALITY_MONITORING_ENABLED:-true}
      - DATA_QUALITY_REPORT_TIMEOUT_SECONDS=${DATA_QUALITY_REPORT_TIMEOUT_SECONDS:-5}
      - FEATURE_SERVICE_SYMBOLS=${FEATURE_SERVICE_SYMBOLS:-}
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - BYBIT_MARKET_CATEGORY=${BYBIT_MARKET_CATEGORY:-linear}
      - FEATURE_SERVICE_BACKFILL_RATE_LIMIT_DELAY_MS=${FEATURE_SERVICE_BACKFILL_RATE_LIMIT_DELAY_MS:-100}
      - FEATURE_SERVICE_BACKFILL_ENABLED=${FEATURE_SERVICE_BACKFILL_ENABLED:-true}
      - FEATURE_SERVICE_BACKFILL_AUTO=${FEATURE_SERVICE_BACKFILL_AUTO:-true}
      - FEATURE_SERVICE_BACKFILL_MAX_DAYS=${FEATURE_SERVICE_BACKFILL_MAX_DAYS:-90}
      - FEATURE_SERVICE_BACKFILL_DEFAULT_INTERVAL=${FEATURE_SERVICE_BACKFILL_DEFAULT_INTERVAL:-1}
      - MODEL_CLASSIFICATION_THRESHOLD=${MODEL_CLASSIFICATION_THRESHOLD:-0.005}
      - DATASET_MAX_FEATURE_NAN_RATIO=${DATASET_MAX_FEATURE_NAN_RATIO:-0.5}
      - DATASET_MAX_ROW_NAN_RATIO=${DATASET_MAX_ROW_NAN_RATIO:-0.8}
      - DATASET_MIN_VALID_FEATURES_RATIO=${DATASET_MIN_VALID_FEATURES_RATIO:-0.3}
      - DATASET_FAIL_ON_HIGH_NAN_RATIO=${DATASET_FAIL_ON_HIGH_NAN_RATIO:-false}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-10}
      - REDIS_SOCKET_TIMEOUT=${REDIS_SOCKET_TIMEOUT:-5}
      - REDIS_SOCKET_CONNECT_TIMEOUT=${REDIS_SOCKET_CONNECT_TIMEOUT:-5}
      - CACHE_REDIS_ENABLED=${CACHE_REDIS_ENABLED:-true}
      - CACHE_TTL_HISTORICAL_DATA_SECONDS=${CACHE_TTL_HISTORICAL_DATA_SECONDS:-86400}
      - CACHE_TTL_FEATURES_SECONDS=${CACHE_TTL_FEATURES_SECONDS:-604800}
      - CACHE_MAX_SIZE_MB=${CACHE_MAX_SIZE_MB:-1024}
      - CACHE_MAX_ENTRIES=${CACHE_MAX_ENTRIES:-10000}
      - DATASET_BUILDER_CACHE_ENABLED=${DATASET_BUILDER_CACHE_ENABLED:-true}
      - DATASET_BUILDER_CACHE_HISTORICAL_DATA_ENABLED=${DATASET_BUILDER_CACHE_HISTORICAL_DATA_ENABLED:-true}
      - DATASET_BUILDER_CACHE_FEATURES_ENABLED=${DATASET_BUILDER_CACHE_FEATURES_ENABLED:-true}
      - CACHE_INVALIDATION_ON_REGISTRY_CHANGE=${CACHE_INVALIDATION_ON_REGISTRY_CHANGE:-true}
      - CACHE_INVALIDATION_ON_DATA_CHANGE=${CACHE_INVALIDATION_ON_DATA_CHANGE:-true}
      - DATASET_BUILDER_BATCH_SIZE=${DATASET_BUILDER_BATCH_SIZE:-1000}
      - TARGET_COMPUTATION_MAX_EXPECTED_DELAY_SECONDS=${TARGET_COMPUTATION_MAX_EXPECTED_DELAY_SECONDS:-30}
      - TARGET_COMPUTATION_MAX_LOOKBACK_SECONDS=${TARGET_COMPUTATION_MAX_LOOKBACK_SECONDS:-300}
      - TARGET_COMPUTATION_DATA_BUFFER_SECONDS=${TARGET_COMPUTATION_DATA_BUFFER_SECONDS:-60}
    volumes:
      - ./feature-service/src:/app/src
      - ./feature-service/config:/app/config
      - ./feature-service/config/versions:/app/config/versions
      - ./feature-service/tests:/app/tests
      - ./feature-service/scripts:/app/scripts
      - feature_raw_data:/data/raw
      - feature_datasets:/data/datasets
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      ws-gateway:
        condition: service_started
      graylog:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4900/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "gelf"
      options:
        gelf-address: "udp://127.0.0.1:4711"
        tag: "{{.Name}}"
        labels: "service"

  order-manager:
    build:
      context: ./order-manager
      dockerfile: Dockerfile
    container_name: order-manager
    ports:
      - "127.0.0.1:${ORDERMANAGER_PORT:-4600}:4600"
    environment:
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - BYBIT_MARKET_CATEGORY=${BYBIT_MARKET_CATEGORY:-linear}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_TRADING_EVENTS_EXCHANGE=${RABBITMQ_TRADING_EVENTS_EXCHANGE:-trading_events}
      - ORDERMANAGER_PORT=${ORDERMANAGER_PORT:-4600}
      - ORDERMANAGER_API_KEY=${ORDERMANAGER_API_KEY}
      - ORDERMANAGER_LOG_LEVEL=${ORDERMANAGER_LOG_LEVEL:-INFO}
      - ORDERMANAGER_SERVICE_NAME=${ORDERMANAGER_SERVICE_NAME:-order-manager}
      - WS_GATEWAY_HOST=${WS_GATEWAY_HOST:-ws-gateway}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - POSITION_MANAGER_HOST=${POSITION_MANAGER_HOST:-position-manager}
      - POSITION_MANAGER_PORT=${POSITION_MANAGER_PORT:-4800}
      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
      - ORDERMANAGER_ENABLE_DRY_RUN=${ORDERMANAGER_ENABLE_DRY_RUN:-false}
      - ORDERMANAGER_MAX_SINGLE_ORDER_SIZE=${ORDERMANAGER_MAX_SINGLE_ORDER_SIZE:-500.0}
      - ORDERMANAGER_ENABLE_ORDER_SPLITTING=${ORDERMANAGER_ENABLE_ORDER_SPLITTING:-false}
      - ORDERMANAGER_ORDER_EXECUTION_TIMEOUT=${ORDERMANAGER_ORDER_EXECUTION_TIMEOUT:-30}
      - ORDERMANAGER_MAX_POSITION_SIZE=${ORDERMANAGER_MAX_POSITION_SIZE:-2.0}
      - ORDERMANAGER_MAX_EXPOSURE=${ORDERMANAGER_MAX_EXPOSURE:-10000.0}
      - ORDERMANAGER_MAX_ORDER_SIZE_RATIO=${ORDERMANAGER_MAX_ORDER_SIZE_RATIO:-0.1}
      - ORDERMANAGER_BYBIT_API_RETRY_MAX_ATTEMPTS=${ORDERMANAGER_BYBIT_API_RETRY_MAX_ATTEMPTS:-3}
      - ORDERMANAGER_BYBIT_API_RETRY_BASE_DELAY=${ORDERMANAGER_BYBIT_API_RETRY_BASE_DELAY:-1.0}
      - ORDERMANAGER_BYBIT_API_RETRY_MAX_DELAY=${ORDERMANAGER_BYBIT_API_RETRY_MAX_DELAY:-30.0}
      - ORDERMANAGER_BYBIT_API_RETRY_MULTIPLIER=${ORDERMANAGER_BYBIT_API_RETRY_MULTIPLIER:-2.0}
      - ORDERMANAGER_MARKET_ORDER_CONFIDENCE_THRESHOLD=${ORDERMANAGER_MARKET_ORDER_CONFIDENCE_THRESHOLD:-0.9}
      - ORDERMANAGER_MARKET_ORDER_SPREAD_THRESHOLD=${ORDERMANAGER_MARKET_ORDER_SPREAD_THRESHOLD:-0.1}
      - ORDERMANAGER_LIMIT_ORDER_PRICE_OFFSET_RATIO=${ORDERMANAGER_LIMIT_ORDER_PRICE_OFFSET_RATIO:-0.5}
      - ORDERMANAGER_POSITION_SNAPSHOT_INTERVAL=${ORDERMANAGER_POSITION_SNAPSHOT_INTERVAL:-300}
      - ORDERMANAGER_POSITION_VALIDATION_INTERVAL=${ORDERMANAGER_POSITION_VALIDATION_INTERVAL:-3600}
      - ORDERMANAGER_PENDING_ORDER_TIMEOUT_MINUTES=${ORDERMANAGER_PENDING_ORDER_TIMEOUT_MINUTES:-5}
      - ORDERMANAGER_PENDING_ORDER_CHECK_INTERVAL=${ORDERMANAGER_PENDING_ORDER_CHECK_INTERVAL:-60}
      - ORDERMANAGER_CANCEL_OPPOSITE_ORDERS_ONLY=${ORDERMANAGER_CANCEL_OPPOSITE_ORDERS_ONLY:-false}
      - ORDERMANAGER_CANCEL_STALE_ORDER_TIMEOUT=${ORDERMANAGER_CANCEL_STALE_ORDER_TIMEOUT:-3600}
      - ORDERMANAGER_UNREALIZED_LOSS_WARNING_THRESHOLD=${ORDERMANAGER_UNREALIZED_LOSS_WARNING_THRESHOLD:-10.0}
      - ORDERMANAGER_ENABLE_BALANCE_CHECK=${ORDERMANAGER_ENABLE_BALANCE_CHECK:-true}
      - ORDERMANAGER_ENABLE_ORDER_SIZE_REDUCTION=${ORDERMANAGER_ENABLE_ORDER_SIZE_REDUCTION:-true}
      - ORDERMANAGER_TP_SL_ENABLED=${ORDERMANAGER_TP_SL_ENABLED:-true}
      - ORDERMANAGER_TP_ENABLED=${ORDERMANAGER_TP_ENABLED:-true}
      - ORDERMANAGER_TP_THRESHOLD_PCT=${ORDERMANAGER_TP_THRESHOLD_PCT:-3.0}
      - ORDERMANAGER_SL_ENABLED=${ORDERMANAGER_SL_ENABLED:-true}
      - ORDERMANAGER_SL_THRESHOLD_PCT=${ORDERMANAGER_SL_THRESHOLD_PCT:--2.0}
      - ORDERMANAGER_TP_SL_PRIORITY=${ORDERMANAGER_TP_SL_PRIORITY:-metadata}
      - ORDERMANAGER_TP_SL_TRIGGER_BY=${ORDERMANAGER_TP_SL_TRIGGER_BY:-LastPrice}
      - ORDERMANAGER_EXIT_TP_ENABLED=${ORDERMANAGER_EXIT_TP_ENABLED:-true}
      - ORDERMANAGER_EXIT_TP_THRESHOLD_PCT=${ORDERMANAGER_EXIT_TP_THRESHOLD_PCT:-3.0}
      - ORDERMANAGER_EXIT_SL_ENABLED=${ORDERMANAGER_EXIT_SL_ENABLED:-true}
      - ORDERMANAGER_EXIT_SL_THRESHOLD_PCT=${ORDERMANAGER_EXIT_SL_THRESHOLD_PCT:--2.0}
      - ORDERMANAGER_EXCHANGE_TRAILING_STOP_ENABLED=${ORDERMANAGER_EXCHANGE_TRAILING_STOP_ENABLED:-false}
      - ORDERMANAGER_TRAILING_STOP_ACTIVATION_PCT=${ORDERMANAGER_TRAILING_STOP_ACTIVATION_PCT:-2.0}
      - ORDERMANAGER_TRAILING_STOP_DISTANCE_PCT=${ORDERMANAGER_TRAILING_STOP_DISTANCE_PCT:-1.0}
      - ORDERMANAGER_TRAILING_STOP_APPLY_TO_SIDE=${ORDERMANAGER_TRAILING_STOP_APPLY_TO_SIDE:-LONG}
      - ORDERMANAGER_CLOSE_POSITION_BEFORE_OPPOSITE_SIGNAL=${ORDERMANAGER_CLOSE_POSITION_BEFORE_OPPOSITE_SIGNAL:-true}
      - ORDERMANAGER_POSITION_CLOSE_TIMEOUT_SECONDS=${ORDERMANAGER_POSITION_CLOSE_TIMEOUT_SECONDS:-30}
      - ORDERMANAGER_POSITION_CLOSE_WAIT_MODE=${ORDERMANAGER_POSITION_CLOSE_WAIT_MODE:-none}
      - ORDERMANAGER_POSITION_CLOSE_MIN_SIZE_THRESHOLD=${ORDERMANAGER_POSITION_CLOSE_MIN_SIZE_THRESHOLD:-0.00000001}
      - ORDERMANAGER_POSITION_MAX_AGE_SECONDS=${ORDERMANAGER_POSITION_MAX_AGE_SECONDS:-60}
      - ORDERMANAGER_ENABLE_BYBIT_POSITION_FALLBACK=${ORDERMANAGER_ENABLE_BYBIT_POSITION_FALLBACK:-true}
      - ORDERMANAGER_AUTO_SYNC_POSITION_AFTER_BYBIT_FETCH=${ORDERMANAGER_AUTO_SYNC_POSITION_AFTER_BYBIT_FETCH:-true}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - ./order-manager/src:/app/src
      - ./order-manager/scripts:/app/scripts
      - ./order-manager/tests:/app/tests
      - ./common:/app/common
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      ws-gateway:
        condition: service_started
      position-manager:
        condition: service_started
      graylog:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped
    logging:
      driver: "gelf"
      options:
        gelf-address: "udp://127.0.0.1:4711"
        tag: "{{.Name}}"
        labels: "service"

  position-manager:
    build:
      context: ./position-manager
      dockerfile: Dockerfile
    container_name: position-manager
    ports:
      - "127.0.0.1:${POSITION_MANAGER_PORT:-4800}:4800"
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_TRADING_EVENTS_EXCHANGE=${RABBITMQ_TRADING_EVENTS_EXCHANGE:-trading_events}
      - POSITION_MANAGER_PORT=${POSITION_MANAGER_PORT:-4800}
      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
      - POSITION_MANAGER_LOG_LEVEL=${POSITION_MANAGER_LOG_LEVEL:-INFO}
      - POSITION_MANAGER_SERVICE_NAME=${POSITION_MANAGER_SERVICE_NAME:-position-manager}
      - POSITION_MANAGER_SNAPSHOT_INTERVAL=${POSITION_MANAGER_SNAPSHOT_INTERVAL:-3600}
      - POSITION_MANAGER_SNAPSHOT_RETENTION_DAYS=${POSITION_MANAGER_SNAPSHOT_RETENTION_DAYS:-365}
      - POSITION_MANAGER_VALIDATION_INTERVAL=${POSITION_MANAGER_VALIDATION_INTERVAL:-1800}
      - POSITION_MANAGER_BYBIT_SYNC_INTERVAL=${POSITION_MANAGER_BYBIT_SYNC_INTERVAL:-3600}
      - POSITION_MANAGER_METRICS_CACHE_TTL=${POSITION_MANAGER_METRICS_CACHE_TTL:-10}
      - POSITION_MANAGER_USE_WS_AVG_PRICE=${POSITION_MANAGER_USE_WS_AVG_PRICE:-true}
      - POSITION_MANAGER_AVG_PRICE_DIFF_THRESHOLD=${POSITION_MANAGER_AVG_PRICE_DIFF_THRESHOLD:-0.001}
      - POSITION_MANAGER_SIZE_VALIDATION_THRESHOLD=${POSITION_MANAGER_SIZE_VALIDATION_THRESHOLD:-0.0001}
      - POSITION_MANAGER_PRICE_STALENESS_THRESHOLD=${POSITION_MANAGER_PRICE_STALENESS_THRESHOLD:-300}
      - POSITION_MANAGER_PRICE_API_TIMEOUT=${POSITION_MANAGER_PRICE_API_TIMEOUT:-5}
      - POSITION_MANAGER_PRICE_API_RETRIES=${POSITION_MANAGER_PRICE_API_RETRIES:-3}
      - POSITION_MANAGER_OPTIMISTIC_LOCK_RETRIES=${POSITION_MANAGER_OPTIMISTIC_LOCK_RETRIES:-3}
      - POSITION_MANAGER_OPTIMISTIC_LOCK_BACKOFF_BASE=${POSITION_MANAGER_OPTIMISTIC_LOCK_BACKOFF_BASE:-100}
      - POSITION_MANAGER_RATE_LIMIT_ENABLED=${POSITION_MANAGER_RATE_LIMIT_ENABLED:-true}
      - POSITION_MANAGER_RATE_LIMIT_DEFAULT=${POSITION_MANAGER_RATE_LIMIT_DEFAULT:-100}
      - POSITION_MANAGER_RATE_LIMIT_OVERRIDES=${POSITION_MANAGER_RATE_LIMIT_OVERRIDES:-}
      - WS_GATEWAY_URL=${WS_GATEWAY_URL:-http://ws-gateway:4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - BYBIT_MARKET_CATEGORY=${BYBIT_MARKET_CATEGORY:-linear}
    volumes:
      - ./position-manager/src:/app/src
      - ./position-manager/tests:/app/tests
      - ./common:/app/common
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      graylog:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4800/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "gelf"
      options:
        gelf-address: "udp://127.0.0.1:4711"
        tag: "{{.Name}}"
        labels: "service"

  mongo:
    image: mongo:7
    container_name: mongo
    command: mongod --port 4702 --bind_ip_all
    environment:
      - MONGO_INITDB_DATABASE=graylog
    volumes:
      - mongo_data:/data/db
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--port", "4702", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
      - http.port=4703
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4703/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

#  kibana:
#    image: docker.elastic.co/kibana/kibana:7.17.0
#    container_name: kibana
#    ports:
#      - "127.0.0.1:${KIBANA_PORT:-4704}:4704"
#    environment:
#      - SERVER_PORT=4704
#      - SERVER_HOST=0.0.0.0
#      - ELASTICSEARCH_HOSTS=http://elasticsearch:4703
#      - XPACK_SECURITY_ENABLED=false
#      - XPACK_REPORTING_ENABLED=false
#      - XPACK_FLEET_ENABLED=false
#    depends_on:
#      elasticsearch:
#        condition: service_healthy
#    networks:
#      - ytrader-network
#    restart: unless-stopped
#    healthcheck:
#      test: ["CMD", "curl", "-f", "http://localhost:4704/api/status"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 60s

  graylog:
    image: graylog/graylog:5.2
    container_name: graylog
    ports:
      - "127.0.0.1:${GRAYLOG_WEB_PORT:-4701}:4701"
      - "127.0.0.1:${GRAYLOG_GELF_PORT:-4711}:4711/udp"
    environment:
      - GRAYLOG_PASSWORD_SECRET=${GRAYLOG_PASSWORD_SECRET}
      - GRAYLOG_ROOT_PASSWORD_SHA2=${GRAYLOG_ROOT_PASSWORD_SHA2}
      - GRAYLOG_ROOT_PASSWORD=${GRAYLOG_ROOT_PASSWORD}
      - GRAYLOG_HTTP_EXTERNAL_URI=http://graylog:4701/
      - GRAYLOG_HTTP_BIND_ADDRESS=0.0.0.0:4701
      - GRAYLOG_HTTP_PUBLISH_URI=http://graylog:4701/
      - GRAYLOG_ELASTICSEARCH_HOSTS=http://elasticsearch:4703
      - GRAYLOG_MONGODB_URI=mongodb://mongo:4702/graylog
    volumes:
      - graylog_data:/usr/share/graylog/data
    depends_on:
      mongo:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4701/api/system/lbstatus"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

#  trading-events-forwarder:
#    build:
#      context: ./trading-events-forwarder
#      dockerfile: Dockerfile
#    container_name: trading-events-forwarder
#    volumes:
#      - ./trading-events-forwarder/src:/app/src
#    environment:
#      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
#      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
#      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
#      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
#      - RABBITMQ_TRADING_EVENTS_EXCHANGE=${RABBITMQ_TRADING_EVENTS_EXCHANGE:-trading_events}
#      - RABBITMQ_TRADING_EVENTS_QUEUE=${RABBITMQ_TRADING_EVENTS_QUEUE:-trading_events_forwarder}
#      - GRAYLOG_HOST=${GRAYLOG_HOST:-graylog}
#      - GRAYLOG_CUSTOM_EVENTS_GELF_PORT=${GRAYLOG_CUSTOM_EVENTS_GELF_PORT:-4712}
#      - TRADING_EVENTS_FORWARDER_SERVICE_NAME=${TRADING_EVENTS_FORWARDER_SERVICE_NAME:-trading-events-forwarder}
#      - TRADING_EVENTS_FORWARDER_LOG_LEVEL=${TRADING_EVENTS_FORWARDER_LOG_LEVEL:-INFO}
#      - ENVIRONMENT=${ENVIRONMENT:-production}
#    depends_on:
#      rabbitmq:
#        condition: service_healthy
#      graylog:
#        condition: service_started
#    networks:
#      - ytrader-network
#    restart: unless-stopped
#    healthcheck:
#      test: ["CMD", "python", "-m", "src.healthcheck"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 30s

  dashboard-api:
    build:
      context: ./dashboard-api
      dockerfile: Dockerfile
    container_name: dashboard-api
    ports:
      - "127.0.0.1:${DASHBOARD_API_PORT:-4050}:4050"
    volumes:
      - ./dashboard-api/src:/app/src
      - ./dashboard-api/tests:/app/tests
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - DASHBOARD_API_PORT=${DASHBOARD_API_PORT:-4050}
      - DASHBOARD_API_KEY=${DASHBOARD_API_KEY}
      - DASHBOARD_API_LOG_LEVEL=${DASHBOARD_API_LOG_LEVEL:-INFO}
      - DASHBOARD_API_SERVICE_NAME=${DASHBOARD_API_SERVICE_NAME:-dashboard-api}
      - MODEL_SERVICE_HOST=${MODEL_SERVICE_HOST:-model-service}
      - MODEL_SERVICE_PORT=${MODEL_SERVICE_PORT:-4500}
      - MODEL_SERVICE_API_KEY=${MODEL_SERVICE_API_KEY}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "gelf"
      options:
        gelf-address: "udp://127.0.0.1:4711"
        tag: "{{.Name}}"
        labels: "service"

  dashboard-frontend:
    build:
      context: ./dashboard-frontend
      dockerfile: Dockerfile.dev
    container_name: dashboard-frontend
    ports:
      - "127.0.0.1:${DASHBOARD_FRONTEND_PORT:-4051}:4051"
    volumes:
      # Mount entire directory for live reload, but exclude node_modules
      - ./dashboard-frontend:/app
      # Use anonymous volume for node_modules to preserve container's dependencies
      - /app/node_modules
    environment:
      # Use relative path /api for dev proxy to work
      # VITE_API_URL is not set, so api.ts will use '/api' as default
      - VITE_API_KEY=${DASHBOARD_API_KEY}
      - NODE_ENV=development
    depends_on:
      - dashboard-api
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "--timeout=5", "http://127.0.0.1:4051"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Use stdin_open and tty for better terminal interaction if needed
    stdin_open: true
    tty: true


#  grafana:
#    build:
#      context: ./grafana
#      dockerfile: Dockerfile
#    container_name: grafana
#    ports:
#      - "127.0.0.1:${GRAFANA_PORT:-4700}:3000"
#    environment:
#      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
#      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
#      - GF_INSTALL_PLUGINS=yesoreyeram-infinity-datasource
#      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
#      - GRAFANA_POSTGRES_USER=${GRAFANA_POSTGRES_USER:-grafana_monitor}
#      - GRAFANA_POSTGRES_PASSWORD=${GRAFANA_POSTGRES_PASSWORD}
#      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
#      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
#      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
#      - MODEL_SERVICE_API_KEY=${MODEL_SERVICE_API_KEY}
#    volumes:
#      - grafana_data:/var/lib/grafana
#      - ./grafana/provisioning:/etc/grafana/provisioning
#      - ./grafana/dashboards:/var/lib/grafana/dashboards
#    depends_on:
#      - postgres
#      - rabbitmq
#    networks:
#      - ytrader-network
#    restart: unless-stopped
#    healthcheck:
#      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s

  test-grafana:
    build:
      context: ./tests
      dockerfile: Dockerfile
    container_name: test-grafana
    environment:
      - DOCKER_ENV=true
      - GRAFANA_HOST=grafana
      - GRAFANA_PORT=3000
      - GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - ORDERMANAGER_ENABLE_DRY_RUN=${ORDERMANAGER_ENABLE_DRY_RUN:-true}
      - ORDERMANAGER_API_KEY=${ORDERMANAGER_API_KEY}
      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - MODEL_SERVICE_HOST=${MODEL_SERVICE_HOST:-model-service}
      - MODEL_SERVICE_PORT=${MODEL_SERVICE_PORT:-4500}
      - MODEL_SERVICE_API_KEY=${MODEL_SERVICE_API_KEY}
    volumes:
      - ./tests:/app/tests
      - ./order-manager:/app/order-manager
      - ./position-manager:/app/position-manager
    depends_on:
      grafana:
        condition: service_started
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      ws-gateway:
        condition: service_started
      model-service:
        condition: service_started
      order-manager:
        condition: service_started
      position-manager:
        condition: service_started
    networks:
      - ytrader-network
    profiles:
      - test
    command: ["pytest", "tests/integration", "-v", "-m", "integration"]

networks:
  ytrader-network:
    driver: bridge

volumes:
  postgres_data:
  rabbitmq_data:
  model_storage:
  model_datasets:
  grafana_data:
  redis_data:
  feature_raw_data:
  feature_datasets:
  mongo_data:
  elasticsearch_data:
  graylog_data:

