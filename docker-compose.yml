services:
  ws-gateway:
    build:
      context: ./ws-gateway
      dockerfile: Dockerfile
    container_name: ws-gateway
    ports:
      - "${WS_GATEWAY_PORT:-4400}:4400"
    volumes:
      - ./ws-gateway/src:/app/src
      - ./ws-gateway/migrations:/app/migrations
      - ./ws-gateway/tests:/app/tests
      - ./ws-gateway/compare_balances.py:/app/compare_balances.py
    environment:
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - BYBIT_WS_STRATEGY=${BYBIT_WS_STRATEGY:-dual}
      - BYBIT_WS_PUBLIC_CATEGORY=${BYBIT_WS_PUBLIC_CATEGORY:-linear}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - WS_GATEWAY_LOG_LEVEL=${WS_GATEWAY_LOG_LEVEL:-INFO}
      - WS_GATEWAY_SERVICE_NAME=${WS_GATEWAY_SERVICE_NAME:-ws-gateway}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - ytrader-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "3"

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ytrader}"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:-guest}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "rabbitmq-diagnostics -q ping || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'

  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  model-service:
    build:
      context: ./model-service
      dockerfile: Dockerfile
    container_name: model-service
    ports:
      - "${MODEL_SERVICE_PORT:-4500}:4500"
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - MODEL_SERVICE_PORT=${MODEL_SERVICE_PORT:-4500}
      - MODEL_SERVICE_API_KEY=${MODEL_SERVICE_API_KEY}
      - MODEL_SERVICE_LOG_LEVEL=${MODEL_SERVICE_LOG_LEVEL:-INFO}
      - MODEL_SERVICE_SERVICE_NAME=${MODEL_SERVICE_SERVICE_NAME:-model-service}
      - MODEL_STORAGE_PATH=${MODEL_STORAGE_PATH:-/models}
      - MODEL_TRAINING_MIN_DATASET_SIZE=${MODEL_TRAINING_MIN_DATASET_SIZE:-1000}
      - MODEL_TRAINING_MAX_DURATION_SECONDS=${MODEL_TRAINING_MAX_DURATION_SECONDS:-1800}
      - MODEL_QUALITY_THRESHOLD_ACCURACY=${MODEL_QUALITY_THRESHOLD_ACCURACY:-0.75}
      - MODEL_RETRAINING_SCHEDULE=${MODEL_RETRAINING_SCHEDULE:-}
      - MODEL_RETRAINING_INTERVAL_DAYS=${MODEL_RETRAINING_INTERVAL_DAYS:-7}
      - MODEL_RETRAINING_TRAIN_PERIOD_DAYS=${MODEL_RETRAINING_TRAIN_PERIOD_DAYS:-30}
      - MODEL_RETRAINING_VALIDATION_PERIOD_DAYS=${MODEL_RETRAINING_VALIDATION_PERIOD_DAYS:-7}
      - MODEL_RETRAINING_TEST_PERIOD_DAYS=${MODEL_RETRAINING_TEST_PERIOD_DAYS:-1}
      - MODEL_TRAINING_USE_SMOTE=${MODEL_TRAINING_USE_SMOTE:-false}
      - MODEL_TRAINING_CLASS_WEIGHT_METHOD=${MODEL_TRAINING_CLASS_WEIGHT_METHOD:-inverse_frequency}
      - MODEL_TRAINING_HYPERPARAMETER_TUNING=${MODEL_TRAINING_HYPERPARAMETER_TUNING:-false}
      - MODEL_TRAINING_TUNING_METHOD=${MODEL_TRAINING_TUNING_METHOD:-grid_search}
      - MODEL_TRAINING_TUNING_MAX_ITERATIONS=${MODEL_TRAINING_TUNING_MAX_ITERATIONS:-50}
      - MODEL_HYPERPARAMS_CONFIG_PATH=${MODEL_HYPERPARAMS_CONFIG_PATH:-config/model_hyperparams.yaml}
      - MODEL_PREDICTION_HORIZON_SECONDS=${MODEL_PREDICTION_HORIZON_SECONDS:-60}
      - MODEL_CLASSIFICATION_THRESHOLD=${MODEL_CLASSIFICATION_THRESHOLD:-0.005}
      - TARGET_REGISTRY_VERSION=${TARGET_REGISTRY_VERSION:-latest}
      - FEATURE_SERVICE_HOST=${FEATURE_SERVICE_HOST:-feature-service}
      - FEATURE_SERVICE_PORT=${FEATURE_SERVICE_PORT:-4900}
      - FEATURE_SERVICE_API_KEY=${FEATURE_SERVICE_API_KEY}
      - FEATURE_SERVICE_USE_QUEUE=${FEATURE_SERVICE_USE_QUEUE:-true}
      - FEATURE_SERVICE_FEATURE_CACHE_TTL_SECONDS=${FEATURE_SERVICE_FEATURE_CACHE_TTL_SECONDS:-30}
      - FEATURE_SERVICE_DATASET_BUILD_TIMEOUT_SECONDS=${FEATURE_SERVICE_DATASET_BUILD_TIMEOUT_SECONDS:-3600}
      - FEATURE_SERVICE_DATASET_POLL_INTERVAL_SECONDS=${FEATURE_SERVICE_DATASET_POLL_INTERVAL_SECONDS:-60}
      - FEATURE_SERVICE_DATASET_STORAGE_PATH=${FEATURE_SERVICE_DATASET_STORAGE_PATH:-/datasets}
      - SIGNAL_GENERATION_RATE_LIMIT=${SIGNAL_GENERATION_RATE_LIMIT:-60}
      - SIGNAL_GENERATION_BURST_ALLOWANCE=${SIGNAL_GENERATION_BURST_ALLOWANCE:-10}
      - WARMUP_MODE_ENABLED=${WARMUP_MODE_ENABLED:-true}
      - WARMUP_SIGNAL_FREQUENCY=${WARMUP_SIGNAL_FREQUENCY:-60}
      - WARMUP_MIN_AMOUNT=${WARMUP_MIN_AMOUNT:-100.0}
      - WARMUP_MAX_AMOUNT=${WARMUP_MAX_AMOUNT:-1000.0}
      - WARMUP_RANDOMNESS_LEVEL=${WARMUP_RANDOMNESS_LEVEL:-0.5}
      - WS_GATEWAY_HOST=${WS_GATEWAY_HOST:-ws-gateway}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - POSITION_MANAGER_HOST=${POSITION_MANAGER_HOST:-position-manager}
      - POSITION_MANAGER_PORT=${POSITION_MANAGER_PORT:-4800}
      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
      - TRADING_STRATEGIES=${TRADING_STRATEGIES:-momentum_v1}
      - MODEL_SERVICE_TAKE_PROFIT_PCT=${MODEL_SERVICE_TAKE_PROFIT_PCT:-3.0}
      - MODEL_SERVICE_MAX_POSITION_SIZE_RATIO=${MODEL_SERVICE_MAX_POSITION_SIZE_RATIO:-0.8}
      - ORDERMANAGER_MAX_POSITION_SIZE=${ORDERMANAGER_MAX_POSITION_SIZE:-2.0}
      - BALANCE_ADAPTATION_SAFETY_MARGIN=${BALANCE_ADAPTATION_SAFETY_MARGIN:-0.95}
      - BALANCE_DATA_MAX_AGE_SECONDS=${BALANCE_DATA_MAX_AGE_SECONDS:-60}
      - MARKET_DATA_MAX_AGE_SECONDS=${MARKET_DATA_MAX_AGE_SECONDS:-60}
      - MARKET_DATA_STALE_WARNING_THRESHOLD_SECONDS=${MARKET_DATA_STALE_WARNING_THRESHOLD_SECONDS:-30}
      - SIGNAL_PROCESSING_DELAY_ALERT_THRESHOLD_SECONDS=${SIGNAL_PROCESSING_DELAY_ALERT_THRESHOLD_SECONDS:-300}
      - BALANCE_SYNC_ENABLED=${BALANCE_SYNC_ENABLED:-true}
      - BALANCE_SYNC_MIN_INTERVAL_SECONDS=${BALANCE_SYNC_MIN_INTERVAL_SECONDS:-30}
      - BALANCE_SYNC_TIMEOUT_SECONDS=${BALANCE_SYNC_TIMEOUT_SECONDS:-5.0}
    volumes:
      - model_storage:/models
      - model_datasets:/datasets
      - ./model-service/src:/app/src
      - ./model-service/tests:/app/tests
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      ws-gateway:
        condition: service_started
      feature-service:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  feature-service:
    build:
      context: ./feature-service
      dockerfile: Dockerfile
    container_name: feature-service
    ports:
      - "${FEATURE_SERVICE_PORT:-4900}:4900"
    deploy:
      resources:
        limits:
          cpus: '0.5'
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - FEATURE_SERVICE_PORT=${FEATURE_SERVICE_PORT:-4900}
      - FEATURE_SERVICE_API_KEY=${FEATURE_SERVICE_API_KEY}
      - FEATURE_SERVICE_LOG_LEVEL=${FEATURE_SERVICE_LOG_LEVEL:-INFO}
      - FEATURE_SERVICE_SERVICE_NAME=${FEATURE_SERVICE_SERVICE_NAME:-feature-service}
      - WS_GATEWAY_HOST=${WS_GATEWAY_HOST:-ws-gateway}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - RAW_DATA_STORAGE_PATH=${RAW_DATA_STORAGE_PATH:-/data/raw}
      - RAW_DATA_RETENTION_DAYS=${RAW_DATA_RETENTION_DAYS:-90}
      - DATASET_STORAGE_PATH=${DATASET_STORAGE_PATH:-/data/datasets}
      - FEATURE_REGISTRY_CONFIG_PATH=${FEATURE_REGISTRY_CONFIG_PATH:-/app/config/feature_registry.yaml}
      - FEATURE_COMPUTATION_INTERVALS=${FEATURE_COMPUTATION_INTERVALS:-1s,3s,15s,1m}
      - FEATURE_COMPUTATION_LATENCY_WARNING_MS=${FEATURE_COMPUTATION_LATENCY_WARNING_MS:-70}
      - DATA_QUALITY_MONITORING_ENABLED=${DATA_QUALITY_MONITORING_ENABLED:-true}
      - DATA_QUALITY_REPORT_TIMEOUT_SECONDS=${DATA_QUALITY_REPORT_TIMEOUT_SECONDS:-5}
      - FEATURE_SERVICE_SYMBOLS=${FEATURE_SERVICE_SYMBOLS:-}
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - FEATURE_SERVICE_BACKFILL_RATE_LIMIT_DELAY_MS=${FEATURE_SERVICE_BACKFILL_RATE_LIMIT_DELAY_MS:-100}
      - FEATURE_SERVICE_BACKFILL_ENABLED=${FEATURE_SERVICE_BACKFILL_ENABLED:-true}
      - FEATURE_SERVICE_BACKFILL_AUTO=${FEATURE_SERVICE_BACKFILL_AUTO:-true}
      - FEATURE_SERVICE_BACKFILL_MAX_DAYS=${FEATURE_SERVICE_BACKFILL_MAX_DAYS:-90}
      - FEATURE_SERVICE_BACKFILL_DEFAULT_INTERVAL=${FEATURE_SERVICE_BACKFILL_DEFAULT_INTERVAL:-1}
      - MODEL_CLASSIFICATION_THRESHOLD=${MODEL_CLASSIFICATION_THRESHOLD:-0.005}
      - DATASET_MAX_FEATURE_NAN_RATIO=${DATASET_MAX_FEATURE_NAN_RATIO:-0.5}
      - DATASET_MAX_ROW_NAN_RATIO=${DATASET_MAX_ROW_NAN_RATIO:-0.8}
      - DATASET_MIN_VALID_FEATURES_RATIO=${DATASET_MIN_VALID_FEATURES_RATIO:-0.3}
      - DATASET_FAIL_ON_HIGH_NAN_RATIO=${DATASET_FAIL_ON_HIGH_NAN_RATIO:-false}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-10}
      - REDIS_SOCKET_TIMEOUT=${REDIS_SOCKET_TIMEOUT:-5}
      - REDIS_SOCKET_CONNECT_TIMEOUT=${REDIS_SOCKET_CONNECT_TIMEOUT:-5}
      - CACHE_REDIS_ENABLED=${CACHE_REDIS_ENABLED:-true}
      - CACHE_TTL_HISTORICAL_DATA_SECONDS=${CACHE_TTL_HISTORICAL_DATA_SECONDS:-86400}
      - CACHE_TTL_FEATURES_SECONDS=${CACHE_TTL_FEATURES_SECONDS:-604800}
      - CACHE_MAX_SIZE_MB=${CACHE_MAX_SIZE_MB:-1024}
      - CACHE_MAX_ENTRIES=${CACHE_MAX_ENTRIES:-10000}
      - DATASET_BUILDER_CACHE_ENABLED=${DATASET_BUILDER_CACHE_ENABLED:-true}
      - DATASET_BUILDER_CACHE_HISTORICAL_DATA_ENABLED=${DATASET_BUILDER_CACHE_HISTORICAL_DATA_ENABLED:-true}
      - DATASET_BUILDER_CACHE_FEATURES_ENABLED=${DATASET_BUILDER_CACHE_FEATURES_ENABLED:-true}
      - CACHE_INVALIDATION_ON_REGISTRY_CHANGE=${CACHE_INVALIDATION_ON_REGISTRY_CHANGE:-true}
      - CACHE_INVALIDATION_ON_DATA_CHANGE=${CACHE_INVALIDATION_ON_DATA_CHANGE:-true}
      - DATASET_BUILDER_BATCH_SIZE=${DATASET_BUILDER_BATCH_SIZE:-1000}
    volumes:
      - ./feature-service/src:/app/src
      - ./feature-service/config:/app/config
      - ./feature-service/config/versions:/app/config/versions
      - ./feature-service/tests:/app/tests
      - ./feature-service/scripts:/app/scripts
      - feature_raw_data:/data/raw
      - feature_datasets:/data/datasets
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      ws-gateway:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4900/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "3"

  order-manager:
    build:
      context: ./order-manager
      dockerfile: Dockerfile
    container_name: order-manager
    ports:
      - "${ORDERMANAGER_PORT:-4600}:4600"
    environment:
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - ORDERMANAGER_PORT=${ORDERMANAGER_PORT:-4600}
      - ORDERMANAGER_API_KEY=${ORDERMANAGER_API_KEY}
      - ORDERMANAGER_LOG_LEVEL=${ORDERMANAGER_LOG_LEVEL:-INFO}
      - ORDERMANAGER_SERVICE_NAME=${ORDERMANAGER_SERVICE_NAME:-order-manager}
      - WS_GATEWAY_HOST=${WS_GATEWAY_HOST:-ws-gateway}
      - WS_GATEWAY_PORT=${WS_GATEWAY_PORT:-4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - POSITION_MANAGER_HOST=${POSITION_MANAGER_HOST:-position-manager}
      - POSITION_MANAGER_PORT=${POSITION_MANAGER_PORT:-4800}
      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
      - ORDERMANAGER_ENABLE_DRY_RUN=${ORDERMANAGER_ENABLE_DRY_RUN:-false}
      - ORDERMANAGER_MAX_SINGLE_ORDER_SIZE=${ORDERMANAGER_MAX_SINGLE_ORDER_SIZE:-500.0}
      - ORDERMANAGER_ENABLE_ORDER_SPLITTING=${ORDERMANAGER_ENABLE_ORDER_SPLITTING:-false}
      - ORDERMANAGER_ORDER_EXECUTION_TIMEOUT=${ORDERMANAGER_ORDER_EXECUTION_TIMEOUT:-30}
      - ORDERMANAGER_MAX_POSITION_SIZE=${ORDERMANAGER_MAX_POSITION_SIZE:-2.0}
      - ORDERMANAGER_MAX_EXPOSURE=${ORDERMANAGER_MAX_EXPOSURE:-10000.0}
      - ORDERMANAGER_MAX_ORDER_SIZE_RATIO=${ORDERMANAGER_MAX_ORDER_SIZE_RATIO:-0.1}
      - ORDERMANAGER_BYBIT_API_RETRY_MAX_ATTEMPTS=${ORDERMANAGER_BYBIT_API_RETRY_MAX_ATTEMPTS:-3}
      - ORDERMANAGER_BYBIT_API_RETRY_BASE_DELAY=${ORDERMANAGER_BYBIT_API_RETRY_BASE_DELAY:-1.0}
      - ORDERMANAGER_BYBIT_API_RETRY_MAX_DELAY=${ORDERMANAGER_BYBIT_API_RETRY_MAX_DELAY:-30.0}
      - ORDERMANAGER_BYBIT_API_RETRY_MULTIPLIER=${ORDERMANAGER_BYBIT_API_RETRY_MULTIPLIER:-2.0}
      - ORDERMANAGER_MARKET_ORDER_CONFIDENCE_THRESHOLD=${ORDERMANAGER_MARKET_ORDER_CONFIDENCE_THRESHOLD:-0.9}
      - ORDERMANAGER_MARKET_ORDER_SPREAD_THRESHOLD=${ORDERMANAGER_MARKET_ORDER_SPREAD_THRESHOLD:-0.1}
      - ORDERMANAGER_LIMIT_ORDER_PRICE_OFFSET_RATIO=${ORDERMANAGER_LIMIT_ORDER_PRICE_OFFSET_RATIO:-0.5}
      - ORDERMANAGER_POSITION_SNAPSHOT_INTERVAL=${ORDERMANAGER_POSITION_SNAPSHOT_INTERVAL:-300}
      - ORDERMANAGER_POSITION_VALIDATION_INTERVAL=${ORDERMANAGER_POSITION_VALIDATION_INTERVAL:-3600}
      - ORDERMANAGER_PENDING_ORDER_TIMEOUT_MINUTES=${ORDERMANAGER_PENDING_ORDER_TIMEOUT_MINUTES:-5}
      - ORDERMANAGER_PENDING_ORDER_CHECK_INTERVAL=${ORDERMANAGER_PENDING_ORDER_CHECK_INTERVAL:-60}
      - ORDERMANAGER_CANCEL_OPPOSITE_ORDERS_ONLY=${ORDERMANAGER_CANCEL_OPPOSITE_ORDERS_ONLY:-false}
      - ORDERMANAGER_CANCEL_STALE_ORDER_TIMEOUT=${ORDERMANAGER_CANCEL_STALE_ORDER_TIMEOUT:-3600}
      - ORDERMANAGER_UNREALIZED_LOSS_WARNING_THRESHOLD=${ORDERMANAGER_UNREALIZED_LOSS_WARNING_THRESHOLD:-10.0}
      - ORDERMANAGER_ENABLE_BALANCE_CHECK=${ORDERMANAGER_ENABLE_BALANCE_CHECK:-true}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - ./order-manager/src:/app/src
      - ./order-manager/scripts:/app/scripts
      - ./order-manager/tests:/app/tests
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      ws-gateway:
        condition: service_started
      position-manager:
        condition: service_started
    networks:
      - ytrader-network
    restart: unless-stopped

  position-manager:
    build:
      context: ./position-manager
      dockerfile: Dockerfile
    container_name: position-manager
    ports:
      - "${POSITION_MANAGER_PORT:-4800}:4800"
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - POSITION_MANAGER_PORT=${POSITION_MANAGER_PORT:-4800}
      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
      - POSITION_MANAGER_LOG_LEVEL=${POSITION_MANAGER_LOG_LEVEL:-INFO}
      - POSITION_MANAGER_SERVICE_NAME=${POSITION_MANAGER_SERVICE_NAME:-position-manager}
      - POSITION_MANAGER_SNAPSHOT_INTERVAL=${POSITION_MANAGER_SNAPSHOT_INTERVAL:-3600}
      - POSITION_MANAGER_SNAPSHOT_RETENTION_DAYS=${POSITION_MANAGER_SNAPSHOT_RETENTION_DAYS:-365}
      - POSITION_MANAGER_VALIDATION_INTERVAL=${POSITION_MANAGER_VALIDATION_INTERVAL:-1800}
      - POSITION_MANAGER_METRICS_CACHE_TTL=${POSITION_MANAGER_METRICS_CACHE_TTL:-10}
      - POSITION_MANAGER_USE_WS_AVG_PRICE=${POSITION_MANAGER_USE_WS_AVG_PRICE:-true}
      - POSITION_MANAGER_AVG_PRICE_DIFF_THRESHOLD=${POSITION_MANAGER_AVG_PRICE_DIFF_THRESHOLD:-0.001}
      - POSITION_MANAGER_SIZE_VALIDATION_THRESHOLD=${POSITION_MANAGER_SIZE_VALIDATION_THRESHOLD:-0.0001}
      - POSITION_MANAGER_PRICE_STALENESS_THRESHOLD=${POSITION_MANAGER_PRICE_STALENESS_THRESHOLD:-300}
      - POSITION_MANAGER_PRICE_API_TIMEOUT=${POSITION_MANAGER_PRICE_API_TIMEOUT:-5}
      - POSITION_MANAGER_PRICE_API_RETRIES=${POSITION_MANAGER_PRICE_API_RETRIES:-3}
      - POSITION_MANAGER_OPTIMISTIC_LOCK_RETRIES=${POSITION_MANAGER_OPTIMISTIC_LOCK_RETRIES:-3}
      - POSITION_MANAGER_OPTIMISTIC_LOCK_BACKOFF_BASE=${POSITION_MANAGER_OPTIMISTIC_LOCK_BACKOFF_BASE:-100}
      - POSITION_MANAGER_RATE_LIMIT_ENABLED=${POSITION_MANAGER_RATE_LIMIT_ENABLED:-true}
      - POSITION_MANAGER_RATE_LIMIT_DEFAULT=${POSITION_MANAGER_RATE_LIMIT_DEFAULT:-100}
      - POSITION_MANAGER_RATE_LIMIT_OVERRIDES=${POSITION_MANAGER_RATE_LIMIT_OVERRIDES:-}
      - WS_GATEWAY_URL=${WS_GATEWAY_URL:-http://ws-gateway:4400}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
    volumes:
      - ./position-manager/src:/app/src
      - ./position-manager/tests:/app/tests
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4800/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  grafana:
    build:
      context: ./grafana
      dockerfile: Dockerfile
    container_name: grafana
    ports:
      - "${GRAFANA_PORT:-4700}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_INSTALL_PLUGINS=yesoreyeram-infinity-datasource
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - GRAFANA_POSTGRES_USER=${GRAFANA_POSTGRES_USER:-grafana_monitor}
      - GRAFANA_POSTGRES_PASSWORD=${GRAFANA_POSTGRES_PASSWORD}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
      - MODEL_SERVICE_API_KEY=${MODEL_SERVICE_API_KEY}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - postgres
      - rabbitmq
    networks:
      - ytrader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  test-grafana:
    build:
      context: ./tests
      dockerfile: Dockerfile
    container_name: test-grafana
    environment:
      - DOCKER_ENV=true
      - GRAFANA_HOST=grafana
      - GRAFANA_PORT=3000
      - GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-ytrader}
      - POSTGRES_USER=${POSTGRES_USER:-ytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BYBIT_ENVIRONMENT=${BYBIT_ENVIRONMENT:-testnet}
      - ORDERMANAGER_ENABLE_DRY_RUN=${ORDERMANAGER_ENABLE_DRY_RUN:-true}
      - ORDERMANAGER_API_KEY=${ORDERMANAGER_API_KEY}
      - POSITION_MANAGER_API_KEY=${POSITION_MANAGER_API_KEY}
      - WS_GATEWAY_API_KEY=${WS_GATEWAY_API_KEY}
      - MODEL_SERVICE_HOST=${MODEL_SERVICE_HOST:-model-service}
      - MODEL_SERVICE_PORT=${MODEL_SERVICE_PORT:-4500}
      - MODEL_SERVICE_API_KEY=${MODEL_SERVICE_API_KEY}
    volumes:
      - ./tests:/app/tests
      - ./order-manager:/app/order-manager
      - ./position-manager:/app/position-manager
    depends_on:
      grafana:
        condition: service_started
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      ws-gateway:
        condition: service_started
      model-service:
        condition: service_started
      order-manager:
        condition: service_started
      position-manager:
        condition: service_started
    networks:
      - ytrader-network
    profiles:
      - test
    command: ["pytest", "tests/integration", "-v", "-m", "integration"]

networks:
  ytrader-network:
    driver: bridge

volumes:
  postgres_data:
  rabbitmq_data:
  model_storage:
  model_datasets:
  grafana_data:
  redis_data:
  feature_raw_data:
  feature_datasets:

