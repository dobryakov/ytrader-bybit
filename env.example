# =============================================================================
# Bybit API Configuration
# =============================================================================
# Bybit API credentials for WebSocket authentication
# Use testnet for development, mainnet for production
BYBIT_API_KEY=XXXX
BYBIT_API_SECRET=XXXX
BYBIT_ENVIRONMENT=testnet  # or 'mainnet' for production

# =============================================================================
# Database Configuration (PostgreSQL)
# =============================================================================
# Shared PostgreSQL database for all microservices
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_DB=XXXX
POSTGRES_USER=XXXX
POSTGRES_PASSWORD=XXXX

# =============================================================================
# RabbitMQ Configuration
# =============================================================================
# Message broker for event-driven communication
RABBITMQ_HOST=rabbitmq
RABBITMQ_PORT=5672
RABBITMQ_USER=XXXX
RABBITMQ_PASSWORD=XXXX

# =============================================================================
# Redis Configuration
# =============================================================================
# Redis for distributed locking (used by order-manager)
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=

# =============================================================================
# WebSocket Gateway Service Configuration
# =============================================================================
# REST API port (non-standard port starting from 4400)
WS_GATEWAY_PORT=4400

# WebSocket Gateway hostname (for model-service to subscribe to channels)
WS_GATEWAY_HOST=ws-gateway

# API key for REST API authentication
# Other microservices use this key to manage subscriptions
WS_GATEWAY_API_KEY=XXXX

# Logging level: DEBUG, INFO, WARNING, ERROR, CRITICAL
WS_GATEWAY_LOG_LEVEL=INFO

# Service identifier
WS_GATEWAY_SERVICE_NAME=ws-gateway

# WebSocket connection strategy: 'dual' (separate public/private connections) or 'single' (one private connection for all)
# Default: 'dual' - recommended for better scalability and separation of concerns
# 'single' mode uses only private endpoint for backward compatibility
BYBIT_WS_STRATEGY=dual  # or 'single'

# Bybit public WebSocket category: 'spot', 'linear', 'inverse', 'option', 'spread'
# Default: 'linear' for unified trading (USDT/USDC perpetual & futures)
# Use 'spot' for spot trading, 'linear' for unified trading
BYBIT_WS_PUBLIC_CATEGORY=linear  # or 'spot', 'inverse', 'option', 'spread'

# =============================================================================
# Model Service Configuration
# =============================================================================
# REST API port (non-standard port starting from 4500)
MODEL_SERVICE_PORT=4500

# API key for REST API authentication
# Other microservices use this key to authenticate with Model Service
MODEL_SERVICE_API_KEY=XXXX

# Logging level: DEBUG, INFO, WARNING, ERROR, CRITICAL
MODEL_SERVICE_LOG_LEVEL=INFO

# Service identifier
MODEL_SERVICE_SERVICE_NAME=model-service

# =============================================================================
# Model Storage Configuration
# =============================================================================
# Directory for model files (mounted as Docker volume)
MODEL_STORAGE_PATH=/models

# =============================================================================
# Model Training Configuration
# =============================================================================
# Minimum number of records required to start model training
MODEL_TRAINING_MIN_DATASET_SIZE=1000

# Maximum duration for model training in seconds (30 minutes default)
MODEL_TRAINING_MAX_DURATION_SECONDS=1800

# Minimum accuracy threshold for model activation (0.0 to 1.0)
MODEL_QUALITY_THRESHOLD_ACCURACY=0.75

# Scheduled retraining schedule (cron format, optional)
# Example: "0 2 * * *" for daily at 2 AM
MODEL_RETRAINING_SCHEDULE=

# Enable persistent buffer for training orchestrator so that unused execution
# events can be recovered from database after service restart.
BUFFER_PERSISTENCE_ENABLED=true

# Enable automatic buffer recovery on startup. When enabled, the service will
# load execution events that have not yet been used for training into the
# in-memory buffer on startup.
BUFFER_RECOVERY_ON_STARTUP=true

# Maximum number of execution events to recover on startup.
BUFFER_MAX_RECOVERY_EVENTS=10000

# Enable training queue to avoid cancelling in-progress training when new data
# arrives. New training requests are queued and processed sequentially.
TRAINING_QUEUE_ENABLED=true

# Maximum size of the training queue (number of pending training requests).
TRAINING_QUEUE_MAX_SIZE=10

# Allow CRITICAL priority retraining (e.g., severe quality degradation) to
# cancel the current training when enabled. Default is false.
TRAINING_FORCE_CANCEL_ON_CRITICAL=false

# Maximum number of parallel training tasks allowed (per service instance).
# Current implementation runs trainings sequentially but this value is reserved
# for future parallelization support.
MAX_PARALLEL_TRAINING=1

# Interval in seconds for batch buffer update operations in the training
# orchestrator. Used to reduce write frequency when persisting buffer state.
BATCH_BUFFER_UPDATE_INTERVAL_SECONDS=10

# =============================================================================
# Signal Generation Configuration
# =============================================================================
# Rate limit for signal generation (signals per minute)
SIGNAL_GENERATION_RATE_LIMIT=60

# Burst allowance for rate limiting (additional signals allowed in burst)
SIGNAL_GENERATION_BURST_ALLOWANCE=10

# Skip signal generation if open order exists for same asset and strategy
# Set to 'true' to prevent duplicate orders, 'false' to allow multiple signals
SIGNAL_GENERATION_SKIP_IF_OPEN_ORDER=true

# Check only opposite direction orders when skipping (e.g., skip buy signal if sell order exists)
# Set to 'true' to check only opposite direction orders, 'false' to check all orders
# Only used when SIGNAL_GENERATION_SKIP_IF_OPEN_ORDER=true
SIGNAL_GENERATION_CHECK_OPPOSITE_ORDERS_ONLY=false

# Enable warm-up mode when no trained model exists
WARMUP_MODE_ENABLED=true

# Warm-up signal generation frequency (signals per minute)
WARMUP_SIGNAL_FREQUENCY=1

# Minimum order amount for warm-up signals (in quote currency)
WARMUP_MIN_AMOUNT=100.0

# =============================================================================
# Exit Strategy Configuration
# =============================================================================
# Enable position-based exit strategy evaluation
EXIT_STRATEGY_ENABLED=true

# Rate limit for exit signal generation (signals per asset per minute)
EXIT_STRATEGY_RATE_LIMIT=10

# Take Profit Configuration
TAKE_PROFIT_ENABLED=true
TAKE_PROFIT_THRESHOLD_PCT=3.0
TAKE_PROFIT_PARTIAL_EXIT=false
TAKE_PROFIT_PARTIAL_AMOUNT_PCT=50.0

# Stop Loss Configuration
STOP_LOSS_ENABLED=true
STOP_LOSS_THRESHOLD_PCT=-2.0

# Trailing Stop Configuration
TRAILING_STOP_ENABLED=false
TRAILING_STOP_ACTIVATION_PCT=2.0
TRAILING_STOP_DISTANCE_PCT=1.0

# Time-Based Exit Configuration
TIME_BASED_EXIT_ENABLED=false
TIME_BASED_EXIT_MAX_HOURS=24
TIME_BASED_EXIT_PROFIT_TARGET_PCT=1.0

# Maximum order amount for warm-up signals (in quote currency)
WARMUP_MAX_AMOUNT=1000.0

# Randomness level for warm-up signals (0.0 = deterministic, 1.0 = fully random)
WARMUP_RANDOMNESS_LEVEL=0.5

# =============================================================================
# Trading Strategy Configuration
# =============================================================================
# Comma-separated list of trading strategy identifiers
# Example: momentum_v1,mean_reversion_v1
TRADING_STRATEGIES=

# =============================================================================
# Order Manager Service Configuration
# =============================================================================
# REST API port (non-standard port starting from 4600)
ORDERMANAGER_PORT=4600

# API key for REST API authentication
# Other microservices use this key to authenticate with Order Manager
ORDERMANAGER_API_KEY=XXXX

# Logging level: DEBUG, INFO, WARNING, ERROR, CRITICAL
ORDERMANAGER_LOG_LEVEL=INFO

# Service identifier
ORDERMANAGER_SERVICE_NAME=order-manager

# =============================================================================
# Order Execution Configuration
# =============================================================================
# Enable dry-run mode (process signals but do not send orders to Bybit)
# Set to 'true' for testing without real orders
ORDERMANAGER_ENABLE_DRY_RUN=false

# Maximum order size for single order (in USDT)
# Orders exceeding this size may be split if order splitting is enabled
# NOTE: This parameter is defined but NOT currently used in code checks.
# Real validation uses: MAX_EXPOSURE × MAX_ORDER_SIZE_RATIO
# Keeping it for future use or documentation purposes
ORDERMANAGER_MAX_SINGLE_ORDER_SIZE=500.0

# Enable order splitting for large amounts
# When enabled, large orders are split into multiple smaller orders
ORDERMANAGER_ENABLE_ORDER_SPLITTING=false

# Timeout for order creation API calls (in seconds)
ORDERMANAGER_ORDER_EXECUTION_TIMEOUT=30

# =============================================================================
# Risk Limits Configuration
# =============================================================================
# Maximum position size per asset (in base currency)
# Note: Should accommodate existing positions (e.g., 1.19 ETH), so set to 2.0 to allow reasonable position sizes
ORDERMANAGER_MAX_POSITION_SIZE=2.0

# Maximum total exposure across all positions (in USDT)
# Used in combination with MAX_ORDER_SIZE_RATIO to calculate max order size
# Max order size = MAX_EXPOSURE × MAX_ORDER_SIZE_RATIO = 10000 × 0.1 = 1000 USDT
ORDERMANAGER_MAX_EXPOSURE=10000.0

# Maximum order size as ratio of maximum exposure (0.0 to 1.0)
# Example: 0.1 means maximum 10% of MAX_EXPOSURE per order
# Max order size = 10000 × 0.1 = 1000 USDT (to limit orders to $1000 equivalent)
ORDERMANAGER_MAX_ORDER_SIZE_RATIO=0.1

# =============================================================================
# Bybit API Retry Configuration
# =============================================================================
# Maximum retry attempts for Bybit API calls
ORDERMANAGER_BYBIT_API_RETRY_MAX_ATTEMPTS=3

# Base delay for exponential backoff (in seconds)
ORDERMANAGER_BYBIT_API_RETRY_BASE_DELAY=1.0

# Maximum delay between retries (in seconds)
ORDERMANAGER_BYBIT_API_RETRY_MAX_DELAY=30.0

# Exponential backoff multiplier
ORDERMANAGER_BYBIT_API_RETRY_MULTIPLIER=2.0

# =============================================================================
# Order Type Selection Configuration
# =============================================================================
# Confidence threshold for market orders (0.0 to 1.0)
# Signals with confidence above this threshold may use market orders
ORDERMANAGER_MARKET_ORDER_CONFIDENCE_THRESHOLD=0.9

# Spread threshold for market orders (as percentage)
# Market orders may be used when spread is below this threshold
ORDERMANAGER_MARKET_ORDER_SPREAD_THRESHOLD=0.1

# Price offset ratio for limit orders (0.0 to 1.0)
# Used to calculate limit price offset from market price
ORDERMANAGER_LIMIT_ORDER_PRICE_OFFSET_RATIO=0.5

# =============================================================================
# Position Management Configuration
# =============================================================================
# Interval for position snapshots (in seconds)
# Position state is periodically snapshotted for historical tracking
ORDERMANAGER_POSITION_SNAPSHOT_INTERVAL=300

# Interval for position validation (in seconds)
# Position state is validated against computed position from order history
ORDERMANAGER_POSITION_VALIDATION_INTERVAL=3600

# =============================================================================
# Order Cancellation Configuration
# =============================================================================
# If true, only cancel orders with opposite direction (buy vs sell)
# If false, cancel all pending orders for same asset when new signal arrives
ORDERMANAGER_CANCEL_OPPOSITE_ORDERS_ONLY=false

# Automatically cancel orders older than this timeout (in seconds)
# Set to 0 to disable automatic cancellation of stale orders
ORDERMANAGER_CANCEL_STALE_ORDER_TIMEOUT=3600

# =============================================================================
# Risk Management Configuration
# =============================================================================
# Unrealized loss warning threshold (as percentage)
# Warning is logged when position unrealized loss exceeds this threshold
ORDERMANAGER_UNREALIZED_LOSS_WARNING_THRESHOLD=10.0

# Enable balance check before order creation (default: true)
# If false, balance validation is skipped - Bybit API will reject orders with insufficient balance anyway.
# Setting to false reduces API calls and improves performance, but loses early rejection and detailed logging.
ORDERMANAGER_ENABLE_BALANCE_CHECK=true

# Enable automatic order size reduction when insufficient balance error (110007) occurs (default: true)
# If true, system will try to reduce order size based on available balance and retry order creation.
# If false, orders will be immediately rejected when 110007 error occurs.
ORDERMANAGER_ENABLE_ORDER_SIZE_REDUCTION=true

# =============================================================================
# Position Manager Service Configuration
# =============================================================================
# REST API port (non-standard port starting from 4800)
POSITION_MANAGER_PORT=4800

# API key for REST API authentication
# Other microservices use this key to authenticate with Position Manager
POSITION_MANAGER_API_KEY=XXXX

# Logging level: DEBUG, INFO, WARNING, ERROR, CRITICAL
POSITION_MANAGER_LOG_LEVEL=INFO

# Service identifier
POSITION_MANAGER_SERVICE_NAME=position-manager

# =============================================================================
# Position Management Configuration
# =============================================================================
# Interval for position snapshots (in seconds)
# Position state is periodically snapshotted for historical tracking
POSITION_MANAGER_SNAPSHOT_INTERVAL=3600  # 1 hour

# Retention period for position snapshots (in days)
# Snapshots older than this period are automatically deleted
POSITION_MANAGER_SNAPSHOT_RETENTION_DAYS=365

# Interval for position validation (in seconds)
# Position state is validated against authoritative sources
POSITION_MANAGER_VALIDATION_INTERVAL=1800  # 30 minutes

# Portfolio metrics cache TTL (in seconds)
# Metrics are cached in memory and invalidated on position updates
POSITION_MANAGER_METRICS_CACHE_TTL=10

# =============================================================================
# Position Update Strategy Configuration
# =============================================================================
# Use WebSocket average price for position updates
# If true, WebSocket avgPrice is used when difference exceeds threshold
POSITION_MANAGER_USE_WS_AVG_PRICE=true

# Average price difference threshold (as ratio, e.g., 0.001 = 0.1%)
# WebSocket avgPrice is used if difference from existing value exceeds this threshold
POSITION_MANAGER_AVG_PRICE_DIFF_THRESHOLD=0.001  # 0.1%

# Position size validation threshold (as ratio)
# Size discrepancies exceeding this threshold trigger validation
POSITION_MANAGER_SIZE_VALIDATION_THRESHOLD=0.0001

# Price staleness threshold (in seconds)
# External API is queried if price is older than this threshold
POSITION_MANAGER_PRICE_STALENESS_THRESHOLD=300  # 5 minutes

# External price API timeout (in seconds)
POSITION_MANAGER_PRICE_API_TIMEOUT=5

# External price API retry attempts
POSITION_MANAGER_PRICE_API_RETRIES=3

# Optimistic locking retry attempts
# Number of retries when version conflict occurs during position update
POSITION_MANAGER_OPTIMISTIC_LOCK_RETRIES=3

# Optimistic locking backoff base delay (in milliseconds)
# Exponential backoff starts from this value (100ms, 200ms, 400ms)
POSITION_MANAGER_OPTIMISTIC_LOCK_BACKOFF_BASE=100

# =============================================================================
# Rate Limiting Configuration
# =============================================================================
# Enable rate limiting for API endpoints
POSITION_MANAGER_RATE_LIMIT_ENABLED=true

# Default rate limit (requests per minute)
# Applied to all API keys unless overridden
POSITION_MANAGER_RATE_LIMIT_DEFAULT=100

# Rate limit overrides per API key (comma-separated key:limit pairs)
# Example: model-service-key:100,risk-manager-key:200,ui-key:1000
POSITION_MANAGER_RATE_LIMIT_OVERRIDES=model-service-key:100,risk-manager-key:200,ui-key:1000

# =============================================================================
# Grafana Monitoring Service Configuration
# =============================================================================
# Grafana UI port (non-standard port starting from 4700)
GRAFANA_PORT=4700

# Grafana admin user credentials
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=XXXX

# Grafana PostgreSQL read-only user credentials
# This user is created by migration and has SELECT permissions on monitoring tables
GRAFANA_POSTGRES_USER=grafana_monitor
GRAFANA_POSTGRES_PASSWORD=XXXX
