# Model Service - Trading Decision and ML Training Microservice

A microservice that trains ML models from order execution feedback, generates trading signals using trained models or warm-up heuristics, and manages model versioning.

## Features

- **Warm-up Mode**: Generate trading signals using simple heuristics when no trained model exists
- **Model Training**: Train ML models from order execution feedback using scikit-learn and XGBoost
- **Signal Generation**: Generate intelligent trading signals using trained models
- **Model Versioning**: Track model versions, quality metrics, and manage model lifecycle
- **Real-time Processing**: Async message queue processing with RabbitMQ
- **Observability**: Structured logging with trace IDs for request flow tracking

## Technology Stack

- **Language**: Python 3.11+
- **ML Frameworks**: scikit-learn>=1.3.0, xgboost>=2.0.0
- **Data Processing**: pandas>=2.0.0
- **Message Queue**: aio-pika>=9.0.0 (RabbitMQ)
- **Database**: asyncpg>=0.29.0 (PostgreSQL)
- **Web Framework**: FastAPI>=0.104.0
- **Configuration**: pydantic-settings>=2.0.0
- **Logging**: structlog>=23.2.0

## Project Structure

```
model-service/
├── src/
│   ├── models/              # ML model definitions and training logic
│   ├── services/            # Core business logic (signal generation, training orchestration)
│   ├── api/                 # REST API endpoints (health checks, monitoring)
│   ├── consumers/           # RabbitMQ message consumers (order execution events)
│   ├── publishers/          # RabbitMQ message publishers (trading signals)
│   ├── database/            # Database access layer (model metadata, quality metrics)
│   ├── config/              # Configuration management
│   └── main.py              # Application entry point
├── tests/
│   ├── unit/                # Unit tests for models, services, utilities
│   ├── integration/         # Integration tests for database, message queue
│   └── e2e/                 # End-to-end tests for full workflows
├── models/                  # Model file storage directory (mounted volume)
├── Dockerfile
├── requirements.txt
└── README.md
```

## Setup

### Prerequisites

- Docker and Docker Compose V2
- Python 3.11+ (for local development)
- PostgreSQL 15+ (via Docker)
- RabbitMQ 3+ (via Docker)

### Environment Variables

Copy `env.example` to `.env` and configure the following variables:

```bash
# Model Service Configuration
MODEL_SERVICE_PORT=4500
MODEL_SERVICE_API_KEY=your-api-key-here
MODEL_SERVICE_LOG_LEVEL=INFO
MODEL_SERVICE_SERVICE_NAME=model-service

# Model Storage
MODEL_STORAGE_PATH=/models

# Model Training Configuration
MODEL_TRAINING_MIN_DATASET_SIZE=1000
MODEL_TRAINING_MAX_DURATION_SECONDS=1800
MODEL_QUALITY_THRESHOLD_ACCURACY=0.75
MODEL_RETRAINING_SCHEDULE=

# Signal Generation Configuration
SIGNAL_GENERATION_RATE_LIMIT=60
SIGNAL_GENERATION_BURST_ALLOWANCE=10

# Warm-up Mode Configuration
WARMUP_MODE_ENABLED=true
WARMUP_SIGNAL_FREQUENCY=60

# Trading Strategy Configuration
TRADING_STRATEGIES=
```

See `env.example` for complete configuration options.

### Docker Setup

1. Build and start the service:

```bash
docker compose build model-service
docker compose up -d model-service
```

2. Check service health:

```bash
curl http://localhost:4500/health
```

3. View logs:

```bash
docker compose logs -f model-service
```

### Local Development Setup

1. Create a virtual environment:

```bash
python3.11 -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
```

2. Install dependencies:

```bash
pip install -r requirements.txt
```

3. Install development tools:

```bash
pip install black flake8 mypy
```

4. Run linting:

```bash
black src/ tests/
flake8 src/ tests/
mypy src/
```

5. Run tests:

```bash
pytest
```

6. Run the service locally:

```bash
uvicorn src.main:app --host 0.0.0.0 --port 4500 --reload
```

## API Endpoints

### Health Check

```bash
GET /health
```

Returns service health status including database, message queue, and model storage checks.

## Message Queues

### Consumed Queues

- `order-manager.execution_events`: Order execution events for model training

### Published Queues

- `model-service.trading_signals`: Trading signals generated by the service

## Database

The service uses a shared PostgreSQL database for model metadata and quality metrics. Model files are stored on the file system in `/models/v{version}/` directory structure.

## Development

### Code Style

- **Formatter**: Black (line length: 100)
- **Linter**: Flake8 (max line length: 100)
- **Type Checking**: mypy (Python 3.11)

### Running Tests

```bash
# All tests
pytest

# Unit tests only
pytest tests/unit/

# Integration tests only
pytest tests/integration/

# End-to-end tests only
pytest tests/e2e/
```

## License

See repository root for license information.

